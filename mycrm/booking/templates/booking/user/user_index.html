<!DOCTYPE html>
{% load static %}
{% load custom_filters %}
<html lang="ru">

<head>
    <title>CRM</title>
    <link rel="stylesheet" href="{% static 'css/repa.css' %}?v={% now 'U' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.0/dist/sweetalert2.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.0/dist/sweetalert2.min.js"></script>

</head>

<body>
    <div id="app-modal-backdrop"></div>

    <script>
        window.ROOMS = JSON.parse('{{ rooms_json|escapejs }}');
        window.TIME_BLOCKS = JSON.parse('{{ time_blocks_json|escapejs }}');
        window.SCENARIOS = JSON.parse('{{ scenarios_json|escapejs }}');
        window.SPECIALISTS = JSON.parse('{{ specialists_json|escapejs }}');
        window.PAYMENT_TYPES = JSON.parse('{{ payment_types_json|escapejs }}');

        // Диапазон дат, для которого сейчас отрисован календарь
        window.SHOW_DATE_FROM = '{{ show_datefrom }}';
        window.SHOW_DATE_TO = '{{ show_dateto }}';
    </script>

    <p id="bookings_in_range" style="display: none;">{{ bookings_in_range }}</p>

    <div class="container-fluid">
        {% include 'booking/add/head.html' %}
        {% include 'booking/add/menu.html' %}
        <div class="row mt-4 mb-2" style="border-bottom: 1px solid #EBEBEC; 
    position: sticky;
    top: 41px;
    z-index: 900;
    background-color: #fff;">
            <div class="row mt-5 mb-2">
                <div class="col-md-12 d-flex justify-content-between align-items-center">
                    <h1 class="mb-0">Брони</h1>
                    <div class="d-flex gap-2">
                        <button type="button" class="button-secondary">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 12H19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 5V19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span>Добавить клиента</span>
                        </button>
                        <button type="button" class="button-secondary">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 12H19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 5V19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span>Добавить абонемент</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row mb-2" id="booking-filters">
                <div class="col-md-3">
                    <div class="custom-select-wrapper">
                        <div class="custom-select" data-placeholder="Выберите помещение" data-filter-type="area">
                            <span class="selected">Выберите помещение</span>
                            <span class="chevron">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                </svg>
                            </span>
                            <ul class="options">
                                {% for area in areas %}
                                <li data-value="{{ area.id }}">{{ area.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="custom-select-wrapper">
                        <div class="custom-select" data-placeholder="Выберите сценарий" data-filter-type="scenario">
                            <span class="selected">Выберите сценарий</span>
                            <span class="chevron">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                </svg>
                            </span>
                            <ul class="options">
                                {% for scenario in scenarios %}
                                <li data-value="{{ scenario.id }}">{{ scenario.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 offset-md-3">
                    <div class="calendar-period">
                        <span>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path
                                    d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z"
                                    stroke="#7A52FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M3 10H21" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M8 14H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 14H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 14H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M8 18H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 18H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 18H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </span>
                        <span id="start-calendar-period-text">
                            18 сентября
                        </span>
                        <span style="color: #818EA2;"> — </span>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M16 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path
                                d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z"
                                stroke="#7A52FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M3 10H21" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M8 14H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M12 14H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M16 14H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M8 18H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M12 18H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M16 18H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        <span id="end-calendar-period-text">
                            24 сентября
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div style="height: 30px;"></div>
        <div class="container-fluid">
            {% for day in days_of_month %}
            <div class="row">
                <div class="col-md-2" id="day-header" style="white-space: nowrap;">
                    <h3>{{ day.date|date:"d E" }} / {{ day.date|date:"l"|lower }}</h3>
                </div>
                <div class="col-md-2" id="hide-specialists" style="white-space: nowrap;">
                    <span>Скрыть специалистов</span>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 15L12 9L6 15" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </div>
            </div>
            <!-- Блок занятости администраторов и преподавателей -->
            <div class="row mt-4 align-items-start" ;>
                <h6 class="d-flex align-items-center gap-3 w-100">
                    Администраторы
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 15L12 9L6 15" stroke="#818EA2" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </h6>

                <div class="d-flex">
                    <div class="me-3 d-flex" style="width: 96px; justify-content: flex-end;">
                        <img src="{% static 'image/image.png' %}" alt="Описание картинки" width="32" height="32">
                    </div>
                    <div class="d-flex flex-column justify-content-between specialist-time mb-3" style="flex:1;">
                        <span class="fw-semibold" style="font-size: 14px;">Алия Петрова</span>
                        <div class="d-flex w-100 specialist-time">
                            {% for i in time_cells %}
                            <div class="time-cell flex-fill"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="d-flex">
                    <div class="me-3 d-flex" style="width: 96px; justify-content: flex-end;">
                        <img src="{% static 'image/image2.png' %}" alt="Описание картинки" width="32" height="32">
                    </div>
                    <div class="d-flex flex-column justify-content-between specialist-time mb-3" style="flex:1;">
                        <span class="fw-semibold" style="font-size: 14px;">Каныш Сидоренко</span>
                        <div class="d-flex w-100 specialist-time">
                            {% for i in time_cells %}
                            <div class="time-cell flex-fill"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="d-flex">
                    <div class="me-3 d-flex" style="width: 96px; justify-content: flex-end;">
                        <img src="{% static 'image/default.png' %}" alt="Описание картинки" width="32" height="32">
                    </div>
                    <div class="d-flex flex-column justify-content-between specialist-time mb-3" style="flex:1;">
                        <span class="fw-semibold" style="font-size: 14px;">Мукатай Смирнов</span>
                        <div class="d-flex w-100 specialist-time">
                            {% for i in time_cells %}
                            <div class="time-cell flex-fill"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-2 align-items-start" ;>
                <h6 class="d-flex align-items-center gap-3 w-100">
                    Преподаватели
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 15L12 9L6 15" stroke="#818EA2" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </h6>

                <div class="d-flex">
                    <div class="me-3 d-flex" style="width: 96px; justify-content: flex-end;">
                        <img src="{% static 'image/image3.png' %}" alt="Описание картинки" width="32" height="32">
                    </div>
                    <div class="d-flex flex-column justify-content-between specialist-time mb-3" style="flex:1;">
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-semibold" style="font-size: 14px;">Ангелина Власова</span>
                            <span>•</span>
                            <span>Вокал / Фортепиано</span>
                        </div>
                        <div class="d-flex w-100 specialist-time">
                            {% for i in time_cells %}
                            <div class="time-cell flex-fill"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="d-flex">
                    <div class="me-3 d-flex" style="width: 96px; justify-content: flex-end;">
                        <img src="{% static 'image/image4.png' %}" alt="Описание картинки" width="32" height="32">
                    </div>
                    <div class="d-flex flex-column justify-content-between specialist-time mb-3" style="flex:1;">
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-semibold" style="font-size: 14px;">Сергей Золотарёв</span>
                            <span>•</span>
                            <span>Вокал / Гитара</span>
                        </div>
                        <div class="d-flex w-100 specialist-time">
                            {% for i in time_cells %}
                            <div class="time-cell flex-fill"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="d-flex">
                    <div class="me-3 d-flex" style="width: 96px; justify-content: flex-end;">
                        <img src="{% static 'image/image5.png' %}" alt="Описание картинки" width="32" height="32">
                    </div>
                    <div class="d-flex flex-column justify-content-between specialist-time mb-3" style="flex:1;">
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-semibold" style="font-size: 14px;">Виолетта Бочарова</span>
                            <span>•</span>
                            <span>Фортепиано</span>
                        </div>
                        <div class="d-flex w-100 specialist-time">
                            {% for i in time_cells %}
                            <div class="time-cell flex-fill"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <!--Таблица броней-->
            <table id="table-{{ forloop.counter }}" class="table table-bordered">
                <thead>
                    <tr>
                        <th></th>
                        {% for block in time_blocks %}
                        <th colspan="4">
                            {{ block.time }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for room in rooms %}
                    <tr id="row-{{ forloop.counter }}">
                        <td title="{{ room.name }}">
                            {{ room.name }}
                        </td>

                        {% for block in time_blocks %}
                        {% for i in "1234" %}
                        {% with block_time=block.time|time_add:forloop.counter0|str_to_time %}
                        {% with full_datetime=day.date|combine_date_time:block_time %}

                        <td class="highlight-cell available" full_datetime="{{ full_datetime|date:'Y-m-d H:i:s' }}"
                            room_name="{{ room.name }}" room_id="{{ room.id }}"
                            title="{{ block.time|time_add:forloop.counter0 }}" onclick="openCreateModal(
                    `{{ day.date|date:'d E Y' }}`,
                    `{{ block.time|time_add:forloop.counter0 }}`,
                    `{{ room.name }}`,
                    '{{ room.id }}',
                    this
                    )">
                        </td>
                        {% endwith %}
                        {% endwith %}
                        {% endfor %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endfor %}
        </div>
    </div>

    {% include "booking/user/modals/booking/modal_create_booking.html" %}
    {% include "booking/user/modals/booking/modal_edit_booking.html" %}
    {% include "booking/user/modals/booking/modal_info_booking.html" %}
    {% include "booking/user/modals/payments/modal_payment_booking.html" %}
    {% include "booking/user/modals/payments/modal_payment_history.html" %}
    {% include "booking/user/modals/payments/modal_edit_payment.html" %}
    {% include "booking/user/modals/common/modal_confirm_cancel_action.html" %}
    {% include "booking/user/modals/payments/modal_confirm_cancel_payment.html" %}

    {% include 'booking/add/scripts.html' %}

    <script>
        // Глобальный массив броней для сетки календаря
        var bookingsInRange = [];

        $(document).ready(function () {
            // Обновление забронированных ячеек
            bookingsInRange = JSON.parse(document.getElementById('bookings_in_range').textContent);
            const roomCells = document.querySelectorAll('td[room_name]');

            roomCells.forEach(function (cell) {
                const initialOnclick = cell.getAttribute('onclick');
                if (initialOnclick) {
                    cell.dataset.originalOnclick = initialOnclick;
                }
            });

            function getCurrentScenarioFromGlobals() {
                if (!window.currentScenarioFilterId || !Array.isArray(window.SCENARIOS)) {
                    return null;
                }

                var scenarioId = String(window.currentScenarioFilterId);
                return window.SCENARIOS.find(function (s) {
                    return String(s.pk) === scenarioId;
                }) || null;
            }

            function parseTimeToMinutes(timeStr) {
                if (!timeStr) {
                    return null;
                }

                // Ожидаем формат HH:MM или HH:MM:SS
                var parts = String(timeStr).split(':');
                if (parts.length < 2) {
                    return null;
                }

                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);

                if (isNaN(hours) || isNaN(minutes)) {
                    return null;
                }

                return hours * 60 + minutes;
            }

            function resetScenarioRestrictionsForAllCells() {
                roomCells.forEach(function (cell) {
                    if (cell.classList.contains('booked')) {
                        return;
                    }

                    if (cell.dataset.originalOnclick && !cell.getAttribute('onclick')) {
                        cell.setAttribute('onclick', cell.dataset.originalOnclick);
                    }

                    cell.classList.add('available');
                    cell.style.backgroundColor = '';
                    cell.style.cursor = '';
                });
            }

            function applyScenarioWorkTimeRestrictions() {
                var scenario = getCurrentScenarioFromGlobals();

                // Если сценарий не выбран или нет данных по времени работы — ничего не ограничиваем
                if (!scenario || !scenario.fields) {
                    resetScenarioRestrictionsForAllCells();
                    return;
                }

                var fields = scenario.fields || {};
                var startMinutes = parseTimeToMinutes(fields.work_time_start);
                var endMinutes = parseTimeToMinutes(fields.work_time_end);

                // Если время не задано или не распарсилось — считаем, что ограничений нет
                if (startMinutes === null || endMinutes === null) {
                    resetScenarioRestrictionsForAllCells();
                    return;
                }

                roomCells.forEach(function (cell) {
                    // Забронированные ячейки не трогаем, их поведение определяется логикой броней
                    if (cell.classList.contains('booked')) {
                        return;
                    }

                    var dtStr = cell.getAttribute('full_datetime');
                    if (!dtStr) {
                        return;
                    }

                    var dtParts = dtStr.split(' ');
                    if (dtParts.length < 2) {
                        return;
                    }

                    var cellMinutes = parseTimeToMinutes(dtParts[1]);
                    if (cellMinutes === null) {
                        return;
                    }

                    var insideInterval;
                    if (endMinutes > startMinutes) {
                        // Обычный интервал в пределах суток, например 08:00-22:00
                        insideInterval = cellMinutes >= startMinutes && cellMinutes < endMinutes;
                    } else if (endMinutes < startMinutes) {
                        // Интервал через полночь (например 22:00-02:00)
                        insideInterval = cellMinutes >= startMinutes || cellMinutes < endMinutes;
                    } else {
                        // start == end — трактуем как отсутствие рабочего времени
                        insideInterval = false;
                    }

                    if (!insideInterval) {
                        // Вне рабочего интервала сценария — отключаем клик и красим ячейку
                        cell.classList.remove('available');
                        cell.style.backgroundColor = '#EBEBEC';
                        cell.style.cursor = 'default';
                        cell.removeAttribute('onclick');
                    } else {
                        // Внутри рабочего интервала — возвращаем доступность, если ячейка не занята
                        if (cell.dataset.originalOnclick && !cell.getAttribute('onclick')) {
                            cell.setAttribute('onclick', cell.dataset.originalOnclick);
                        }
                        cell.classList.add('available');
                        if (cell.style.backgroundColor === 'rgb(235, 235, 236)' || cell.style.backgroundColor === '#EBEBEC') {
                            cell.style.backgroundColor = '';
                        }
                        if (cell.style.cursor === 'default') {
                            cell.style.cursor = '';
                        }
                    }
                });
            }

            function updateBookedCells() {
                // Сначала очищаем все ячейки
                roomCells.forEach(function (cell) {
                    cell.classList.remove('highlight-cell', 'booked');
                    cell.classList.add('highlight-cell', 'available');
                    cell.style.background = '';
                    cell.style.border = '';
                    cell.style.position = '';
                    cell.style.zIndex = '';
                    // Удаляем старые booking-block если есть
                    const oldBlock = cell.querySelector('.booking-block');
                    if (oldBlock) {
                        oldBlock.remove();
                    }

                    if (cell.dataset.originalOnclick) {
                        cell.setAttribute('onclick', cell.dataset.originalOnclick);
                    }
                });

                // Обрабатываем бронирования
                bookingsInRange.forEach(function (booking) {
                    var startTime = new Date(booking.blocks_datetime_range[0]);
                    var endTime = new Date(booking.blocks_datetime_range[booking.blocks_datetime_range.length - 1]);

                    // Находим все ячейки для текущего бронирования
                    var bookingCells = [];
                    var firstCell = null;

                    roomCells.forEach(function (cell) {
                        if (cell.getAttribute('room_name') === booking.room_name) {
                            var cellTime = new Date(cell.getAttribute('full_datetime'));

                            if (cellTime >= startTime && cellTime < endTime) {
                                cell.classList.remove('available');
                                cell.classList.add('booked');

                                // Убираем обработчик открытия модалки с занятой ячейки
                                cell.removeAttribute('onclick');


                                if (!firstCell) {
                                    firstCell = cell;
                                }
                                bookingCells.push(cell);
                            }
                        }
                    });

                    // Если нашли ячейки для бронирования
                    if (firstCell && bookingCells.length > 0) {
                        const lastCell = bookingCells[bookingCells.length - 1];
                        const firstRect = firstCell.getBoundingClientRect();
                        const lastRect = lastCell.getBoundingClientRect();
                        // Реальная ширина от левого края первой до правого края последней ячейки минус отступы
                        const fullWidth = lastRect.right - firstRect.left;
                        // 7px для симметричных отступов (компенсация субпиксельного округления)
                        const totalWidth = Math.max(fullWidth - 7, 0);
                        // Создаем один общий блок бронирования
                        const bookingBlock = createBookingBlock(booking, totalWidth, firstCell);
                        firstCell.style.position = 'relative';
                        firstCell.style.zIndex = '1';

                        // Добавляем блок в первую ячейку
                        firstCell.appendChild(bookingBlock);
                    }
                });

                // После отрисовки броней применяем ограничения по времени работы выбранного сценария
                applyScenarioWorkTimeRestrictions();
            }

            function createBookingBlock(booking, blockWidth, firstCell) {
                const block = document.createElement('div');
                block.className = 'booking-block';
                block.setAttribute('data-booking-id', booking.id);
                block.style.cursor = 'pointer';
                
                // Учитываем border ячейки: left отсчитывается от padding edge (внутри border)
                const cellStyle = getComputedStyle(firstCell);
                const borderLeft = parseFloat(cellStyle.borderLeftWidth) || 0;
                
                // Чтобы визуальный отступ от внешнего края был 3px, left = 3 - borderLeft
                block.style.left = (3 - borderLeft) + 'px';
                block.style.width = blockWidth + 'px';
                block.onclick = function (event) {
                    event.stopPropagation();
                    window.currentBookingId = booking.id;
                    openInfoModal();
                };

                return block;
            }

            function assignParentAttributes() {
                var tables = document.querySelectorAll('table');
                tables.forEach(function (table) {
                    var tableId = table.id;
                    var rows = table.querySelectorAll('tr');
                    rows.forEach(function (row) {
                        row.setAttribute('parent_table_id', tableId);
                        var cells = row.querySelectorAll('td');
                        cells.forEach(function (cell) {
                            cell.setAttribute('parent_table_id', tableId);
                            cell.setAttribute('parent_row_id', row.id);
                            var tableRowSelectors = `#${tableId} #${row.id} td`;
                            cell.setAttribute('table_row_selectors', tableRowSelectors);
                        });
                    });
                });
            }

            // Задержка чтобы таблица успела отрендериться и размеры были корректны
            setTimeout(function() {
                updateBookedCells();
                assignParentAttributes();
            }, 50);

            let resizeTimeout = null;
            window.addEventListener('resize', function () {
                if (resizeTimeout) {
                    clearTimeout(resizeTimeout);
                }
                resizeTimeout = setTimeout(function () {
                    updateBookedCells();
                }, 150);
            });

            // Периодическое обновление сетки календаря (пуллинг раз в 5 секунд)
            async function refreshBookingsGrid(options) {
                const opts = options || {};

                const params = new URLSearchParams({
                    date_from: window.SHOW_DATE_FROM,
                    date_to: window.SHOW_DATE_TO,
                });

                try {
                    const response = await fetch(`/booking/bookings-grid/?${params.toString()}`);
                    if (!response.ok) {
                        console.error('Ошибка обновления сетки бронирований:', response.status);
                        return;
                    }

                    const data = await response.json();
                    if (!data.success || !Array.isArray(data.bookings_in_range)) {
                        console.error('Некорректный ответ при обновлении сетки бронирований:', data);
                        return;
                    }

                    bookingsInRange = data.bookings_in_range;
                    updateBookedCells();
                } catch (error) {
                    console.error('Сетевая ошибка при обновлении сетки бронирований:', error);
                }
            }

            // Экспортируем функцию в глобальное пространство имён, чтобы вызывать из других скриптов
            window.refreshBookingsGrid = refreshBookingsGrid;

            setInterval(function () {
                refreshBookingsGrid({ silent: true });
            }, 5000);

            // Делаем функцию доступной глобально, чтобы можно было вызывать при смене фильтра сценария
            window.applyScenarioWorkTimeRestrictions = applyScenarioWorkTimeRestrictions;
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Поведение выпадающих списков только для фильтров в шапке календаря
            const customSelects = document.querySelectorAll('#booking-filters .custom-select');

            customSelects.forEach(select => {
                const selected = select.querySelector('.selected');
                const optionsContainer = select.querySelector('.options');
                if (!selected || !optionsContainer) {
                    return;
                }

                const optionsList = optionsContainer.querySelectorAll('li');
                const filterType = select.getAttribute('data-filter-type');

                // событие на весь div
                select.addEventListener('click', () => {
                    select.classList.toggle('open');
                });

                optionsList.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // убрать выделение со всех
                        optionsList.forEach(opt => opt.classList.remove('selected'));
                        // добавить выбранному
                        option.classList.add('selected');
                        selected.textContent = option.textContent;
                        select.classList.remove('open');

                        const value = option.getAttribute('data-value') || null;
                        if (filterType === 'scenario') {
                            window.currentScenarioFilterId = value;
                            if (typeof window.applyScenarioWorkTimeRestrictions === 'function') {
                                window.applyScenarioWorkTimeRestrictions();
                            }
                        } else if (filterType === 'area') {
                            window.currentAreaFilterId = value;
                        }
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!select.contains(e.target)) {
                        select.classList.remove('open');
                    }
                });

                // Для фильтров (area/scenario) сразу выбираем первый элемент из БД
                if (optionsList.length > 0 && (filterType === 'area' || filterType === 'scenario')) {
                    const firstOption = optionsList[0];
                    firstOption.classList.add('selected');
                    selected.textContent = firstOption.textContent;

                    const initialValue = firstOption.getAttribute('data-value') || null;
                    if (filterType === 'scenario') {
                        window.currentScenarioFilterId = initialValue;
                        if (typeof window.applyScenarioWorkTimeRestrictions === 'function') {
                            window.applyScenarioWorkTimeRestrictions();
                        }
                    } else if (filterType === 'area') {
                        window.currentAreaFilterId = initialValue;
                    }
                }
            });
        });
    </script>

    <script>
        (function () {
            const appBackdrop = document.getElementById('app-modal-backdrop');
            if (!appBackdrop) {
                return;
            }

            const NO_BACKDROP_CLOSE_IDS = ['confirmCancelActionModal'];
            let openModalsCount = 0;
            let hideTimeoutId = null;

            function showAppBackdrop() {
                if (hideTimeoutId) {
                    clearTimeout(hideTimeoutId);
                    hideTimeoutId = null;
                }
                appBackdrop.classList.add('is-visible');
            }

            function scheduleHideBackdrop() {
                if (hideTimeoutId) {
                    clearTimeout(hideTimeoutId);
                }
                hideTimeoutId = setTimeout(function () {
                    if (openModalsCount <= 0) {
                        appBackdrop.classList.remove('is-visible');
                        openModalsCount = 0;
                    }
                }, 150);
            }

            function findTopmostClosableModal() {
                const shownModals = Array.prototype.slice.call(document.querySelectorAll('.modal.show'));
                if (!shownModals.length) {
                    return null;
                }

                shownModals.sort(function (a, b) {
                    const za = parseInt(window.getComputedStyle(a).zIndex || '0', 10);
                    const zb = parseInt(window.getComputedStyle(b).zIndex || '0', 10);
                    return za - zb;
                });

                for (let i = shownModals.length - 1; i >= 0; i--) {
                    const modal = shownModals[i];
                    if (!NO_BACKDROP_CLOSE_IDS.includes(modal.id)) {
                        return modal;
                    }
                }
                return null;
            }

            document.querySelectorAll('.modal').forEach(function (modal) {
                modal.addEventListener('show.bs.modal', function () {
                    openModalsCount += 1;
                    showAppBackdrop();
                });

                modal.addEventListener('hidden.bs.modal', function () {
                    if (openModalsCount > 0) {
                        openModalsCount -= 1;
                    }
                    if (openModalsCount === 0) {
                        scheduleHideBackdrop();
                    }
                });

                modal.addEventListener('mousedown', function (event) {
                    if (event.target !== modal) {
                        return;
                    }
                    if (NO_BACKDROP_CLOSE_IDS.includes(modal.id)) {
                        return;
                    }
                    const instance = bootstrap.Modal.getInstance(modal) || new bootstrap.Modal(modal);
                    if (instance) {
                        instance.hide();
                    }
                });
            });

            appBackdrop.addEventListener('click', function () {
                const targetModal = findTopmostClosableModal();
                if (!targetModal) {
                    return;
                }
                const instance = bootstrap.Modal.getInstance(targetModal) || new bootstrap.Modal(targetModal);
                if (instance) {
                    instance.hide();
                }
            });
        })();
    </script>

    <script>
        function openCreateModal(date, time, roomName, roomId, element) {
            var createModalElement = document.getElementById('createBookingModal');
            if (!createModalElement) {
                return;
            }

            if (typeof openModal === 'function') {
                openModal(date, time, roomName, roomId, element);
            }

            var createModal = bootstrap.Modal.getInstance(createModalElement) || new bootstrap.Modal(createModalElement);
            createModal.show();
        }
    </script>

    <script>
        function isBookingFullyPaid(bookingData) {
            if (!bookingData || bookingData.remaining_amount === undefined || bookingData.remaining_amount === null) {
                return false;
            }

            var remainingRaw = String(bookingData.remaining_amount);
            var remaining = parseFloat(remainingRaw.replace(',', '.'));
            if (isNaN(remaining)) {
                return false;
            }

            return remaining <= 0;
        }

        function updateInfoModalPaymentButtonState(bookingData) {
            var paymentButton = document.getElementById('infoPaymentButton');
            if (!paymentButton) {
                return;
            }

            if (isBookingFullyPaid(bookingData)) {
                paymentButton.textContent = 'Оплачено';
                paymentButton.classList.remove('button-primary');
                paymentButton.classList.add('button-sec');
                paymentButton.disabled = true;
                paymentButton.setAttribute('aria-disabled', 'true');
                paymentButton.onclick = null;
            } else {
                paymentButton.textContent = 'Внести оплату';
                paymentButton.classList.remove('button-sec');
                paymentButton.classList.add('button-primary');
                paymentButton.disabled = false;
                paymentButton.removeAttribute('aria-disabled');
                paymentButton.onclick = function () {
                    switchToPaymentModal();
                };
            }
        }

        async function openInfoModal() {
            var infoModalElement = document.getElementById('infoBookingModal');
            if (!infoModalElement) {
                return;
            }

            var bookingId = window.currentBookingId;
            if (bookingId) {
                try {
                    var response = await fetch(`/booking/get-booking-details/${bookingId}/`);
                    if (response.ok) {
                        var data = await response.json();
                        if (data.success && data.booking) {
                            var booking = data.booking;

                            var scenarioElement = infoModalElement.querySelector('#scenarioName');
                            var roomElement = infoModalElement.querySelector('#roomName');
                            var publicIdElement = infoModalElement.querySelector('#publicID');
                            var dateElement = infoModalElement.querySelector('#infoBookingDate');
                            var timeElement = infoModalElement.querySelector('#infoBookingTime');
                            var durationElement = infoModalElement.querySelector('#infoBookingDuration');
                            var directionElement = infoModalElement.querySelector('#infoBookingDirection');
                            var specialistElement = infoModalElement.querySelector('#infoBookingSpecialist');
                            var clientNameElement = infoModalElement.querySelector('#infoBookingClientName');
                            var clientPhoneElement = infoModalElement.querySelector('#infoBookingClientPhone');
                            var commentContainer = infoModalElement.querySelector('#infoBookingCommentContainer');
                            var commentTextElement = infoModalElement.querySelector('#infoBookingCommentText');
                            var totalAmountElement = infoModalElement.querySelector('#infoBookingTotalAmount');
                            var paidAmountElement = infoModalElement.querySelector('#infoBookingPaidAmount');

                            if (scenarioElement && typeof booking.reservation_type === 'string') {
                                scenarioElement.textContent = booking.reservation_type;
                            }
                            if (roomElement && typeof booking.room_name === 'string') {
                                roomElement.textContent = booking.room_name;
                            }

                            if (publicIdElement && (typeof booking.id === 'number' || typeof booking.id === 'string')) {
                                publicIdElement.textContent = booking.id;
                            }

                            if (dateElement && typeof booking.date === 'string') {
                                dateElement.textContent = booking.date;
                            }

                            if (timeElement && typeof booking.time === 'string') {
                                timeElement.textContent = booking.time + ' / ';
                            }

                            if (durationElement && typeof booking.duration === 'string') {
                                durationElement.textContent = booking.duration;
                            }

                            if (directionElement && typeof booking.direction_name === 'string') {
                                directionElement.textContent = booking.direction_name;
                            }

                            if (specialistElement && typeof booking.specialist_name === 'string') {
                                specialistElement.textContent = booking.specialist_name;
                            }

                            if (clientNameElement && typeof booking.client_name === 'string') {
                                clientNameElement.textContent = booking.client_name;
                            }

                            if (clientPhoneElement) {
                                if (typeof booking.client_phone === 'string' && booking.client_phone) {
                                    var rawPhone = booking.client_phone.replace(/\s+/g, '');
                                    var formattedPhone = booking.client_phone;
                                    var match = rawPhone.match(/^(\+375)(\d{2})(\d{3})(\d{2})(\d{2})$/);
                                    if (match) {
                                        formattedPhone = match[1] + ' ' + match[2] + ' ' + match[3] + ' ' + match[4] + ' ' + match[5];
                                    }
                                    clientPhoneElement.textContent = formattedPhone;
                                } else {
                                    clientPhoneElement.textContent = '';
                                }
                            }

                            if (totalAmountElement && typeof booking.total_cost === 'string') {
                                var totalRaw = booking.total_cost;
                                var totalNum = Number(totalRaw.replace(',', '.'));
                                if (!isNaN(totalNum)) {
                                    var totalStr;
                                    if (Math.abs(totalNum % 1) < 1e-9) {
                                        totalStr = totalNum.toFixed(0);
                                    } else {
                                        totalStr = totalNum.toFixed(2);
                                    }
                                    totalAmountElement.textContent = totalStr;
                                } else {
                                    totalAmountElement.textContent = totalRaw;
                                }
                            }

                            if (paidAmountElement && typeof booking.paid_amount === 'string') {
                                var paidRaw = booking.paid_amount;
                                var paidNum = Number(paidRaw.replace(',', '.'));
                                if (!isNaN(paidNum)) {
                                    var paidStr;
                                    if (Math.abs(paidNum % 1) < 1e-9) {
                                        paidStr = paidNum.toFixed(0);
                                    } else {
                                        paidStr = paidNum.toFixed(2);
                                    }
                                    paidAmountElement.textContent = paidStr;
                                } else {
                                    paidAmountElement.textContent = paidRaw;
                                }
                            }

                            if (commentContainer && commentTextElement) {
                                var comment = booking.comment;
                                if (typeof comment === 'string' && comment.trim()) {
                                    commentTextElement.textContent = comment;
                                    commentContainer.style.display = '';
                                } else {
                                    commentTextElement.textContent = '';
                                    commentContainer.style.display = 'none';
                                }
                            }

                            updateInfoModalPaymentButtonState(booking);
                        }
                    } else {
                        console.error('Не удалось получить детали брони для info-модалки:', response.status);
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке деталей брони для info-модалки:', error);
                }
            }

            var infoModal = new bootstrap.Modal(infoModalElement);
            infoModal.show();
        }
    </script>

</body>

</html>
<!DOCTYPE html>
{% load static %}
{% load custom_filters %}
<html lang="ru">

<head>
    <title>CRM</title>
    <link rel="stylesheet" href="{% static 'css/repa.css' %}?v={% now 'U' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.0/dist/sweetalert2.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.0/dist/sweetalert2.min.js"></script>

</head>

<body>
    <div id="app-modal-backdrop"></div>
    <div id="calendar-loading-overlay">
        <div class="calendar-loading-content">
            <div class="calendar-loading-spinner"></div>
            <div class="calendar-loading-text">Загрузка календаря...</div>
        </div>
    </div>
    <div id="booking-saving-overlay">
        <div class="calendar-loading-content">
            <div class="calendar-loading-spinner"></div>
            <div class="calendar-loading-text">Сохранение брони...</div>
        </div>
    </div>

    <script>
        window.ROOMS = JSON.parse('{{ rooms_json|escapejs }}');
        window.TIME_BLOCKS = JSON.parse('{{ time_blocks_json|escapejs }}');
        window.SCENARIOS = JSON.parse('{{ scenarios_json|escapejs }}');
        window.SPECIALISTS = JSON.parse('{{ specialists_json|escapejs }}');
        window.PAYMENT_TYPES = JSON.parse('{{ payment_types_json|escapejs }}');
        window.TARIFF_UNITS = JSON.parse('{{ tariff_units_json|escapejs }}');
        window.TARIFFS = JSON.parse('{{ tariffs_json|escapejs }}');
        window.TARIFF_WEEKLY_INTERVALS = JSON.parse('{{ tariff_weekly_intervals_json|escapejs }}');

        // Диапазон дат, для которого сейчас отрисован календарь
        window.SHOW_DATE_FROM = '{{ show_datefrom }}';
        window.SHOW_DATE_TO = '{{ show_dateto }}';
    </script>

    <p id="bookings_in_range" style="display: none;">{{ bookings_in_range }}</p>

    <div class="container-fluid">
        {% include 'booking/add/head.html' %}
        {% include 'booking/add/menu.html' %}
        <div class="row mt-4 mb-2" style="border-bottom: 1px solid #EBEBEC; 
    position: sticky;
    top: 41px;
    z-index: 900;
    background-color: #fff;">
            <div class="row mt-5 mb-2">
                <div class="col-md-12 d-flex justify-content-between align-items-center">
                    <h1 class="mb-0">Брони</h1>
                    <div class="d-flex gap-2">
                        <button type="button" class="button-secondary" id="openAddClientModalBtn" data-bs-toggle="modal" data-bs-target="#addClientModal">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 12H19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 5V19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span>Добавить клиента</span>
                        </button>
                        <button type="button" class="button-secondary">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 12H19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 5V19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span>Добавить абонемент</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row mb-2" id="booking-filters">
                <div class="col-md-3">
                    <div class="custom-select-wrapper">
                        <div class="custom-select" data-placeholder="Выберите помещение" data-filter-type="area">
                            <span class="selected">Выберите помещение</span>
                            <span class="chevron">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                </svg>
                            </span>
                            <ul class="options">
                                {% for area in areas %}
                                <li data-value="{{ area.id }}">{{ area.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="custom-select-wrapper">
                        <div class="custom-select" data-placeholder="Выберите сценарий" data-filter-type="scenario">
                            <span class="selected">Выберите сценарий</span>
                            <span class="chevron">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                </svg>
                            </span>
                            <ul class="options">
                                {% for scenario in scenarios %}
                                <li data-value="{{ scenario.id }}">{{ scenario.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 offset-md-3">
                    <div class="calendar-period-wrapper" style="position: relative; display: inline-block;">
                        <div class="calendar-period" id="calendar-period-trigger">
                            <span>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M16 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path
                                        d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z"
                                        stroke="#7A52FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M3 10H21" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M8 14H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M12 14H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M16 14H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M8 18H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M12 18H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M16 18H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </span>
                            <span id="start-calendar-period-text">
                                18 сентября
                            </span>
                            <span style="color: #818EA2;"> — </span>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 2V6" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path
                                    d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z"
                                    stroke="#7A52FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M3 10H21" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M8 14H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 14H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 14H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M8 18H8.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 18H12.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 18H16.01" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span id="end-calendar-period-text">
                                24 сентября
                            </span>
                        </div>
                        <div id="dateRangePicker" class="date-range-picker">
                            <div class="date-range-picker__content">
                                <div class="date-range-picker__presets">
                                    <ul class="date-range-picker__presets-list">
                                        <li class="date-range-picker__presets-item" data-preset="today">Сегодня</li>
                                        <li class="date-range-picker__presets-item" data-preset="yesterday">Вчера</li>
                                        <li class="date-range-picker__presets-item" data-preset="today_yesterday">Сегодня и вчера</li>
                                        <li class="date-range-picker__presets-item" data-preset="last7">Последние 7 дн.</li>
                                        <li class="date-range-picker__presets-item" data-preset="current14">Текущие 14 дней</li>
                                        <li class="date-range-picker__presets-item" data-preset="last14">Последние 14 дн.</li>
                                        <li class="date-range-picker__presets-item" data-preset="last30">Последние 30 дн.</li>
                                        <li class="date-range-picker__presets-item" data-preset="this_week">Эта неделя</li>
                                        <li class="date-range-picker__presets-item" data-preset="last_week">Прошлая неделя</li>
                                        <li class="date-range-picker__presets-item" data-preset="this_month">Этот месяц</li>
                                        <li class="date-range-picker__presets-item" data-preset="last_month">Прошлый месяц</li>
                                    </ul>
                                </div>
                                <div class="date-range-picker__calendars">
                                    <div class="date-range-picker__months">
                                        <div class="date-range-picker__month">
                                            <div class="date-range-picker__month-header date-range-picker__month-header--left">
                                                <button type="button" class="date-range-picker__nav-btn" data-role="nav-prev">&#8249;</button>
                                                <select class="date-range-picker__select" data-role="month-select-left"></select>
                                                <select class="date-range-picker__select" data-role="year-select-left"></select>
                                            </div>
                                            <div class="date-range-picker__month-grid" data-role="month-grid-left"></div>
                                        </div>
                                        <div class="date-range-picker__month">
                                            <div class="date-range-picker__month-header date-range-picker__month-header--right">
                                                <select class="date-range-picker__select" data-role="month-select-right"></select>
                                                <select class="date-range-picker__select" data-role="year-select-right"></select>
                                                <button type="button" class="date-range-picker__nav-btn" data-role="nav-next">&#8250;</button>
                                            </div>
                                            <div class="date-range-picker__month-grid" data-role="month-grid-right"></div>
                                        </div>
                                    </div>
                                    <div class="date-range-picker__footer">
                                        <button type="button" class="button-secondary" id="dateRangeCancelBtn">Отмена</button>
                                        <button type="button" class="button-primary" id="dateRangeApplyBtn">Обновить</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="height: 30px;"></div>
        <div class="container-fluid" id="calendar-grid-container">
            {% include 'booking/user/_calendar_grid.html' %}
        </div>

        <div id="bookingHoverPopover" class="booking-hover-popover">
            <div class="booking-hover-popover__row" id="bookingHoverPopoverTimeRow">
                <div class="booking-hover-popover__icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M12 6V12L16 14" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="booking-hover-popover__text">
                    <span id="bookingHoverPopoverTime"></span> / <span id="bookingHoverPopoverDuration"></span>
                </div>
            </div>

            <div class="booking-hover-popover__row" id="bookingHoverPopoverClientRow">
                <div class="booking-hover-popover__icon" id="bookingHoverPopoverClientIconSingle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21V19C19 17.9391 18.5786 16.9217 17.8284 16.1716C17.0783 15.4214 16.0609 15 15 15H9C7.93913 15 6.92172 15.4214 6.17157 16.1716C5.42143 16.9217 5 17.9391 5 19V21" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="booking-hover-popover__icon" id="bookingHoverPopoverClientIconGroup" style="display:none;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 21V19C16 17.9391 15.5786 16.9217 14.8284 16.1716C14.0783 15.4214 13.0609 15 12 15H6C4.93913 15 3.92172 15.4214 3.17157 16.1716C2.42143 16.9217 2 17.9391 2 19V21" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 21V19C21.9993 18.1137 21.7044 17.2528 21.1614 16.5523C20.6184 15.8519 19.8581 15.3516 19 15.13" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="booking-hover-popover__text" id="bookingHoverPopoverClientName"></div>
            </div>

            <div class="booking-hover-popover__row" id="bookingHoverPopoverDirectionRow">
                <div class="booking-hover-popover__icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18V5L21 3V16" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M6 21C7.65685 21 9 19.6569 9 18C9 16.3431 7.65685 15 6 15C4.34315 15 3 16.3431 3 18C3 19.6569 4.34315 21 6 21Z" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M18 19C19.6569 19 21 17.6569 21 16C21 14.3431 19.6569 13 18 13C16.3431 13 15 14.3431 15 16C15 17.6569 16.3431 19 18 19Z" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="booking-hover-popover__text" id="bookingHoverPopoverDirection"></div>
            </div>

            <div class="booking-hover-popover__row" id="bookingHoverPopoverSpecialistRow">
                <div class="booking-hover-popover__icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14.3047 19.53L15.2277 19.148" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M15.2277 16.852L14.3047 16.469" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M16.8517 15.228L16.4688 14.305" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M16.8517 20.772L16.4688 21.696" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M19.1484 15.228L19.5314 14.305" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M19.5304 21.696L19.1484 20.772" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M2 21C2.00012 19.741 2.29739 18.4997 2.86766 17.3773C3.43792 16.2548 4.26506 15.2827 5.28182 14.5402C6.29858 13.7976 7.47624 13.3056 8.71904 13.104C9.96183 12.9024 11.2347 12.9969 12.434 13.38" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M20.7725 16.852L21.6965 16.469" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M20.7725 19.148L21.6965 19.531" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M10 13C12.7614 13 15 10.7614 15 8C15 5.23858 12.7614 3 10 3C7.23858 3 5 5.23858 5 8C5 10.7614 7.23858 13 10 13Z" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M18 21C19.6569 21 21 19.6569 21 18C21 16.3431 19.6569 15 18 15C16.3431 15 15 16.3431 15 18C15 19.6569 16.3431 21 18 21Z" stroke="#818EA2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="booking-hover-popover__text booking-hover-popover__text--muted" id="bookingHoverPopoverSpecialist"></div>
            </div>

            <div class="booking-hover-popover__comment" id="bookingHoverPopoverComment" style="display:none;"></div>
        </div>
    </div>

    <script src="{% static 'js/booking_time_utils.js' %}?v={% now 'U' %}"></script>
    <script src="{% static 'js/booking_modal_utils.js' %}?v={% now 'U' %}"></script>
    <script src="{% static 'js/booking_selects_utils.js' %}?v={% now 'U' %}"></script>
    <script src="{% static 'js/booking_services_utils.js' %}?v={% now 'U' %}"></script>

    {% include "booking/user/modals/booking/modal_create_booking.html" %}
    {% include "booking/user/modals/booking/modal_edit_booking.html" %}
    {% include "booking/user/modals/booking/modal_info_booking.html" %}
    {% include "booking/user/modals/booking/modal_delete_booking.html" %}
    {% include "booking/user/modals/payments/modal_payment_booking.html" %}
    {% include "booking/user/modals/payments/modal_payment_history.html" %}
    {% include "booking/user/modals/payments/modal_edit_payment.html" %}
    {% include "booking/user/modals/common/modal_confirm_cancel_action.html" %}
    {% include "booking/user/modals/payments/modal_confirm_cancel_payment.html" %}
    {% include "booking/user/modals/client/modal_add_client.html" %}
    {% include "booking/user/modals/client/modal_client_added_success.html" %}
    {% include "booking/user/modals/booking/modal_booking_added_success.html" %}

    {% include 'booking/add/scripts.html' %}

    <script>
        // Глобальный массив броней для сетки календаря
        var bookingsInRange = [];
        // Текущий набор ячеек календарной сетки (пересчитывается при обновлении HTML)
        var roomCells = [];

        function initializeCalendarGridState() {
            var container = document.getElementById('calendar-grid-container');
            if (!container) {
                roomCells = [];
                return;
            }

            roomCells = Array.prototype.slice.call(container.querySelectorAll('td[room_name]'));

            roomCells.forEach(function (cell) {
                var initialOnclick = cell.getAttribute('onclick');
                if (initialOnclick && !cell.dataset.originalOnclick) {
                    cell.dataset.originalOnclick = initialOnclick;
                }
            });
        }

        $(document).ready(function () {
            // Обновление забронированных ячеек
            bookingsInRange = JSON.parse(document.getElementById('bookings_in_range').textContent);
            initializeCalendarGridState();

            var bookingHoverPopoverEl = document.getElementById('bookingHoverPopover');
            var bookingHoverPopoverCache = {};
            var bookingHoverPopoverActiveId = null;
            var bookingHoverPopoverAnchorRect = null;

            window.invalidateBookingHoverPopoverCache = function (bookingId) {
                if (bookingId !== undefined && bookingId !== null && String(bookingId).trim() !== '') {
                    delete bookingHoverPopoverCache[String(bookingId)];
                    return;
                }
                Object.keys(bookingHoverPopoverCache).forEach(function (k) {
                    delete bookingHoverPopoverCache[k];
                });
            };

            function isSimpleScenarioName(scenarioName) {
                var name = (typeof scenarioName === 'string') ? scenarioName.trim() : '';
                return name === 'Репетиционная точка' || name === 'Музыкальный класс';
            }

            function hideBookingHoverPopover() {
                bookingHoverPopoverActiveId = null;
                bookingHoverPopoverAnchorRect = null;
                if (!bookingHoverPopoverEl) {
                    return;
                }
                bookingHoverPopoverEl.style.display = 'none';
            }

            function positionBookingHoverPopover() {
                if (!bookingHoverPopoverEl || bookingHoverPopoverEl.style.display === 'none') {
                    return;
                }

                if (!bookingHoverPopoverAnchorRect) {
                    return;
                }

                var offset = 0;
                var overlap = 8;
                var padding = 8;

                var popoverWidth = bookingHoverPopoverEl.offsetWidth;
                var popoverHeight = bookingHoverPopoverEl.offsetHeight;

                var left = bookingHoverPopoverAnchorRect.right - overlap + offset;
                var top = bookingHoverPopoverAnchorRect.top + (bookingHoverPopoverAnchorRect.height / 2) - (popoverHeight / 2);

                if (left + popoverWidth + padding > window.innerWidth) {
                    left = bookingHoverPopoverAnchorRect.left - popoverWidth + overlap - offset;
                }

                if (left < padding) {
                    left = padding;
                }

                if (top < padding) {
                    top = padding;
                } else if (top + popoverHeight + padding > window.innerHeight) {
                    top = Math.max(padding, window.innerHeight - popoverHeight - padding);
                }

                bookingHoverPopoverEl.style.left = left + 'px';
                bookingHoverPopoverEl.style.top = top + 'px';
            }

            function formatDurationCompactFromHhmm(durationHhmm) {
                if (!durationHhmm) {
                    return '';
                }
                var parts = String(durationHhmm).split(':');
                if (parts.length < 2) {
                    return '';
                }
                var h = parseInt(parts[0], 10);
                var m = parseInt(parts[1], 10);
                if (!Number.isFinite(h) || !Number.isFinite(m) || (h === 0 && m === 0)) {
                    return '';
                }
                if (h > 0 && m > 0) {
                    return h + 'ч ' + m + 'мин';
                }
                if (h > 0) {
                    return h + 'ч';
                }
                return m + 'мин';
            }

            function fillBookingHoverPopover(booking) {
                if (!bookingHoverPopoverEl || !booking) {
                    return;
                }

                var timeEl = document.getElementById('bookingHoverPopoverTime');
                var durationEl = document.getElementById('bookingHoverPopoverDuration');
                var clientNameEl = document.getElementById('bookingHoverPopoverClientName');
                var directionEl = document.getElementById('bookingHoverPopoverDirection');
                var specialistEl = document.getElementById('bookingHoverPopoverSpecialist');
                var directionRow = document.getElementById('bookingHoverPopoverDirectionRow');
                var specialistRow = document.getElementById('bookingHoverPopoverSpecialistRow');
                var commentEl = document.getElementById('bookingHoverPopoverComment');

                if (timeEl) {
                    timeEl.textContent = (typeof booking.time === 'string') ? booking.time : '';
                }
                if (durationEl) {
                    var compact = formatDurationCompactFromHhmm(booking.duration_hhmm);
                    durationEl.textContent = compact || ((typeof booking.duration === 'string') ? booking.duration : '');
                }

                var isGroup = !!booking.client_group_id;
                var iconSingle = document.getElementById('bookingHoverPopoverClientIconSingle');
                var iconGroup = document.getElementById('bookingHoverPopoverClientIconGroup');
                if (iconSingle && iconGroup) {
                    iconSingle.style.display = isGroup ? 'none' : '';
                    iconGroup.style.display = isGroup ? '' : 'none';
                }
                if (clientNameEl) {
                    if (isGroup) {
                        clientNameEl.textContent = booking.client_group_name || '';
                    } else {
                        clientNameEl.textContent = booking.client_name || '';
                    }
                }

                var simpleScenario = isSimpleScenarioName(booking.reservation_type);
                if (directionRow) {
                    directionRow.style.display = simpleScenario ? 'none' : '';
                }
                if (specialistRow) {
                    specialistRow.style.display = simpleScenario ? 'none' : '';
                }

                if (directionEl) {
                    directionEl.textContent = (typeof booking.direction_name === 'string') ? booking.direction_name : '';
                }
                if (specialistEl) {
                    specialistEl.textContent = (typeof booking.specialist_name === 'string') ? booking.specialist_name : '';
                }

                if (commentEl) {
                    var comment = (typeof booking.comment === 'string') ? booking.comment.trim() : '';
                    if (comment) {
                        commentEl.textContent = comment;
                        commentEl.style.display = '';
                    } else {
                        commentEl.textContent = '';
                        commentEl.style.display = 'none';
                    }
                }

                positionBookingHoverPopover();
            }

            async function showBookingHoverPopover(bookingId, anchorEl) {
                if (!bookingHoverPopoverEl) {
                    return;
                }

                bookingHoverPopoverActiveId = String(bookingId);
                bookingHoverPopoverEl.style.display = 'block';
                bookingHoverPopoverAnchorRect = anchorEl ? anchorEl.getBoundingClientRect() : null;
                positionBookingHoverPopover();

                var cacheKey = String(bookingId);
                if (bookingHoverPopoverCache[cacheKey]) {
                    fillBookingHoverPopover(bookingHoverPopoverCache[cacheKey]);
                    return;
                }

                try {
                    var response = await fetch(`/booking/get-booking-details/${bookingId}/`);
                    if (!response.ok) {
                        return;
                    }
                    var data = await response.json();
                    if (!data || !data.success || !data.booking) {
                        return;
                    }

                    bookingHoverPopoverCache[cacheKey] = data.booking;
                    if (bookingHoverPopoverActiveId !== cacheKey) {
                        return;
                    }
                    fillBookingHoverPopover(data.booking);
                } catch (e) {
                    return;
                }
            }

            window.addEventListener('scroll', hideBookingHoverPopover, { passive: true });
            window.addEventListener('resize', hideBookingHoverPopover, { passive: true });

            function getCurrentScenarioFromGlobals() {
                if (!window.currentScenarioFilterId || !Array.isArray(window.SCENARIOS)) {
                    return null;
                }

                var scenarioId = String(window.currentScenarioFilterId);
                return window.SCENARIOS.find(function (s) {
                    return String(s.pk) === scenarioId;
                }) || null;
            }

            function parseTimeToMinutes(timeStr) {
                if (!timeStr) {
                    return null;
                }

                // Ожидаем формат HH:MM или HH:MM:SS
                var parts = String(timeStr).split(':');
                if (parts.length < 2) {
                    return null;
                }

                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);

                if (isNaN(hours) || isNaN(minutes)) {
                    return null;
                }

                return hours * 60 + minutes;
            }

            function ensureTariffScheduleIndex() {
                if (window.__tariffScheduleIndex && window.__tariffScheduleIndex.built) {
                    return window.__tariffScheduleIndex;
                }

                var tariffs = Array.isArray(window.TARIFFS) ? window.TARIFFS : [];
                var weekly = Array.isArray(window.TARIFF_WEEKLY_INTERVALS) ? window.TARIFF_WEEKLY_INTERVALS : [];

                var intervalsByTariff = {};
                weekly.forEach(function (it) {
                    if (!it || it.pk === undefined || it.pk === null || !it.fields) {
                        return;
                    }
                    var tariffId = it.fields.tariff;
                    if (tariffId === undefined || tariffId === null) {
                        return;
                    }
                    var weekday = parseInt(it.fields.weekday, 10);
                    var startMin = parseTimeToMinutes(it.fields.start_time);
                    var endMin = parseTimeToMinutes(it.fields.end_time);
                    if (!Number.isFinite(weekday) || startMin === null || endMin === null) {
                        return;
                    }
                    if (!intervalsByTariff[String(tariffId)]) {
                        intervalsByTariff[String(tariffId)] = [];
                    }
                    intervalsByTariff[String(tariffId)].push([weekday, startMin, endMin]);
                });
                var intervalsByKeyWeekday = {};

                tariffs.forEach(function (t) {
                    if (!t || t.pk === undefined || t.pk === null || !t.fields) {
                        return;
                    }
                    if (t.fields.active === false) {
                        return;
                    }

                    var scenarioIds = Array.isArray(t.fields.scenarios) ? t.fields.scenarios : [];
                    var roomIds = Array.isArray(t.fields.rooms) ? t.fields.rooms : [];
                    if (!scenarioIds.length || !roomIds.length) {
                        return;
                    }

                    var tIntervals = intervalsByTariff[String(t.pk)] || [];
                    if (!tIntervals.length) {
                        return;
                    }

                    tIntervals.forEach(function (row) {
                        var weekday = row[0];
                        var startMin = row[1];
                        var endMin = row[2];

                        scenarioIds.forEach(function (sid) {
                            roomIds.forEach(function (rid) {
                                var key = String(sid) + '|' + String(rid) + '|' + String(weekday);
                                if (!intervalsByKeyWeekday[key]) {
                                    intervalsByKeyWeekday[key] = [];
                                }
                                intervalsByKeyWeekday[key].push([startMin, endMin]);
                            });
                        });
                    });
                });

                Object.keys(intervalsByKeyWeekday).forEach(function (k) {
                    var arr = intervalsByKeyWeekday[k];
                    arr.sort(function (a, b) { return a[0] - b[0]; });
                    var merged = [];
                    arr.forEach(function (it) {
                        if (!merged.length) {
                            merged.push([it[0], it[1]]);
                            return;
                        }
                        var last = merged[merged.length - 1];
                        if (it[0] <= last[1]) {
                            last[1] = Math.max(last[1], it[1]);
                        } else {
                            merged.push([it[0], it[1]]);
                        }
                    });
                    intervalsByKeyWeekday[k] = merged;
                });

                window.__tariffScheduleIndex = {
                    built: true,
                    intervalsByKeyWeekday: intervalsByKeyWeekday,
                    weekdayCache: {},
                };

                return window.__tariffScheduleIndex;
            }

            function getPythonWeekday(dateIso) {
                if (!dateIso) {
                    return null;
                }
                var idx = ensureTariffScheduleIndex();
                if (idx.weekdayCache[dateIso] !== undefined) {
                    return idx.weekdayCache[dateIso];
                }
                var d = new Date(String(dateIso) + 'T00:00:00');
                if (isNaN(d.getTime())) {
                    idx.weekdayCache[dateIso] = null;
                    return null;
                }
                var jsDay = d.getDay();
                var pyDay = (jsDay + 6) % 7;
                idx.weekdayCache[dateIso] = pyDay;
                return pyDay;
            }

            function isCellAllowedByTariffSchedule(scenarioId, roomId, dateIso, cellMinutes) {
                if (!scenarioId || !roomId || !dateIso || cellMinutes === null || cellMinutes === undefined) {
                    return false;
                }
                var idx = ensureTariffScheduleIndex();
                var baseKey = String(scenarioId) + '|' + String(roomId);
                var weekday = getPythonWeekday(dateIso);
                if (weekday === null) {
                    return false;
                }
                var key = baseKey + '|' + String(weekday);
                var intervals = idx.intervalsByKeyWeekday[key] || [];
                for (var i = 0; i < intervals.length; i++) {
                    var s = intervals[i][0];
                    var e = intervals[i][1];
                    if (cellMinutes >= s && cellMinutes < e) {
                        return true;
                    }
                }
                return false;
            }

            function resetScenarioRestrictionsForAllCells() {
                roomCells.forEach(function (cell) {
                    if (cell.classList.contains('booked')) {
                        return;
                    }

                    if (cell.dataset.originalOnclick && !cell.getAttribute('onclick')) {
                        cell.setAttribute('onclick', cell.dataset.originalOnclick);
                    }

                    cell.classList.add('available');
                    cell.style.backgroundColor = '';
                    cell.style.cursor = '';
                });
            }

            function applyScenarioWorkTimeRestrictions() {
                var scenario = getCurrentScenarioFromGlobals();

                // Если сценарий не выбран или нет данных по времени работы — ничего не ограничиваем
                if (!scenario || !scenario.fields) {
                    resetScenarioRestrictionsForAllCells();
                    return;
                }

                var fields = scenario.fields || {};
                var scenarioName = (typeof fields.name === 'string') ? fields.name.trim() : '';
                var isSimpleScenario = isSimpleScenarioName(scenarioName);
                var startMinutes = parseTimeToMinutes(fields.work_time_start);
                var endMinutes = parseTimeToMinutes(fields.work_time_end);

                if (startMinutes === null || endMinutes === null) {
                    if (!isSimpleScenario) {
                        resetScenarioRestrictionsForAllCells();
                        return;
                    }
                }

                roomCells.forEach(function (cell) {
                    // Забронированные ячейки не трогаем, их поведение определяется логикой броней
                    if (cell.classList.contains('booked')) {
                        return;
                    }

                    var dtStr = cell.getAttribute('full_datetime');
                    if (!dtStr) {
                        return;
                    }

                    var dtParts = dtStr.split(' ');
                    if (dtParts.length < 2) {
                        return;
                    }

                    var dateIso = dtParts[0];
                    var cellMinutes = parseTimeToMinutes(dtParts[1]);
                    if (cellMinutes === null) {
                        return;
                    }

                    var insideInterval = true;
                    if (startMinutes !== null && endMinutes !== null) {
                        if (endMinutes > startMinutes) {
                            insideInterval = cellMinutes >= startMinutes && cellMinutes < endMinutes;
                        } else if (endMinutes < startMinutes) {
                            insideInterval = cellMinutes >= startMinutes || cellMinutes < endMinutes;
                        } else {
                            insideInterval = false;
                        }
                    }

                    var insideTariffInterval = true;
                    if (isSimpleScenario) {
                        var roomId = cell.getAttribute('room_id');
                        insideTariffInterval = isCellAllowedByTariffSchedule(scenario.pk, roomId, dateIso, cellMinutes);
                    }

                    if (!insideInterval || !insideTariffInterval) {
                        // Вне рабочего интервала сценария — отключаем клик и красим ячейку
                        cell.classList.remove('available');
                        cell.style.backgroundColor = '#EBEBEC';
                        cell.style.cursor = 'default';
                        cell.removeAttribute('onclick');
                    } else {
                        // Внутри рабочего интервала — возвращаем доступность, если ячейка не занята
                        if (cell.dataset.originalOnclick && !cell.getAttribute('onclick')) {
                            cell.setAttribute('onclick', cell.dataset.originalOnclick);
                        }
                        cell.classList.add('available');
                        if (cell.style.backgroundColor === 'rgb(235, 235, 236)' || cell.style.backgroundColor === '#EBEBEC') {
                            cell.style.backgroundColor = '';
                        }
                        if (cell.style.cursor === 'default') {
                            cell.style.cursor = '';
                        }
                    }
                });
            }

            function updateBookedCells() {
                hideBookingHoverPopover();
                // Сначала очищаем все ячейки
                roomCells.forEach(function (cell) {
                    cell.classList.remove('highlight-cell', 'booked');
                    cell.classList.add('highlight-cell', 'available');
                    cell.style.background = '';
                    cell.style.border = '';
                    cell.style.position = '';
                    cell.style.zIndex = '';
                    // Удаляем старые booking-block если есть
                    const oldBlock = cell.querySelector('.booking-block');
                    if (oldBlock) {
                        oldBlock.remove();
                    }

                    if (cell.dataset.originalOnclick) {
                        cell.setAttribute('onclick', cell.dataset.originalOnclick);
                    }
                });

                // Обрабатываем бронирования
                bookingsInRange.forEach(function (booking) {
                    var startTime = new Date(booking.blocks_datetime_range[0]);
                    var endTime = new Date(booking.blocks_datetime_range[booking.blocks_datetime_range.length - 1]);

                    // Находим все ячейки для текущего бронирования
                    var bookingCells = [];
                    var firstCell = null;

                    roomCells.forEach(function (cell) {
                        if (cell.getAttribute('room_name') === booking.room_name) {
                            var cellTime = new Date(cell.getAttribute('full_datetime'));

                            if (cellTime >= startTime && cellTime < endTime) {
                                cell.classList.remove('available');
                                cell.classList.add('booked');

                                // Убираем обработчик открытия модалки с занятой ячейки
                                cell.removeAttribute('onclick');


                                if (!firstCell) {
                                    firstCell = cell;
                                }
                                bookingCells.push(cell);
                            }
                        }
                    });

                    // Если нашли ячейки для бронирования
                    if (firstCell && bookingCells.length > 0) {
                        const lastCell = bookingCells[bookingCells.length - 1];
                        const firstRect = firstCell.getBoundingClientRect();
                        const lastRect = lastCell.getBoundingClientRect();
                        // Реальная ширина от левого края первой до правого края последней ячейки минус отступы
                        const fullWidth = lastRect.right - firstRect.left;
                        // 7px для симметричных отступов (компенсация субпиксельного округления)
                        const totalWidth = Math.max(fullWidth - 7, 0);
                        // Создаем один общий блок бронирования
                        const bookingBlock = createBookingBlock(booking, totalWidth, firstCell);
                        firstCell.style.position = 'relative';
                        firstCell.style.zIndex = '1';

                        // Добавляем блок в первую ячейку
                        firstCell.appendChild(bookingBlock);
                    }
                });

                // После отрисовки броней применяем ограничения по времени работы выбранного сценария
                applyScenarioWorkTimeRestrictions();
            }

            function createBookingBlock(booking, blockWidth, firstCell) {
                const block = document.createElement('div');
                block.className = 'booking-block';
                block.setAttribute('data-booking-id', booking.id);
                
                // Учитываем border ячейки: left отсчитывается от padding edge (внутри border)
                const cellStyle = getComputedStyle(firstCell);
                const borderLeft = parseFloat(cellStyle.borderLeftWidth) || 0;
                
                // Чтобы визуальный отступ от внешнего края был 3px, left = 3 - borderLeft
                block.style.left = (3 - borderLeft) + 'px';
                block.style.width = blockWidth + 'px';

                if (booking && Number(booking.status_id) === 1079) {
                    block.classList.add('booking-block--status-1079');
                }

                if (booking && typeof booking.comment === 'string' && booking.comment.trim()) {
                    block.classList.add('booking-block--has-comment');
                }

                var currentScenarioId = window.currentScenarioFilterId ? Number(window.currentScenarioFilterId) : null;
                var bookingScenarioId = booking && booking.scenario_id !== undefined && booking.scenario_id !== null
                    ? Number(booking.scenario_id)
                    : null;
                var isOtherScenario = currentScenarioId !== null && bookingScenarioId !== null && bookingScenarioId !== currentScenarioId;

                if (isOtherScenario) {
                    block.classList.add('booking-block--other-scenario');
                    block.style.cursor = 'default';
                } else {
                    block.style.cursor = 'pointer';
                    block.onclick = function (event) {
                        event.stopPropagation();
                        window.currentBookingId = booking.id;
                        openInfoModal();
                    };

                    block.addEventListener('mouseenter', function (event) {
                        event.stopPropagation();
                        showBookingHoverPopover(booking.id, block);
                    });
                    block.addEventListener('mouseleave', function () {
                        hideBookingHoverPopover();
                    });
                }

                return block;
            }

            function assignParentAttributes() {
                var tables = document.querySelectorAll('table');
                tables.forEach(function (table) {
                    var tableId = table.id;
                    var rows = table.querySelectorAll('tr');
                    rows.forEach(function (row) {
                        row.setAttribute('parent_table_id', tableId);
                        var cells = row.querySelectorAll('td');
                        cells.forEach(function (cell) {
                            cell.setAttribute('parent_table_id', tableId);
                            cell.setAttribute('parent_row_id', row.id);
                            var tableRowSelectors = `#${tableId} #${row.id} td`;
                            cell.setAttribute('table_row_selectors', tableRowSelectors);
                        });
                    });
                });
            }

            // Задержка чтобы таблица успела отрендериться и размеры были корректны
            setTimeout(function() {
                updateBookedCells();
                assignParentAttributes();
            }, 50);

            let resizeTimeout = null;
            window.addEventListener('resize', function () {
                if (resizeTimeout) {
                    clearTimeout(resizeTimeout);
                }
                resizeTimeout = setTimeout(function () {
                    updateBookedCells();
                }, 150);
            });

            // Периодическое обновление сетки календаря (пуллинг раз в 5 секунд)
            async function refreshBookingsGrid(options) {
                const opts = options || {};

                const params = new URLSearchParams({
                    date_from: window.SHOW_DATE_FROM,
                    date_to: window.SHOW_DATE_TO,
                });

                if (window.currentAreaFilterId) {
                    params.append('area_id', window.currentAreaFilterId);
                }

                try {
                    const response = await fetch(`/booking/bookings-grid/?${params.toString()}`);
                    if (!response.ok) {
                        console.error('Ошибка обновления сетки бронирований:', response.status);
                        return;
                    }

                    const data = await response.json();
                    if (!data.success || !Array.isArray(data.bookings_in_range)) {
                        console.error('Некорректный ответ при обновлении сетки бронирований:', data);
                        return;
                    }

                    bookingsInRange = data.bookings_in_range;
                    updateBookedCells();
                } catch (error) {
                    console.error('Сетевая ошибка при обновлении сетки бронирований:', error);
                }
            }

            async function reloadCalendarGridForCurrentState() {
                const params = new URLSearchParams({
                    date_from: window.SHOW_DATE_FROM,
                    date_to: window.SHOW_DATE_TO,
                });

                if (window.currentAreaFilterId) {
                    params.append('area_id', window.currentAreaFilterId);
                }

                try {
                    const response = await fetch(`/booking/calendar-grid/?${params.toString()}`);
                    if (!response.ok) {
                        console.error('Ошибка обновления календарной сетки:', response.status);
                        return;
                    }

                    const data = await response.json();
                    if (!data.success || typeof data.html !== 'string' || !Array.isArray(data.bookings_in_range)) {
                        console.error('Некорректный ответ при обновлении календарной сетки:', data);
                        return;
                    }

                    var container = document.getElementById('calendar-grid-container');
                    if (!container) {
                        return;
                    }

                    container.innerHTML = data.html;
                    bookingsInRange = data.bookings_in_range;

                    initializeCalendarGridState();

                    // После замены HTML ждём окончания рендера и пересчитываем бронь/атрибуты
                    setTimeout(function () {
                        updateBookedCells();
                        assignParentAttributes();
                    }, 50);
                } catch (error) {
                    console.error('Сетевая ошибка при обновлении календарной сетки:', error);
                }
            }

            function showCalendarLoadingOverlay() {
                var overlay = document.getElementById('calendar-loading-overlay');
                if (overlay) {
                    overlay.classList.add('is-visible');
                }
            }

            function hideCalendarLoadingOverlay() {
                var overlay = document.getElementById('calendar-loading-overlay');
                if (overlay) {
                    overlay.classList.remove('is-visible');
                }
            }

            async function reloadCalendarGridForAreaChange() {
                showCalendarLoadingOverlay();
                try {
                    await reloadCalendarGridForCurrentState();
                } finally {
                    hideCalendarLoadingOverlay();
                }
            }

            // Экспортируем функции в глобальное пространство имён, чтобы вызывать из других скриптов
            window.refreshBookingsGrid = refreshBookingsGrid;
            window.reloadCalendarGridForCurrentState = reloadCalendarGridForCurrentState;
            window.reloadCalendarGridForAreaChange = reloadCalendarGridForAreaChange;

            if (typeof window.__suppressBookingsRefreshUntil !== 'number') {
                window.__suppressBookingsRefreshUntil = 0;
            }

            setInterval(function () {
                if (window.__suppressBookingsRefreshUntil && Date.now() < window.__suppressBookingsRefreshUntil) {
                    return;
                }
                refreshBookingsGrid({ silent: true });
            }, 5000);

            // Делаем функцию доступной глобально, чтобы можно было вызывать при смене фильтра сценария
            window.applyScenarioWorkTimeRestrictions = applyScenarioWorkTimeRestrictions;
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var periodTrigger = document.getElementById('calendar-period-trigger');
            var picker = document.getElementById('dateRangePicker');
            if (!periodTrigger || !picker) {
                return;
            }

            var monthGridLeft = picker.querySelector('[data-role="month-grid-left"]');
            var monthGridRight = picker.querySelector('[data-role="month-grid-right"]');
            var navPrevBtn = picker.querySelector('[data-role="nav-prev"]');
            var navNextBtn = picker.querySelector('[data-role="nav-next"]');
            var monthSelectLeft = picker.querySelector('[data-role="month-select-left"]');
            var yearSelectLeft = picker.querySelector('[data-role="year-select-left"]');
            var monthSelectRight = picker.querySelector('[data-role="month-select-right"]');
            var yearSelectRight = picker.querySelector('[data-role="year-select-right"]');
            var applyBtn = document.getElementById('dateRangeApplyBtn');
            var cancelBtn = document.getElementById('dateRangeCancelBtn');
            var presets = picker.querySelectorAll('.date-range-picker__presets-item');

            if (!monthGridLeft || !monthGridRight) {
                return;
            }

            function parseISODate(dateStr) {
                if (!dateStr) {
                    return null;
                }
                var parts = String(dateStr).split('-');
                if (parts.length !== 3) {
                    return null;
                }
                var year = parseInt(parts[0], 10);
                var month = parseInt(parts[1], 10) - 1;
                var day = parseInt(parts[2], 10);
                if (isNaN(year) || isNaN(month) || isNaN(day)) {
                    return null;
                }
                return new Date(year, month, day);
            }

            function formatISODate(date) {
                var year = date.getFullYear();
                var month = String(date.getMonth() + 1).padStart(2, '0');
                var day = String(date.getDate()).padStart(2, '0');
                return year + '-' + month + '-' + day;
            }

            function datesEqual(a, b) {
                if (!a || !b) {
                    return false;
                }
                return (
                    a.getFullYear() === b.getFullYear() &&
                    a.getMonth() === b.getMonth() &&
                    a.getDate() === b.getDate()
                );
            }

            function isInRange(date, start, end) {
                if (!start || !end) {
                    return false;
                }
                var time = date.getTime();
                return time >= start.getTime() && time <= end.getTime();
            }

            function formatHumanDateRu(date) {
                var monthNames = [
                    'января',
                    'февраля',
                    'марта',
                    'апреля',
                    'мая',
                    'июня',
                    'июля',
                    'августа',
                    'сентября',
                    'октября',
                    'ноября',
                    'декабря'
                ];
                return date.getDate() + ' ' + monthNames[date.getMonth()];
            }

            function formatMonthYearRuShort(date) {
                var monthNamesShort = [
                    'янв',
                    'фев',
                    'мар',
                    'апр',
                    'май',
                    'июн',
                    'июл',
                    'авг',
                    'сен',
                    'окт',
                    'ноя',
                    'дек'
                ];
                return monthNamesShort[date.getMonth()] + ' ' + date.getFullYear();
            }

            function fillMonthSelect(select, selectedMonthIndex) {
                if (!select) {
                    return;
                }
                var monthNamesShort = [
                    'янв',
                    'фев',
                    'мар',
                    'апр',
                    'май',
                    'июн',
                    'июл',
                    'авг',
                    'сен',
                    'окт',
                    'ноя',
                    'дек'
                ];
                select.innerHTML = '';
                for (var i = 0; i < 12; i++) {
                    var opt = document.createElement('option');
                    opt.value = String(i);
                    opt.textContent = monthNamesShort[i];
                    if (i === selectedMonthIndex) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                }
            }

            function fillYearSelect(select, selectedYear) {
                if (!select || !selectedYear) {
                    return;
                }
                var baseYear = selectedYear;
                var fromYear = baseYear - 5;
                var toYear = baseYear + 5;
                select.innerHTML = '';
                for (var y = fromYear; y <= toYear; y++) {
                    var opt = document.createElement('option');
                    opt.value = String(y);
                    opt.textContent = String(y);
                    if (y === selectedYear) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                }
            }

            function updateMonthYearControls() {
                var leftYear = currentLeftMonth.getFullYear();
                var leftMonthIndex = currentLeftMonth.getMonth();
                var rightMonthDate = new Date(currentLeftMonth.getFullYear(), currentLeftMonth.getMonth() + 1, 1);

                fillMonthSelect(monthSelectLeft, leftMonthIndex);
                fillYearSelect(yearSelectLeft, leftYear);
                fillMonthSelect(monthSelectRight, rightMonthDate.getMonth());
                fillYearSelect(yearSelectRight, rightMonthDate.getFullYear());
            }

            var appliedStartDate = parseISODate(window.SHOW_DATE_FROM);
            var appliedEndDate = parseISODate(window.SHOW_DATE_TO);

            if (!appliedStartDate || !appliedEndDate) {
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                appliedStartDate = new Date(today.getTime());
                appliedEndDate = new Date(today.getTime());
            }

            function updateActivePresetFromApplied() {
                presets.forEach(function (p) {
                    p.classList.remove('date-range-picker__presets-item--active');
                });

                if (!appliedStartDate || !appliedEndDate) {
                    return;
                }

                var today = new Date();
                today.setHours(0, 0, 0, 0);

                presets.forEach(function (item) {
                    var preset = item.getAttribute('data-preset');
                    if (!preset) {
                        return;
                    }

                    var start = new Date(today.getTime());
                    var end = new Date(today.getTime());

                    if (preset === 'today') {
                        start = new Date(today.getTime());
                        end = new Date(today.getTime());
                    } else if (preset === 'yesterday') {
                        start = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                        end = new Date(start.getTime());
                    } else if (preset === 'today_yesterday') {
                        end = new Date(today.getTime());
                        start = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    } else if (preset === 'last7') {
                        start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
                        end = new Date(today.getTime());
                    } else if (preset === 'current14') {
                        start = new Date(today.getTime());
                        end = new Date(today.getTime() + 13 * 24 * 60 * 60 * 1000);
                    } else if (preset === 'last14') {
                        start = new Date(today.getTime() - 13 * 24 * 60 * 60 * 1000);
                        end = new Date(today.getTime());
                    } else if (preset === 'last30') {
                        start = new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000);
                        end = new Date(today.getTime());
                    } else if (preset === 'this_week') {
                        // Неделя: Пн-Вс, текущая неделя
                        var dayOfWeek = today.getDay(); // 0 (Вс) - 6 (Сб)
                        var mondayOffset = (dayOfWeek + 6) % 7; // 0 для Пн, 6 для Вс
                        start = new Date(today.getTime() - mondayOffset * 24 * 60 * 60 * 1000);
                        end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
                    } else if (preset === 'last_week') {
                        var dayOfWeekLW = today.getDay();
                        var mondayOffsetLW = (dayOfWeekLW + 6) % 7;
                        var thisMonday = new Date(today.getTime() - mondayOffsetLW * 24 * 60 * 60 * 1000);
                        end = new Date(thisMonday.getTime() - 24 * 60 * 60 * 1000);
                        start = new Date(end.getTime() - 6 * 24 * 60 * 60 * 1000);
                    } else if (preset === 'this_month') {
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    } else if (preset === 'last_month') {
                        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        end = new Date(today.getFullYear(), today.getMonth(), 0);
                    } else {
                        return;
                    }

                    if (datesEqual(start, appliedStartDate) && datesEqual(end, appliedEndDate)) {
                        item.classList.add('date-range-picker__presets-item--active');
                    }
                });
            }

            var selectedStartDate = new Date(appliedStartDate.getTime());
            var selectedEndDate = new Date(appliedEndDate.getTime());

            var currentLeftMonth = new Date(appliedStartDate.getFullYear(), appliedStartDate.getMonth(), 1);

            function buildMonthGrid(gridElement, monthDate) {
                gridElement.innerHTML = '';

                var dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
                for (var i = 0; i < dayNames.length; i++) {
                    var dayNameCell = document.createElement('div');
                    dayNameCell.className = 'date-range-picker__day-name';
                    dayNameCell.textContent = dayNames[i];
                    gridElement.appendChild(dayNameCell);
                }

                var year = monthDate.getFullYear();
                var month = monthDate.getMonth();
                var firstOfMonth = new Date(year, month, 1);
                var dayOfWeek = firstOfMonth.getDay();
                var mondayBasedIndex = (dayOfWeek + 6) % 7;
                var daysInMonth = new Date(year, month + 1, 0).getDate();

                for (var j = 0; j < mondayBasedIndex; j++) {
                    var emptyCell = document.createElement('div');
                    emptyCell.className = 'date-range-picker__day date-range-picker__day--outside';
                    emptyCell.textContent = '';
                    gridElement.appendChild(emptyCell);
                }

                for (var day = 1; day <= daysInMonth; day++) {
                    (function (currentDay) {
                        var cellDate = new Date(year, month, currentDay);
                        var cell = document.createElement('div');
                        cell.className = 'date-range-picker__day';
                        cell.textContent = String(currentDay);
                        cell.setAttribute('data-date', formatISODate(cellDate));

                        if (selectedStartDate && selectedEndDate && isInRange(cellDate, selectedStartDate, selectedEndDate)) {
                            cell.classList.add('date-range-picker__day--in-range');
                        }
                        if (selectedStartDate && datesEqual(cellDate, selectedStartDate)) {
                            cell.classList.add('date-range-picker__day--selected');
                        }
                        if (selectedEndDate && datesEqual(cellDate, selectedEndDate) && !datesEqual(selectedStartDate, selectedEndDate)) {
                            cell.classList.add('date-range-picker__day--selected');
                        }

                        cell.addEventListener('click', function (event) {
                            // Останавливаем всплытие, чтобы клик по дню не закрывал попап
                            event.stopPropagation();
                            var clickedDate = parseISODate(cell.getAttribute('data-date'));
                            if (!clickedDate) {
                                return;
                            }
                            clickedDate.setHours(0, 0, 0, 0);

                            if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                                selectedStartDate = clickedDate;
                                selectedEndDate = null;
                            } else {
                                if (clickedDate.getTime() < selectedStartDate.getTime()) {
                                    selectedEndDate = new Date(selectedStartDate.getTime());
                                    selectedStartDate = clickedDate;
                                } else {
                                    selectedEndDate = clickedDate;
                                }
                            }

                            renderCalendars();
                        });

                        gridElement.appendChild(cell);
                    })(day);
                }
            }

            function renderCalendars() {
                updateMonthYearControls();
                buildMonthGrid(monthGridLeft, currentLeftMonth);
                var rightMonth = new Date(currentLeftMonth.getFullYear(), currentLeftMonth.getMonth() + 1, 1);
                buildMonthGrid(monthGridRight, rightMonth);
            }

            function updatePeriodLabelsFromApplied() {
                var startSpan = document.getElementById('start-calendar-period-text');
                var endSpan = document.getElementById('end-calendar-period-text');
                if (startSpan && appliedStartDate) {
                    startSpan.textContent = formatHumanDateRu(appliedStartDate);
                }
                if (endSpan && appliedEndDate) {
                    endSpan.textContent = formatHumanDateRu(appliedEndDate);
                }
            }

            function openPicker() {
                updateActivePresetFromApplied();
                picker.style.display = 'block';
            }

            function closePicker() {
                picker.style.display = 'none';
            }

            // Клики внутри попапа не должны закрывать его через глобальный обработчик
            picker.addEventListener('click', function (event) {
                event.stopPropagation();
            });

            if (navPrevBtn) {
                navPrevBtn.addEventListener('click', function () {
                    currentLeftMonth = new Date(currentLeftMonth.getFullYear(), currentLeftMonth.getMonth() - 1, 1);
                    renderCalendars();
                });
            }

            if (navNextBtn) {
                navNextBtn.addEventListener('click', function () {
                    currentLeftMonth = new Date(currentLeftMonth.getFullYear(), currentLeftMonth.getMonth() + 1, 1);
                    renderCalendars();
                });
            }

            if (monthSelectLeft) {
                monthSelectLeft.addEventListener('change', function () {
                    var monthIndex = parseInt(monthSelectLeft.value, 10);
                    if (isNaN(monthIndex)) {
                        return;
                    }
                    currentLeftMonth = new Date(currentLeftMonth.getFullYear(), monthIndex, 1);
                    renderCalendars();
                });
            }

            if (yearSelectLeft) {
                yearSelectLeft.addEventListener('change', function () {
                    var year = parseInt(yearSelectLeft.value, 10);
                    if (isNaN(year)) {
                        return;
                    }
                    currentLeftMonth = new Date(year, currentLeftMonth.getMonth(), 1);
                    renderCalendars();
                });
            }

            function updateLeftMonthFromRightControls() {
                if (!monthSelectRight || !yearSelectRight) {
                    return;
                }
                var monthIndex = parseInt(monthSelectRight.value, 10);
                var year = parseInt(yearSelectRight.value, 10);
                if (isNaN(monthIndex) || isNaN(year)) {
                    return;
                }
                var rightMonthDate = new Date(year, monthIndex, 1);
                currentLeftMonth = new Date(rightMonthDate.getFullYear(), rightMonthDate.getMonth() - 1, 1);
                renderCalendars();
            }

            if (monthSelectRight) {
                monthSelectRight.addEventListener('change', function () {
                    updateLeftMonthFromRightControls();
                });
            }

            if (yearSelectRight) {
                yearSelectRight.addEventListener('change', function () {
                    updateLeftMonthFromRightControls();
                });
            }

            presets.forEach(function (item) {
                item.addEventListener('click', function () {
                    presets.forEach(function (p) {
                        p.classList.remove('date-range-picker__presets-item--active');
                    });

                    item.classList.add('date-range-picker__presets-item--active');

                    var preset = item.getAttribute('data-preset');
                    var today = new Date();
                    today.setHours(0, 0, 0, 0);

                    var start = new Date(today.getTime());
                    var end = new Date(today.getTime());

                    if (preset === 'today') {
                        start = new Date(today.getTime());
                        end = new Date(today.getTime());
                    } else if (preset === 'yesterday') {
                        start = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                        end = new Date(start.getTime());
                    } else if (preset === 'today_yesterday') {
                        end = new Date(today.getTime());
                        start = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    } else if (preset === 'last7') {
                        start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
                        end = new Date(today.getTime());
                    } else if (preset === 'current14') {
                        start = new Date(today.getTime());
                        end = new Date(today.getTime() + 13 * 24 * 60 * 60 * 1000);
                    } else if (preset === 'last14') {
                        start = new Date(today.getTime() - 13 * 24 * 60 * 60 * 1000);
                        end = new Date(today.getTime());
                    } else if (preset === 'last30') {
                        start = new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000);
                        end = new Date(today.getTime());
                    } else if (preset === 'this_week') {
                        // Неделя: Пн-Вс, текущая неделя
                        var dayOfWeek = today.getDay(); // 0 (Вс) - 6 (Сб)
                        var mondayOffset = (dayOfWeek + 6) % 7; // 0 для Пн, 6 для Вс
                        start = new Date(today.getTime() - mondayOffset * 24 * 60 * 60 * 1000);
                        end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
                    } else if (preset === 'last_week') {
                        var dayOfWeekLW = today.getDay();
                        var mondayOffsetLW = (dayOfWeekLW + 6) % 7;
                        var thisMonday = new Date(today.getTime() - mondayOffsetLW * 24 * 60 * 60 * 1000);
                        end = new Date(thisMonday.getTime() - 24 * 60 * 60 * 1000);
                        start = new Date(end.getTime() - 6 * 24 * 60 * 60 * 1000);
                    } else if (preset === 'this_month') {
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    } else if (preset === 'last_month') {
                        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        end = new Date(today.getFullYear(), today.getMonth(), 0);
                    }

                    selectedStartDate = start;
                    selectedEndDate = end;

                    currentLeftMonth = new Date(start.getFullYear(), start.getMonth(), 1);
                    renderCalendars();
                });
            });

            if (applyBtn) {
                applyBtn.addEventListener('click', function () {
                    if (!selectedStartDate && !selectedEndDate) {
                        closePicker();
                        return;
                    }

                    if (selectedStartDate && !selectedEndDate) {
                        selectedEndDate = new Date(selectedStartDate.getTime());
                    }

                    appliedStartDate = new Date(selectedStartDate.getTime());
                    appliedEndDate = new Date(selectedEndDate.getTime());

                    window.SHOW_DATE_FROM = formatISODate(appliedStartDate);
                    window.SHOW_DATE_TO = formatISODate(appliedEndDate);

                    updatePeriodLabelsFromApplied();
                    closePicker();

                    if (typeof window.reloadCalendarGridForAreaChange === 'function') {
                        window.reloadCalendarGridForAreaChange();
                    } else if (typeof window.reloadCalendarGridForCurrentState === 'function') {
                        window.reloadCalendarGridForCurrentState();
                    } else if (typeof window.refreshBookingsGrid === 'function') {
                        window.refreshBookingsGrid();
                    }
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', function () {
                    selectedStartDate = new Date(appliedStartDate.getTime());
                    selectedEndDate = new Date(appliedEndDate.getTime());
                    currentLeftMonth = new Date(appliedStartDate.getFullYear(), appliedStartDate.getMonth(), 1);
                    renderCalendars();
                    closePicker();
                });
            }

            periodTrigger.addEventListener('click', function (event) {
                event.stopPropagation();
                if (picker.style.display === 'block') {
                    closePicker();
                } else {
                    selectedStartDate = new Date(appliedStartDate.getTime());
                    selectedEndDate = new Date(appliedEndDate.getTime());
                    currentLeftMonth = new Date(appliedStartDate.getFullYear(), appliedStartDate.getMonth(), 1);
                    renderCalendars();
                    openPicker();
                }
            });

            document.addEventListener('click', function (event) {
                var wrapper = document.querySelector('.calendar-period-wrapper');
                if (!wrapper) {
                    return;
                }
                if (!wrapper.contains(event.target)) {
                    closePicker();
                }
            });

            renderCalendars();
            updatePeriodLabelsFromApplied();
            updateActivePresetFromApplied();
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Поведение выпадающих списков только для фильтров в шапке календаря
            var rootEl = document.getElementById('booking-filters');
            if (!rootEl) return;
            if (!window.BookingSelectsUtils) return;

            function handleFilterSelected(filterType, value) {
                if (filterType === 'scenario') {
                    window.currentScenarioFilterId = value || null;
                    if (typeof window.applyScenarioWorkTimeRestrictions === 'function') {
                        window.applyScenarioWorkTimeRestrictions();
                    }
                    if (typeof window.refreshBookingsGrid === 'function') {
                        window.refreshBookingsGrid();
                    }
                } else if (filterType === 'area') {
                    window.currentAreaFilterId = value || null;
                    if (typeof window.reloadCalendarGridForAreaChange === 'function') {
                        window.reloadCalendarGridForAreaChange();
                    } else if (typeof window.reloadCalendarGridForCurrentState === 'function') {
                        window.reloadCalendarGridForCurrentState();
                    } else if (typeof window.refreshBookingsGrid === 'function') {
                        window.refreshBookingsGrid();
                    }
                }
            }

            function closeAll() {
                rootEl.querySelectorAll('.custom-select.open').forEach(function (s) {
                    s.classList.remove('open');
                });
            }

            if (typeof window.BookingSelectsUtils.ensureCloseOnOutsideClick === 'function') {
                window.BookingSelectsUtils.ensureCloseOnOutsideClick({
                    key: 'bookingFilters',
                    rootEl: rootEl
                });
            }

            rootEl.querySelectorAll('.custom-select').forEach(function (selectEl) {
                var filterType = selectEl.getAttribute('data-filter-type');
                if (!filterType) return;

                if (typeof window.BookingSelectsUtils.bindSingleSelect === 'function') {
                    window.BookingSelectsUtils.bindSingleSelect({
                        selectEl: selectEl,
                        closeAll: closeAll,
                        closeOthersOnOpen: true,
                        onSelected: function (ctx) {
                            handleFilterSelected(filterType, ctx ? ctx.value : null);
                        }
                    });
                }

                var optionsEl = selectEl.querySelector('ul.options');
                var firstOption = optionsEl ? optionsEl.querySelector('li') : null;
                if (firstOption && (filterType === 'area' || filterType === 'scenario')) {
                    if (typeof window.BookingSelectsUtils.selectOption === 'function') {
                        window.BookingSelectsUtils.selectOption({
                            selectEl: selectEl,
                            optionEl: firstOption,
                            onSelected: function (ctx) {
                                if (filterType === 'scenario') {
                                    handleFilterSelected(filterType, ctx ? ctx.value : null);
                                } else if (filterType === 'area') {
                                    window.currentAreaFilterId = (ctx && ctx.value) ? ctx.value : null;
                                }
                            }
                        });
                    }
                }
            });
        });
    </script>

    <script>
        (function () {
            const appBackdrop = document.getElementById('app-modal-backdrop');
            if (!appBackdrop) {
                return;
            }

            const NO_BACKDROP_CLOSE_IDS = ['confirmCancelActionModal', 'clientAddedSuccessModal', 'bookingAddedSuccessModal', 'deleteBookingModal'];
            let hideTimeoutId = null;

            function showAppBackdrop() {
                if (hideTimeoutId) {
                    clearTimeout(hideTimeoutId);
                    hideTimeoutId = null;
                }
                appBackdrop.classList.add('is-visible');
            }

            function hasOpenModals() {
                var shownModals = document.querySelectorAll('.modal.show');
                return shownModals.length > 0;
            }

            function scheduleHideBackdrop() {
                if (hideTimeoutId) {
                    clearTimeout(hideTimeoutId);
                }
                hideTimeoutId = setTimeout(function () {
                    if (!hasOpenModals()) {
                        appBackdrop.classList.remove('is-visible');
                    }
                }, 100);
            }

            window.updateAppBackdrop = function() {
                if (hasOpenModals()) {
                    showAppBackdrop();
                } else {
                    scheduleHideBackdrop();
                }
            };

            function isConfirmCancelActionModalOpen() {
                const confirmModal = document.getElementById('confirmCancelActionModal');
                return !!(confirmModal && confirmModal.classList.contains('show'));
            }

            function findTopmostClosableModal() {
                if (isConfirmCancelActionModalOpen()) {
                    return null;
                }

                const shownModals = Array.prototype.slice.call(document.querySelectorAll('.modal.show'));
                if (!shownModals.length) {
                    return null;
                }

                shownModals.sort(function (a, b) {
                    const za = parseInt(window.getComputedStyle(a).zIndex || '0', 10);
                    const zb = parseInt(window.getComputedStyle(b).zIndex || '0', 10);
                    return za - zb;
                });

                for (let i = shownModals.length - 1; i >= 0; i--) {
                    const modal = shownModals[i];
                    if (!NO_BACKDROP_CLOSE_IDS.includes(modal.id)) {
                        return modal;
                    }
                }
                return null;
            }

            document.querySelectorAll('.modal').forEach(function (modal) {
                modal.addEventListener('show.bs.modal', function () {
                    showAppBackdrop();
                });

                modal.addEventListener('hidden.bs.modal', function () {
                    scheduleHideBackdrop();
                });

                // Клик по серой области внутри конкретной модалки = попытка её закрыть
                modal.addEventListener('mousedown', function (event) {
                    if (event.target !== modal) {
                        return;
                    }
                    if (isConfirmCancelActionModalOpen()) {
                        return;
                    }
                    if (NO_BACKDROP_CLOSE_IDS.includes(modal.id)) {
                        return;
                    }
                    const instance = bootstrap.Modal.getOrCreateInstance(modal);
                    instance.hide();
                });
            });

            // Клик по общему app-бэкдропу закрывает верхнюю доступную модалку
            appBackdrop.addEventListener('click', function () {
                if (isConfirmCancelActionModalOpen()) {
                    return;
                }
                const targetModal = findTopmostClosableModal();
                if (!targetModal) {
                    return;
                }
                const instance = bootstrap.Modal.getOrCreateInstance(targetModal);
                instance.hide();
            });
        })();
    </script>

    <script>
        function openCreateModal(date, time, roomName, roomId, element) {
            var createModalElement = document.getElementById('createBookingModal');
            if (!createModalElement) {
                return;
            }

            if (typeof openModal === 'function') {
                openModal(date, time, roomName, roomId, element);
            }

            var createModal = bootstrap.Modal.getInstance(createModalElement) || new bootstrap.Modal(createModalElement);
            createModal.show();
        }
    </script>

    <script>
        function isBookingFullyPaid(bookingData) {
            if (!bookingData || bookingData.remaining_amount === undefined || bookingData.remaining_amount === null) {
                return false;
            }

            var remainingRaw = String(bookingData.remaining_amount);
            var remaining = parseFloat(remainingRaw.replace(',', '.'));
            if (isNaN(remaining)) {
                return false;
            }

            return remaining <= 0;
        }

        function updateInfoModalPaymentButtonState(bookingData) {
            var paymentButton = document.getElementById('infoPaymentButton');
            if (!paymentButton) {
                return;
            }

            if (isBookingFullyPaid(bookingData)) {
                paymentButton.textContent = 'Оплачено';
                paymentButton.classList.remove('button-primary');
                paymentButton.classList.add('button-sec');
                paymentButton.disabled = true;
                paymentButton.setAttribute('aria-disabled', 'true');
                paymentButton.onclick = null;
            } else {
                paymentButton.textContent = 'Внести оплату';
                paymentButton.classList.remove('button-sec');
                paymentButton.classList.add('button-primary');
                paymentButton.disabled = false;
                paymentButton.removeAttribute('aria-disabled');
                paymentButton.onclick = function () {
                    switchToPaymentModal();
                };
            }
        }

        async function openInfoModal() {
            var infoModalElement = document.getElementById('infoBookingModal');
            if (!infoModalElement) {
                return;
            }

            var bookingId = window.currentBookingId;
            if (bookingId) {
                try {
                    var response = await fetch(`/booking/get-booking-details/${bookingId}/`);
                    if (response.ok) {
                        var data = await response.json();
                        if (data.success && data.booking) {
                            var booking = data.booking;

                            var scenarioElement = infoModalElement.querySelector('#scenarioName');
                            var roomElement = infoModalElement.querySelector('#roomName');
                            var publicIdElement = infoModalElement.querySelector('#publicID');
                            var dateElement = infoModalElement.querySelector('#infoBookingDate');
                            var timeElement = infoModalElement.querySelector('#infoBookingTime');
                            var durationElement = infoModalElement.querySelector('#infoBookingDuration');
                            var directionElement = infoModalElement.querySelector('#infoBookingDirection');
                            var specialistElement = infoModalElement.querySelector('#infoBookingSpecialist');
                            var specialistServiceElement = infoModalElement.querySelector('#infoBookingSpecialistService');
                            var clientNameElement = infoModalElement.querySelector('#infoBookingClientName');
                            var clientPhoneElement = infoModalElement.querySelector('#infoBookingClientPhone');
                            var commentContainer = infoModalElement.querySelector('#infoBookingCommentContainer');
                            var commentTextElement = infoModalElement.querySelector('#infoBookingCommentText');
                            var totalAmountElement = infoModalElement.querySelector('#infoBookingTotalAmount');
                            var paidAmountElement = infoModalElement.querySelector('#infoBookingPaidAmount');
                            var peopleCountElement = infoModalElement.querySelector('#infoPeopleCountValue');

                            if (scenarioElement && typeof booking.reservation_type === 'string') {
                                scenarioElement.textContent = booking.reservation_type;
                            }
                            if (roomElement && typeof booking.room_name === 'string') {
                                roomElement.textContent = booking.room_name;
                            }

                            if (publicIdElement && (typeof booking.id === 'number' || typeof booking.id === 'string')) {
                                publicIdElement.textContent = booking.id;
                            }

                            if (dateElement && typeof booking.date === 'string') {
                                dateElement.textContent = booking.date;
                            }

                            if (timeElement && typeof booking.time === 'string') {
                                timeElement.textContent = booking.time + ' / ';
                            }

                            if (durationElement && typeof booking.duration === 'string') {
                                durationElement.textContent = booking.duration;
                            }

                            if (peopleCountElement) {
                                peopleCountElement.textContent = (booking.people_count !== undefined && booking.people_count !== null && String(booking.people_count).trim() !== '')
                                    ? String(booking.people_count)
                                    : '—';
                            }

                            if (directionElement && typeof booking.direction_name === 'string') {
                                directionElement.textContent = booking.direction_name;
                            }

                            if (specialistElement && typeof booking.specialist_name === 'string') {
                                specialistElement.textContent = booking.specialist_name;
                            }

                            if (specialistServiceElement) {
                                specialistServiceElement.textContent = (typeof booking.specialist_service_name === 'string' && booking.specialist_service_name)
                                    ? booking.specialist_service_name
                                    : '';
                            }

                            if (clientNameElement && typeof booking.client_name === 'string') {
                                clientNameElement.textContent = booking.client_name;
                            }

                            if (clientPhoneElement) {
                                if (typeof booking.client_phone === 'string' && booking.client_phone) {
                                    var rawPhone = booking.client_phone.replace(/\s+/g, '');
                                    var formattedPhone = booking.client_phone;
                                    var match = rawPhone.match(/^(\+375)(\d{2})(\d{3})(\d{2})(\d{2})$/);
                                    if (match) {
                                        formattedPhone = match[1] + ' ' + match[2] + ' ' + match[3] + ' ' + match[4] + ' ' + match[5];
                                    }
                                    clientPhoneElement.textContent = formattedPhone;
                                } else {
                                    clientPhoneElement.textContent = '';
                                }
                            }

                            if (totalAmountElement && typeof booking.total_cost === 'string') {
                                var totalRaw = booking.total_cost;
                                var totalNum = Number(totalRaw.replace(',', '.'));
                                if (!isNaN(totalNum)) {
                                    var totalStr;
                                    if (Math.abs(totalNum % 1) < 1e-9) {
                                        totalStr = totalNum.toFixed(0);
                                    } else {
                                        totalStr = totalNum.toFixed(2);
                                    }
                                    totalAmountElement.textContent = totalStr;
                                } else {
                                    totalAmountElement.textContent = totalRaw;
                                }
                            }

                            if (paidAmountElement && typeof booking.paid_amount === 'string') {
                                var paidRaw = booking.paid_amount;
                                var paidNum = Number(paidRaw.replace(',', '.'));
                                if (!isNaN(paidNum)) {
                                    var paidStr;
                                    if (Math.abs(paidNum % 1) < 1e-9) {
                                        paidStr = paidNum.toFixed(0);
                                    } else {
                                        paidStr = paidNum.toFixed(2);
                                    }
                                    paidAmountElement.textContent = paidStr;
                                } else {
                                    paidAmountElement.textContent = paidRaw;
                                }
                            }

                            if (commentContainer && commentTextElement) {
                                var comment = booking.comment;
                                if (typeof comment === 'string' && comment.trim()) {
                                    commentTextElement.textContent = comment;
                                    commentContainer.style.display = '';
                                } else {
                                    commentTextElement.textContent = '';
                                    commentContainer.style.display = 'none';
                                }
                            }

                            // Заполняем название группы (для Репточки)
                            var groupNameElement = infoModalElement.querySelector('#infoBookingGroupName');
                            if (groupNameElement && booking.client_group_name) {
                                groupNameElement.textContent = booking.client_group_name;
                            }

                            // Адаптируем модалку под сценарий
                            var isGroup = !!booking.client_group_id;
                            if (typeof window.adaptInfoModalForScenario === 'function') {
                                window.adaptInfoModalForScenario(booking.reservation_type, isGroup);
                            }

                            // Отображаем услуги брони
                            renderInfoModalServices(infoModalElement, booking.services_by_group);

                            updateInfoModalPaymentButtonState(booking);
                        }
                    } else {
                        console.error('Не удалось получить детали брони для info-модалки:', response.status);
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке деталей брони для info-модалки:', error);
                }
            }

            var infoModal = new bootstrap.Modal(infoModalElement);
            infoModal.show();
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function deleteCurrentBooking() {
            var bookingId = window.currentBookingId;
            if (!bookingId) {
                return;
            }

            try {
                var response = await fetch(`/booking/delete/${bookingId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                var data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error((data && data.error) ? data.error : 'Не удалось удалить бронь');
                }

                var infoModalEl = document.getElementById('infoBookingModal');
                var infoModal = infoModalEl ? bootstrap.Modal.getInstance(infoModalEl) : null;
                if (infoModal) {
                    infoModal.hide();
                }

                if (typeof window.refreshBookingsGrid === 'function') {
                    await window.refreshBookingsGrid({ silent: true });
                }
            } catch (error) {
                console.error('Ошибка при удалении брони:', error);
                Swal.fire({
                    title: 'Ошибка!',
                    text: error.message || 'Ошибка при удалении брони',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var deleteBtn = document.getElementById('infoDeleteButton');
            if (!deleteBtn) {
                return;
            }

            deleteBtn.addEventListener('click', function () {
                if (!window.currentBookingId) {
                    return;
                }
                if (typeof window.openDeleteBookingModal === 'function') {
                    window.openDeleteBookingModal();
                }
            });
        });
    </script>

</body>

</html>
{% load custom_filters %}
{% load static %}

<!-- Маппинг услуга преподавателя → список ID специалистов, которые её оказывают -->
<p id="edit_specialist_service_to_specialists_json" style="display: none;">{{ specialist_service_to_specialists_json }}</p>

<!-- Модальное окно редактирования брони -->
<div class="modal fade" id="editBookingModal" tabindex="-1" aria-labelledby="editBookingModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered" style="max-width:none; width: 63vw;">
        <div class="modal-content">
            <div class="modal-body">
                <form id="editBookingForm" action="javascript:void(0);" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <!--Кнопка возврата, заголовок и крестик-->
                        <div class="row d-flex align-items-center mb-1">
                            <div class="col-md-12 d-flex justify-content-between align-items-center">
                                <div class="d-flex justify-content-start align-items-center gap-3">
                                    <button type="button" class="button-third" onclick="switchToInfoFromEditModal()">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 19L5 12L12 5" stroke="#7A52FF" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                            <path d="M19 12H5" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round" />
                                        </svg>
                                    </button>
                                    <h2 class="mb-0">Редактирование брони</h2>
                                </div>

                                <div class="d-flex align-items-center gap-3">
                                    <div id="publicIdContainer" class="d-flex align-items-end">
                                        <span>ID:</span>
                                        <span id="publicID" class="ms-2">123456</span>
                                    </div>
                                    <button type="button" class="modal-close-icon" onclick="switchToInfoFromEditModal()"
                                        aria-label="Закрыть">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 6L6 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round" />
                                            <path d="M6 6L18 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!--Подзаголовок-->
                        <div class="row mb-4">
                            <div class="col-md-12 align-items-center justify-content-start" id="infoBookingContainer">
                                <span id="scenarioName">Название сценария</span> /
                                <span id="clientName">Имя клиента</span> /
                                <span id="clientPhone">Номер телефона</span> /
                                <span id="clientAbonement">Абонемент</span>
                            </div>
                        </div>

                        <!--Направление и комната-->
                        <div class="row mb-4" id="edit-direction-room-row">
                            <!-- Выпадающий список "Направление" (скрывается для Репточки и Музкласса) -->
                            <div class="col-md-6" id="edit-direction-container">
                                <label for="edit-direction" class="form-label">Направление</label>
                                <div class="custom-select custom-select--clearable" id="edit-direction" name="edit-direction" data-placeholder="Выберите направление">
                                    <span class="selected">Выберите направление</span>
                                    <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                        {% for direction in directions %}
                                            <li data-value="{{ direction.id }}">{{ direction.name }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!-- Выпадающий список "Комната" -->
                            <div class="col-md-6" id="edit-room-container">
                                <label for="edit-room" class="form-label">Комната</label>
                                <div class="custom-select" id="edit-room" name="edit-room">
                                    <span class="selected">Выберите комнату</span>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                        {% for room in rooms %}
                                            <li data-value="{{ room.id }}">{{ room.name }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!-- Контактное лицо (для Репточки) -->
                            <div class="col-md-3" id="edit-contact-person-field-container" style="display: none;">
                                <label for="edit-contact-person" class="form-label">Контактное лицо</label>
                                <div class="custom-select disabled" id="edit-contact-person" name="edit-contact-person">
                                    <span class="selected">Контактное лицо</span>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options"></ul>
                                </div>
                            </div>

                            <!-- Количество людей (для Репточки и Музкласса) -->
                            <div class="col-md-3" id="edit-people-count-field-container" style="display: none;">
                                <label for="edit-people-count" class="form-label">Количество людей</label>
                                <input
                                    class="payment-value-input"
                                    id="edit-people-count"
                                    name="edit-people-count"
                                    type="text"
                                    inputmode="numeric"
                                    maxlength="2"
                                    autocomplete="off"
                                />
                            </div>
                        </div>

                        <!--Дата, время, длительность-->
                        <div class="row mb-3">
                            <!--Календарь дата-->
                            <div class="col-md-3">
                                <label for="edit-date" class="form-label">Дата</label>
                                <div class="modal-datepicker" id="edit-modal-datepicker">
                                    <input type="hidden" id="edit-date" name="edit-date" />
                                    <div class="modal-datepicker__trigger" id="edit-datepicker-trigger">
                                        <span id="edit-datepicker-display">Выберите дату</span>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <rect x="3" y="4" width="18" height="18" rx="2" stroke="#818EA2" stroke-width="2"/>
                                            <path d="M16 2V6" stroke="#818EA2" stroke-width="2" stroke-linecap="round"/>
                                            <path d="M8 2V6" stroke="#818EA2" stroke-width="2" stroke-linecap="round"/>
                                            <path d="M3 10H21" stroke="#818EA2" stroke-width="2"/>
                                        </svg>
                                    </div>
                                    <div class="modal-datepicker__popup" id="edit-datepicker-popup">
                                        <div class="modal-datepicker__header">
                                            <button type="button" class="modal-datepicker__nav-btn" id="edit-datepicker-prev">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                            <div class="modal-datepicker__selects">
                                                <select class="modal-datepicker__select" id="edit-datepicker-month"></select>
                                                <select class="modal-datepicker__select" id="edit-datepicker-year"></select>
                                            </div>
                                            <button type="button" class="modal-datepicker__nav-btn" id="edit-datepicker-next">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="modal-datepicker__weekdays">
                                            <div class="modal-datepicker__weekday">Пн</div>
                                            <div class="modal-datepicker__weekday">Вт</div>
                                            <div class="modal-datepicker__weekday">Ср</div>
                                            <div class="modal-datepicker__weekday">Чт</div>
                                            <div class="modal-datepicker__weekday">Пт</div>
                                            <div class="modal-datepicker__weekday">Сб</div>
                                            <div class="modal-datepicker__weekday">Вс</div>
                                        </div>
                                        <div class="modal-datepicker__grid" id="edit-datepicker-grid"></div>
                                        <div class="modal-datepicker__footer">
                                            <button type="button" class="modal-datepicker__today-btn" id="edit-datepicker-today">Сегодня</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!--Выпадающий список Время начала-->
                            <div class="col-md-3">
                                <label for="edit-start-time" class="form-label">Время начала</label>
                                <div class="custom-select custom-select--clearable" id="edit-start-time" name="edit-start-time" data-placeholder="Выберите время">
                                    <span class="selected">Выберите время</span>
                                    <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                    <span id="edit-start-time-warning-icon" class="start-time-warning-icon" style="display: none;">
                                        <span class="warning-tooltip">Это время начала недоступно для выбранной даты.</span>
                                        ⚠
                                    </span>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                    </ul>
                                </div>
                            </div>

                            <!--Выпадающий список Время окончания-->
                            <div class="col-md-3">
                                <label for="edit-end-time" class="form-label">Время окончания</label>
                                <div class="custom-select custom-select--clearable" id="edit-end-time" name="edit-end-time" data-placeholder="Выберите время">
                                    <span class="selected">Выберите время</span>
                                    <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                    <span id="edit-end-time-warning-icon" class="start-time-warning-icon" style="display: none;">
                                        <span class="warning-tooltip">Это время окончания недоступно для выбранной даты.</span>
                                        ⚠
                                    </span>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                    </ul>
                                </div>
                            </div>

                            <!--Выпадающий список Длительность-->
                            <div class="col-md-3">
                                <label for="edit-duration" class="form-label">Длительность</label>
                                <div class="custom-select custom-select--clearable" id="edit-duration" name="edit-duration" data-placeholder="Выберите длительность">
                                    <span class="selected">Выберите длительность</span>
                                    <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!--Преподаватель/Тариф и услуги-->
                        <div class="row mb-3" id="edit-teacher-services-row">
                            <!--Выпадающий список Преподаватель (скрывается для Репточки и Музкласса)-->
                            <div class="col-md-6" id="edit-teacher-container">
                                <label for="edit-teacher" class="form-label">Преподаватель</label>
                                <div class="custom-select custom-select--clearable" id="edit-teacher" name="edit-teacher" data-placeholder="Выберите преподавателя">
                                    <span class="selected">Выберите преподавателя</span>
                                    <span id="edit-teacher-warning-icon" class="teacher-warning-icon" style="display: none;">
                                        <span class="warning-tooltip">Этот преподаватель занят в выбранное время.</span>
                                        ⚠
                                    </span>
                                    <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                        {% for specialist in specialists %}
                                            {% if specialist.active %}
                                                <li data-value="{{ specialist.id }}" data-directions="{% for direction in specialist.directions.all %}{{ direction.id }}{% if not forloop.last %},{% endif %}{% endfor %}">{{ specialist.name }}</li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!--Тариф (заглушка для Репточки и Музкласса, показывается вместо Преподавателя)-->
                            <div class="col-md-6 d-none" id="edit-tariff-container">
                                <label class="form-label">Тариф</label>
                                <div class="tariff-placeholder" style="padding: 12px 16px; background: #F8F9FA; border-radius: 8px; color: #4F4F57;">
                                    <span id="editTariffValue">55 BYN/т.е.</span>
                                </div>
                            </div>

                            <!--Задача 1: Услуги преподавателей (только для сценария "Музыкальная школа", скрыт по умолчанию)-->
                            <div class="col-md-6" id="edit-specialist-service-container" style="display: none;">
                                <label for="edit-specialist-service" class="form-label">Услуги преподавателей</label>
                                <div class="custom-select custom-select--clearable" id="edit-specialist-service" name="edit-specialist-service" data-placeholder="Выберите услугу преподавателя">
                                    <span class="selected">Выберите услугу преподавателя</span>
                                    <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                        {% for specialist_service in specialist_services %}
                                            <li data-value="{{ specialist_service.id }}" data-cost="{{ specialist_service.cost|default_if_none:'0' }}" data-duration-minutes="{{ specialist_service.duration_minutes|default_if_none:'0' }}" data-name="{{ specialist_service.name }}">
                                                <span class="service-name">{{ specialist_service.name }}</span>
                                                <span class="service-cost">{{ specialist_service.cost|default_if_none:'0' }} BYN</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!--Задача 2: Переименовано из "Услуги (необязательно)" в "Дополнительные услуги"-->
                            <!--Выпадающий список со множественным выбором Дополнительные услуги-->
                            <div class="col-md-6" id="edit-services-container">
                                <label for="edit-services" class="form-label">Дополнительные услуги</label>
                                <div class="custom-select" id="edit-services" name="edit-services">
                                    <span class="selected">Выберите услугу</span>
                                    <span class="chevron">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                        </svg>
                                    </span>
                                    <ul class="options">
                                        {% for service in services %}
                                            {% if service.active %}
                                                <li data-value="{{ service.id }}" data-cost="{{ service.cost|default_if_none:'0' }}" data-scenario-id="{{ service.scenario_id|default_if_none:'' }}" data-room-id="{{ service.room_id|default_if_none:'' }}" data-name="{{ service.name }}">
                                                    <span class="service-name">{{ service.name }}</span>
                                                    <span class="service-cost">{{ service.cost|default_if_none:'0' }} BYN</span>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!--Задача 3: Отдельный ряд для "Дополнительные услуги" для сценария "Музыкальная школа" (скрыт по умолчанию)-->
                        <!--Исправление 2: используем offset-md-6 вместо пустого col-md-6 для корректной ширины-->
                        <div class="row mb-3" id="edit-additional-services-row" style="display: none;">
                            <div class="col-md-6 offset-md-6" id="edit-additional-services-col">
                                <!--Сюда будет перемещён контейнер edit-services-container для Музыкальной школы-->
                            </div>
                        </div>

                        <!--Выбранные услуги и сброс-->
                        <div class="row mb-3">
                            <div class="col-md-12 d-flex align-items-center gap-3 flex-wrap">
                                <div class="selected-services d-flex gap-2 flex-wrap" id="edit-selected-services"></div>
                                <a href="#" id="reset-services">Сбросить всё</a>
                            </div>
                        </div>

                        <!--Комментарий-->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="editBookingComment" class="form-label">Комментарий (необязательно)</label>
                                <textarea class="form-control" id="editBookingComment" name="editBookingComment"
                                    rows="3" placeholder="Комментарий к брони" maxlength="1000"></textarea>
                                <div class="char-counter" id="editBookingCommentCounter">0/1000</div>
                            </div>
                        </div>

                        <!--Чекбокс пробное занятие-->
                        <div class="row mb-4 trial-checkbox-row" id="edit-trial-lesson-row">
                            <div class="col-md-12">
                                <input class="form-check-input" type="checkbox" id="editTrialLessonCheckbox"
                                    name="edit-trial-lesson">
                                <label class="form-check-label ms-2" for="editTrialLessonCheckbox"
                                    id="editTrialLessonLabel">
                                    Пробное занятие
                                </label>
                            </div>
                        </div>

                        <!--Расчетная стоимость-->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="d-flex align-items-end" style="height: 100%;">
                                    <label for="editBookingCostValue" class="form-label mb-0">Расчётная стоимость:</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-end justify-content-end" style="height: 100%;">
                                    <span id="editBookingCostValue">70 BYN</span>
                                </div>
                            </div>
                        </div>

                        <!--Кнопки Сохранить и Отмена-->
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <button type="button" class="button-primary w-100" id="editBookingSubmitBtn">Сохранить</button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="button-sec w-100" data-bs-dismiss="modal">Отмена</button>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <!-- Значок предупреждения в нижнем правом углу модалки -->
            <span id="edit-submit-warning-icon" class="submit-warning-icon" style="display: none;">
                <span class="submit-warning-tooltip">
                    <ul id="edit-submit-checklist"></ul>
                </span>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 9V13" stroke="#E53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 17H12.01" stroke="#E53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10.29 3.86L1.82 18C1.64 18.3 1.55 18.64 1.55 19C1.55 19.36 1.64 19.7 1.82 20C2 20.3 2.26 20.56 2.56 20.74C2.86 20.92 3.2 21.01 3.55 21H20.45C20.8 21.01 21.14 20.92 21.44 20.74C21.74 20.56 22 20.3 22.18 20C22.36 19.7 22.45 19.36 22.45 19C22.45 18.64 22.36 18.3 22.18 18L13.71 3.86C13.53 3.56 13.27 3.32 12.97 3.15C12.67 2.98 12.34 2.89 12 2.89C11.66 2.89 11.33 2.98 11.03 3.15C10.73 3.32 10.47 3.56 10.29 3.86Z" stroke="#E53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
        </div>
    </div>
</div>

<script src="{% static 'js/booking_edit_modal_core.js' %}?v={% now 'U' %}"></script>
<script src="{% static 'js/booking_edit_modal_selects.js' %}?v={% now 'U' %}"></script>

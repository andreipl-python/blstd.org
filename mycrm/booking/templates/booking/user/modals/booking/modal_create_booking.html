{% load custom_filters %}
{% load static %}

<head>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<!-- Модальное окно создания брони -->
<p id="tariff_units_json" style="display: none;">{{ tariff_units_json }}</p>
<p id="services_json" style="display: none;">{{ services_json }}</p>
<p id="clients_json" style="display: none;">{{ clients_json }}</p>

<div class="modal fade" id="createBookingModal" tabindex="-1" aria-labelledby="createBookingModalLabel"
    aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered" style="max-width:none; width: 63vw;">
        <div class="modal-content">
            <div class="modal-body">
                <form id="bookingForm" action="javascript:void(0);" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <div class="row d-flex align-items-center mb-1">
                            <div class="col-md-12 d-flex justify-content-between align-items-center">
                                <h2 class="mb-0">Новая бронь</h2>
                                <button type="button" class="modal-close-icon" data-bs-dismiss="modal"
                                    aria-label="Закрыть">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <path d="M6 6L18 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div id="roomNameContainer" class="col-md-6 align-items-center justify-content-start">
                                <span id="scenarioName">Название сценария</span> / <span id="roomName">Название
                                    комнаты</span>
                            </div>
                        </div>


                        <input type="hidden" id="dateField" name="date">
                        <input type="hidden" id="timeField" name="time">
                        <input type="hidden" id="roomNameField" name="room_name">
                        <input type="hidden" id="maxEndTime" name="maxEndTime">
                        <input type="hidden" id="fullDatetimeField" name="full_datetime">
                        <input type="hidden" id="roomIdField" name="room_id">
                    </div>

                    <div class="row mb-3">
                        <!--Выпадающий список "Клиент"-->
                        <div class="col-md-6">
                            <label for="client" class="form-label">Клиент</label>
                            <div class="custom-select" id="client" name="client">
                                <span class="selected">Выберите клиента</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li id="search-option" class="search-option" style="cursor:text;">
                                        <span style="display:flex;align-items:center;gap:6px;">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z"
                                                    stroke="#818EA2" stroke-width="2" stroke-linecap="round"
                                                    stroke-linejoin="round" />
                                                <path d="M21.0002 21L16.7002 16.7" stroke="#818EA2" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                            <input id="client-search-input" type="text" placeholder="Поиск"
                                                style="border:none;outline:none;background:transparent;width:120px;"
                                                autocomplete="off" />
                                        </span>
                                    </li>
                                    {% for client in clients %}
                                        <li data-value="{{ client.id }}">{{ client.name }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <!-- Выпадающий список "Направление" -->
                        <div class="col-md-6">
                            <label for="field-direction" class="form-label">Направление</label>
                            <div class="custom-select custom-select--clearable" id="field-direction" name="field-direction" data-placeholder="Выберите направление">
                                <span class="selected">Выберите направление</span>
                                <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    {% for direction in directions %}
                                        <li data-value="{{ direction.id }}">{{ direction.name }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <!--Строка информации об абонементе-->
                        <span id="abonementRow">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M12.586 2.586C12.211 2.2109 11.7024 2.00011 11.172 2H4C3.46957 2 2.96086 2.21071 2.58579 2.58579C2.21071 2.96086 2 3.46957 2 4V11.172C2.00011 11.7024 2.2109 12.211 2.586 12.586L11.29 21.29C11.7445 21.7416 12.3592 21.9951 13 21.9951C13.6408 21.9951 14.2555 21.7416 14.71 21.29L21.29 14.71C21.7416 14.2555 21.9951 13.6408 21.9951 13C21.9951 12.3592 21.7416 11.7445 21.29 11.29L12.586 2.586Z"
                                    stroke="#EB5757" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path
                                    d="M7.5 8C7.77614 8 8 7.77614 8 7.5C8 7.22386 7.77614 7 7.5 7C7.22386 7 7 7.22386 7 7.5C7 7.77614 7.22386 8 7.5 8Z"
                                    fill="#EB5757" stroke="#EB5757" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span>Aбонемент:</span>
                            <span>Название абонемента</span>
                            <span>/</span>
                            <span>Осталось занятий:</span>
                            <span>4</span>
                        </span>
                    </div>

                    <div class="row mb-3">
                        <!--Календарь дата-->
                        <div class="col-md-3">
                            <label for="modal-create-date" class="form-label">Дата</label>
                            <div id="custom-date-field" style="padding: 0; border: none; background: none;">
                                <input type="date" id="modal-create-date" name="modal-create-date"
                                    class="form-control" />
                            </div>
                        </div>

                        <!--Выпадающий список Время начала-->
                        <div class="col-md-3">
                            <label for="start-time" class="form-label">Время начала</label>
                            <div class="custom-select" id="start-time" name="start-time">
                                <span class="selected">9:00</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li data-value="1">10:00</li>
                                    <li data-value="2">11:00</li>
                                    <li data-value="3">12:00</li>
                                    <li data-value="4">13:00</li>
                                    <li data-value="5">14:00</li>
                                </ul>
                            </div>
                        </div>

                        <!--Выпадающий список Время окончания-->
                        <div class="col-md-3">
                            <label for="end-time" class="form-label">Время окончания</label>
                            <div class="custom-select" id="end-time" name="end-time">
                                <span class="selected">10:00</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li data-value="1">11:00</li>
                                    <li data-value="2">12:00</li>
                                    <li data-value="3">13:00</li>
                                    <li data-value="4">14:00</li>
                                    <li data-value="5">15:00</li>
                                </ul>
                            </div>
                        </div>

                        <!--Выпадающий список Длительность-->
                        <div class="col-md-3">
                            <label for="duration" class="form-label">Длительность</label>
                            <div class="custom-select" id="duration" name="duration">
                                <span class="selected">1 час</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li data-value="1">2 часа</li>
                                    <li data-value="2">3 часа</li>
                                    <li data-value="3">4 часа</li>
                                    <li data-value="4">5 часов</li>
                                    <li data-value="5">6 часов</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <!--Выпадающий список Преподаватель-->
                        <div class="col-md-6">
                            <label for="teacher" class="form-label">Преподаватель</label>
                            <div class="custom-select custom-select--clearable" id="teacher" name="teacher" data-placeholder="Выберите преподавателя">
                                <span class="selected">Выберите преподавателя</span>
                                <button type="button" class="custom-select-clear" aria-label="Сбросить выбор">×</button>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    {% for specialist in specialists %}
                                        {% if specialist.active %}
                                            <li data-value="{{ specialist.id }}" data-directions="{% for direction in specialist.directions.all %}{{ direction.id }}{% if not forloop.last %},{% endif %}{% endfor %}">{{ specialist.name }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <!--Выпадающий список со множественным выбором Услуги-->
                        <div class="col-md-6">
                            <label for="services" class="form-label">Услуги (необязательно)</label>
                            <div class="custom-select" id="services" name="services">
                                <span class="selected">Выберите услугу</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    {% for service in services %}
                                        {% if service.active %}
                                            <li data-value="{{ service.id }}" data-scenario-id="{{ service.scenario_id|default_if_none:'' }}" data-room-id="{{ service.room_id|default_if_none:'' }}">{{ service.name }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!--Комментарий-->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="bookingComment" class="form-label">Комментарий</label>
                            <textarea class="form-control" id="bookingComment" name="bookingComment" rows="3"
                                placeholder="Добавьте комментарий" maxlength="1000"></textarea>
                            <div class="char-counter" id="bookingCommentCounter">0/1000</div>
                        </div>
                    </div>

                    <!--Чекбокс пробное занятие-->
                    <div class="row mb-5">
                        <div class="col-md-12 trial-checkbox-row">
                            <input class="form-check-input" type="checkbox" id="trialLessonCheckbox" name="trialLesson">
                            <label class="form-check-label" for="trialLessonCheckbox" id="trialLessonLabel">
                                Пробное занятие
                            </label>
                        </div>
                    </div>

                    <!--Расчетная стоимость-->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="d-flex align-items-end" style="height: 100%;">
                                <label for="bookingCostValue" class="form-label mb-0">Расчётная стоимость:</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-end justify-content-end" style="height: 100%;">
                                <span id="bookingCostValue">0 BYN</span>
                            </div>
                        </div>
                    </div>

                    <!--Кнопки Добавить и Отмена-->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <button type="button" class="button-primary" id="createBookingSubmitBtn">Добавить</button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="button-sec" data-bs-dismiss="modal">Отмена</button>
                        </div>
                    </div>


                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // JS модалки создания брони

    // Функция открытия модального окна: подставляет комнату и сценарий в шапку + базовые hidden-поля
    function openModal(date, time, roomName, roomId, cell) {
        // Комната
        var roomNameSpan = document.getElementById('roomName');
        if (roomNameSpan) {
            roomNameSpan.textContent = roomName;
        }

        // Сценарий: берём из глобального фильтра window.currentScenarioFilterId + window.SCENARIOS (из user_index.html)
        if (window.currentScenarioFilterId && Array.isArray(window.SCENARIOS)) {
            var scenarioId = String(window.currentScenarioFilterId);
            var scenarioObj = window.SCENARIOS.find(function (s) { return String(s.pk) === scenarioId; });
            var scenarioNameSpan = document.getElementById('scenarioName');
            if (scenarioNameSpan) {
                scenarioNameSpan.textContent = (scenarioObj && scenarioObj.fields && scenarioObj.fields.name)
                    ? scenarioObj.fields.name
                    : 'Название сценария';
            }
        }

        // Базовые скрытые поля (если нужны бэкенду)
        var dateField = document.getElementById('dateField');
        var timeField = document.getElementById('timeField');
        var roomNameField = document.getElementById('roomNameField');
        var roomIdField = document.getElementById('roomIdField');
        var fullDatetimeField = document.getElementById('fullDatetimeField');

        var fullDatetimeStr = (cell && typeof cell.getAttribute === 'function')
            ? (cell.getAttribute('full_datetime') || '')
            : '';

        if (dateField) dateField.value = date;
        if (timeField) timeField.value = time;
        if (roomNameField) roomNameField.value = roomName;
        if (roomIdField) roomIdField.value = roomId;

        if (fullDatetimeField) {
            fullDatetimeField.value = fullDatetimeStr;
        }

        // Видимые поля
        if (fullDatetimeStr) {
            var dtParts = fullDatetimeStr.split(' ');
            if (dtParts.length >= 2) {
                var dateIso = dtParts[0];
                var timeRaw = dtParts[1];
                var timeParts = String(timeRaw).split(':');
                var timeHm = timeParts.length >= 2 ? (timeParts[0] + ':' + timeParts[1]) : String(timeRaw);

                var modalDateInput = document.getElementById('modal-create-date');
                if (modalDateInput) {
                    modalDateInput.value = dateIso;
                }

                var startTimeSelect = document.getElementById('start-time');
                if (startTimeSelect) {
                    var selectedSpan = startTimeSelect.querySelector('.selected');
                    var optionsUl = startTimeSelect.querySelector('ul.options');
                    if (optionsUl) {
                        // Временно оставляем только одно значение: время нажатой ячейки
                        optionsUl.innerHTML = '';
                        var li = document.createElement('li');
                        li.className = 'selected';
                        li.textContent = timeHm;
                        li.setAttribute('data-value', timeHm);

                        // Чтобы селект вёл себя предсказуемо даже с одним пунктом
                        li.addEventListener('mousedown', function (e) {
                            e.stopPropagation();
                        });
                        li.addEventListener('click', function (e) {
                            e.stopPropagation();
                            if (selectedSpan) {
                                selectedSpan.textContent = timeHm;
                            }
                            startTimeSelect.classList.remove('open');
                        });
                        optionsUl.appendChild(li);
                    }
                    if (selectedSpan) {
                        selectedSpan.textContent = timeHm;
                    }
                }

                // =====================================================
                // Длительность: динамический расчёт доступных периодов
                // Ограничения: work_time_end сценария ИЛИ следующая бронь
                // =====================================================

                // Получить минимальную длительность периода из текущего сценария
                function getScenarioMinDurationMinutes() {
                    var fallback = 60;
                    if (!window.currentScenarioFilterId || !Array.isArray(window.SCENARIOS)) {
                        return fallback;
                    }
                    var scenarioId = String(window.currentScenarioFilterId);
                    var scenarioObj = window.SCENARIOS.find(function (s) { return String(s.pk) === scenarioId; });
                    var raw = scenarioObj && scenarioObj.fields ? scenarioObj.fields.min_booking_duration_minutes : null;
                    var val = parseInt(raw, 10);
                    return (!isNaN(val) && val > 0) ? val : fallback;
                }

                // Получить work_time_end сценария в минутах от полуночи
                function getScenarioWorkTimeEndMinutes() {
                    if (!window.currentScenarioFilterId || !Array.isArray(window.SCENARIOS)) {
                        return null;
                    }
                    var scenarioId = String(window.currentScenarioFilterId);
                    var scenarioObj = window.SCENARIOS.find(function (s) { return String(s.pk) === scenarioId; });
                    if (!scenarioObj || !scenarioObj.fields || !scenarioObj.fields.work_time_end) {
                        return null;
                    }
                    var parts = String(scenarioObj.fields.work_time_end).split(':');
                    if (parts.length < 2) return null;
                    var h = parseInt(parts[0], 10);
                    var m = parseInt(parts[1], 10);
                    if (isNaN(h) || isNaN(m)) return null;
                    return h * 60 + m;
                }

                // Преобразовать datetime строку "YYYY-MM-DD HH:MM:SS" в объект Date
                function parseDatetimeStr(dtStr) {
                    if (!dtStr) return null;
                    var parts = dtStr.split(' ');
                    if (parts.length < 2) return null;
                    var dateParts = parts[0].split('-');
                    var timeParts = parts[1].split(':');
                    if (dateParts.length < 3 || timeParts.length < 2) return null;
                    return new Date(
                        parseInt(dateParts[0], 10),
                        parseInt(dateParts[1], 10) - 1,
                        parseInt(dateParts[2], 10),
                        parseInt(timeParts[0], 10),
                        parseInt(timeParts[1], 10),
                        timeParts[2] ? parseInt(timeParts[2], 10) : 0
                    );
                }

                // Найти время начала следующей брони в той же комнате после заданного datetime
                function getNextBookingStartMinutes(currentRoomId, startDatetime) {
                    if (!window.bookingsInRange || !Array.isArray(window.bookingsInRange)) {
                        // Попробуем глобальную переменную без window
                        if (typeof bookingsInRange === 'undefined' || !Array.isArray(bookingsInRange)) {
                            return null;
                        }
                    }
                    var bookings = window.bookingsInRange || bookingsInRange;
                    var startDate = parseDatetimeStr(startDatetime);
                    if (!startDate) return null;

                    var nextStart = null;
                    bookings.forEach(function (booking) {
                        // Проверяем совпадение комнаты
                        if (String(booking.idroom) !== String(currentRoomId)) return;
                        // Ищем первый блок брони, который начинается после нашего времени
                        if (!booking.blocks_datetime_range || !booking.blocks_datetime_range.length) return;
                        var bookingFirstBlock = booking.blocks_datetime_range[0];
                        var bookingStart = parseDatetimeStr(bookingFirstBlock);
                        if (!bookingStart) return;
                        // Бронь должна начинаться строго после нашего времени начала
                        if (bookingStart > startDate) {
                            if (nextStart === null || bookingStart < nextStart) {
                                nextStart = bookingStart;
                            }
                        }
                    });

                    if (!nextStart) return null;
                    // Возвращаем разницу в минутах от startDate до nextStart
                    return Math.floor((nextStart - startDate) / 60000);
                }

                // Форматирование длительности для отображения
                function formatDurationHuman(totalMinutes) {
                    var m = parseInt(totalMinutes, 10);
                    if (isNaN(m) || m <= 0) return '';
                    var h = Math.floor(m / 60);
                    var mm = m % 60;
                    if (h > 0 && mm > 0) return h + ' ч ' + mm + ' мин';
                    if (h > 0) return h + ' ч';
                    return mm + ' мин';
                }

                // Форматирование длительности в HH:MM для отправки на сервер
                function formatDurationHHMM(totalMinutes) {
                    var m = parseInt(totalMinutes, 10);
                    if (isNaN(m) || m < 0) return '';
                    var h = Math.floor(m / 60);
                    var mm = m % 60;
                    return String(h).padStart(2, '0') + ':' + String(mm).padStart(2, '0');
                }

                // Склонение слова "период"
                function formatPeriodsLabel(n) {
                    var k = parseInt(n, 10);
                    if (k === 1) return 'период';
                    if (k >= 2 && k <= 4) return 'периода';
                    return 'периодов';
                }

                // Вычисляем доступные минуты до ограничения
                var minMinutes = getScenarioMinDurationMinutes();
                var workTimeEndMinutes = getScenarioWorkTimeEndMinutes();
                var currentRoomId = roomIdField ? roomIdField.value : roomId;

                // Время начала в минутах от полуночи
                var startTimeMinutes = (function () {
                    var parts = timeHm.split(':');
                    if (parts.length < 2) return 0;
                    return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
                })();

                // Ограничение 1: до конца рабочего времени сценария
                var minutesToWorkEnd = null;
                if (workTimeEndMinutes !== null) {
                    minutesToWorkEnd = workTimeEndMinutes - startTimeMinutes;
                    if (minutesToWorkEnd <= 0) minutesToWorkEnd = 0;
                }

                // Ограничение 2: до следующей брони
                var minutesToNextBooking = getNextBookingStartMinutes(currentRoomId, fullDatetimeStr);

                // Итоговое ограничение = минимум из двух (если оба заданы)
                var availableMinutes = null;
                if (minutesToWorkEnd !== null && minutesToNextBooking !== null) {
                    availableMinutes = Math.min(minutesToWorkEnd, minutesToNextBooking);
                } else if (minutesToWorkEnd !== null) {
                    availableMinutes = minutesToWorkEnd;
                } else if (minutesToNextBooking !== null) {
                    availableMinutes = minutesToNextBooking;
                } else {
                    // Нет ограничений — ставим большое число (например, 24 часа)
                    availableMinutes = 24 * 60;
                }

                // Максимальное количество периодов
                var maxPeriods = Math.floor(availableMinutes / minMinutes);

                // Кнопка "Добавить"
                var submitBtn = document.getElementById('createBookingSubmitBtn');

                var durationSelect = document.getElementById('duration');
                if (durationSelect) {
                    var durationSelectedSpan = durationSelect.querySelector('.selected');
                    var durationOptionsUl = durationSelect.querySelector('ul.options');

                    // Очищаем существующие опции
                    if (durationOptionsUl) {
                        durationOptionsUl.innerHTML = '';
                    }

                    if (maxPeriods <= 0) {
                        // Нет доступных периодов — показываем placeholder
                        if (durationSelectedSpan) {
                            durationSelectedSpan.textContent = 'Нет доступных периодов';
                        }
                        durationSelect.classList.add('disabled');
                        // Делаем кнопку "Добавить" неактивной
                        if (submitBtn) {
                            submitBtn.disabled = true;
                        }
                    } else {
                        durationSelect.classList.remove('disabled');
                        // Кнопка "Добавить" активна
                        if (submitBtn) {
                            submitBtn.disabled = false;
                        }

                        // Генерируем опции для 1..maxPeriods
                        for (var i = 1; i <= maxPeriods; i++) {
                            var total = minMinutes * i;
                            var human = formatDurationHuman(total);
                            var value = formatDurationHHMM(total);
                            var label = i + ' ' + formatPeriodsLabel(i) + ' — ' + human;

                            var li = document.createElement('li');
                            li.textContent = label;
                            li.setAttribute('data-value', value);

                            if (i === 1) {
                                li.classList.add('selected');
                                if (durationSelectedSpan) {
                                    durationSelectedSpan.textContent = label;
                                }
                            }

                            // Обработчик клика для выбора опции
                            (function (liEl, liLabel) {
                                liEl.addEventListener('click', function (e) {
                                    e.stopPropagation();
                                    // Снимаем выделение со всех опций
                                    durationOptionsUl.querySelectorAll('li').forEach(function (opt) {
                                        opt.classList.remove('selected');
                                    });
                                    liEl.classList.add('selected');
                                    if (durationSelectedSpan) {
                                        durationSelectedSpan.textContent = liLabel;
                                    }
                                    durationSelect.classList.remove('open');
                                });
                            })(li, label);

                            durationOptionsUl.appendChild(li);
                        }
                    }
                }

                if (dateField) dateField.value = dateIso;
                if (timeField) timeField.value = timeHm;
            }
        }
    }

    // Счётчик символов для поля комментария
    document.addEventListener('DOMContentLoaded', function () {
        var textarea = document.getElementById('bookingComment');
        var counter = document.getElementById('bookingCommentCounter');
        var maxLength = 1000;

        if (!textarea || !counter) {
            return;
        }

        function updateCounter() {
            var val = textarea.value || '';

            if (val.length > maxLength) {
                textarea.value = val.slice(0, maxLength);
                val = textarea.value;
            }

            counter.textContent = val.length + '/' + maxLength;

            if (val.length >= maxLength) {
                counter.style.color = '#FF0000'; // красный
            } else if (val.length >= 900) {
                counter.style.color = '#FFA500'; // оранжевый
            } else {
                counter.style.color = '#818EA2'; // обычный
            }
        }

        textarea.addEventListener('input', updateCounter);
        updateCounter();
    });

    // Кастомные селекты только внутри этой модалки
    (function () {
        var modalElement = document.getElementById('createBookingModal');
        if (!modalElement) {
            return;
        }

        var teacherDirectionLastChanged = null;

        // --------------------------
        // Вспомогательные функции
        // --------------------------

        function getSelectedValue(selectEl) {
            var selectedLi = selectEl.querySelector('ul.options li.selected');
            return selectedLi ? (selectedLi.getAttribute('data-value') || '') : '';
        }

        function syncClearableSelectState(selectEl) {
            if (!selectEl || !selectEl.classList.contains('custom-select--clearable')) {
                return;
            }

            var hasValue = Boolean(getSelectedValue(selectEl));
            if (hasValue) {
                selectEl.classList.add('has-selection');
            } else {
                selectEl.classList.remove('has-selection');
            }
        }

        function resetSelect(selectEl) {
            var selectedSpan = selectEl.querySelector('.selected');
            var placeholder = selectEl.getAttribute('data-placeholder') || (selectedSpan ? selectedSpan.textContent : '');
            var options = selectEl.querySelectorAll('ul.options li');

            options.forEach(function (li) {
                li.classList.remove('selected');
            });

            if (selectedSpan) {
                selectedSpan.textContent = placeholder;
            }

            syncClearableSelectState(selectEl);
        }

        function resetTeacherDirectionUI() {
            var teacherSelect = modalElement.querySelector('#teacher');
            var directionSelect = modalElement.querySelector('#field-direction');
            if (!teacherSelect || !directionSelect) {
                return;
            }

            resetSelect(teacherSelect);
            resetSelect(directionSelect);

            teacherSelect.querySelectorAll('ul.options li').forEach(function (li) {
                li.style.display = '';
            });
            directionSelect.querySelectorAll('ul.options li').forEach(function (li) {
                li.style.display = '';
            });
        }

        function applyTeacherDirectionFilters() {
            var teacherSelect = modalElement.querySelector('#teacher');
            var directionSelect = modalElement.querySelector('#field-direction');
            if (!teacherSelect || !directionSelect) {
                return;
            }

            var selectedTeacherId = getSelectedValue(teacherSelect);
            var selectedDirectionId = getSelectedValue(directionSelect);

            var teacherLis = teacherSelect.querySelectorAll('ul.options li');
            var directionLis = directionSelect.querySelectorAll('ul.options li');

            // 1) Проверка на конфликт: если оба выбраны, но не совместимы — сбрасываем противоположный
            if (selectedTeacherId && selectedDirectionId) {
                var selectedTeacherLi = teacherSelect.querySelector('ul.options li.selected');
                var teacherDirectionsRaw = selectedTeacherLi ? (selectedTeacherLi.getAttribute('data-directions') || '') : '';
                var teacherDirections = teacherDirectionsRaw ? teacherDirectionsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];

                if (teacherDirections.indexOf(String(selectedDirectionId)) === -1) {
                    if (teacherDirectionLastChanged === 'field-direction') {
                        resetSelect(teacherSelect);
                        selectedTeacherId = '';
                    } else {
                        resetSelect(directionSelect);
                        selectedDirectionId = '';
                    }
                }
            }

            // 2) Фильтрация направлений по выбранному преподавателю
            if (selectedTeacherId) {
                var teacherLi = teacherSelect.querySelector('ul.options li.selected');
                var dirsRaw = teacherLi ? (teacherLi.getAttribute('data-directions') || '') : '';
                var allowedDirs = dirsRaw ? dirsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];

                directionLis.forEach(function (li) {
                    var dirId = li.getAttribute('data-value') || '';
                    li.style.display = allowedDirs.indexOf(String(dirId)) !== -1 ? '' : 'none';
                });
            } else {
                directionLis.forEach(function (li) {
                    li.style.display = '';
                });
            }

            // 3) Фильтрация преподавателей по выбранному направлению
            if (selectedDirectionId) {
                teacherLis.forEach(function (li) {
                    var dirsRaw = li.getAttribute('data-directions') || '';
                    var dirs = dirsRaw ? dirsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];
                    li.style.display = dirs.indexOf(String(selectedDirectionId)) !== -1 ? '' : 'none';
                });
            } else {
                teacherLis.forEach(function (li) {
                    li.style.display = '';
                });
            }
        }

        function applyServicesFilters() {
            var servicesSelect = modalElement.querySelector('#services');
            if (!servicesSelect) {
                return;
            }

            var roomIdField = modalElement.querySelector('#roomIdField');
            var currentRoomId = roomIdField ? String(roomIdField.value || '') : '';
            var currentScenarioId = (window.currentScenarioFilterId !== undefined && window.currentScenarioFilterId !== null)
                ? String(window.currentScenarioFilterId)
                : '';

            // Фильтрация + защита от дублей:
            // Если по какой-то причине одинаковые услуги оказались добавлены несколько раз, оставляем только одну.
            // Ключ: service_id + room_id + scenario_id
            var options = servicesSelect.querySelectorAll('ul.options li');
            var seen = new Map();

            Array.from(options).forEach(function (li) {
                var liRoomId = String(li.getAttribute('data-room-id') || '');
                var liScenarioId = String(li.getAttribute('data-scenario-id') || '');
                var liValue = String(li.getAttribute('data-value') || '');

                var dedupeKey = liValue + '|' + liRoomId + '|' + liScenarioId;
                if (seen.has(dedupeKey)) {
                    var kept = seen.get(dedupeKey);

                    // Если выбран дубль, а сохранённый элемент не выбран — переносим выбранность на сохранённый.
                    if (li.classList.contains('selected') && kept && !kept.classList.contains('selected')) {
                        kept.classList.add('selected');

                        if (servicesSelect._selectedOptions) {
                            servicesSelect._selectedOptions.add(kept);
                            servicesSelect._selectedOptions.delete(li);
                        }
                    }

                    if (li.parentNode) {
                        li.parentNode.removeChild(li);
                    }
                    return;
                }
                seen.set(dedupeKey, li);

                var roomOk = !liRoomId || !currentRoomId || liRoomId === currentRoomId;
                var scenarioOk = !liScenarioId || !currentScenarioId || liScenarioId === currentScenarioId;

                li.style.display = (roomOk && scenarioOk) ? '' : 'none';
            });

            if (servicesSelect._selectedOptions && servicesSelect._selectedOptions.size) {
                var changed = false;
                Array.from(servicesSelect._selectedOptions).forEach(function (opt) {
                    if (opt.style.display === 'none') {
                        opt.classList.remove('selected');
                        servicesSelect._selectedOptions.delete(opt);
                        changed = true;
                    }
                });

                if (changed && typeof servicesSelect._updateSelectedText === 'function') {
                    servicesSelect._updateSelectedText();
                }
            }
        }

        applyServicesFilters();

        // --------------------------
        // Инициализация кастомных селектов
        // --------------------------
        var customSelects = Array.from(modalElement.querySelectorAll('.custom-select'));

        // Один глобальный обработчик закрытия по клику вне селекта (без навешивания N одинаковых слушателей)
        document.addEventListener('click', function (e) {
            customSelects.forEach(function (select) {
                if (!select.contains(e.target)) {
                    select.classList.remove('open');
                }
            });
        });

        customSelects.forEach(function (select) {
            var selected = select.querySelector('.selected');
            var optionsContainer = select.querySelector('.options');
            if (!selected || !optionsContainer) {
                return;
            }

            var optionsList = optionsContainer.querySelectorAll('li');
            var isClientSelect = select.id === 'client';
            var searchInput = isClientSelect ? select.querySelector('#client-search-input') : null;
            var searchOption = isClientSelect ? select.querySelector('#search-option') : null;

            var clearBtn = select.querySelector('.custom-select-clear');
            if (clearBtn) {
                clearBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    teacherDirectionLastChanged = select.id;
                    resetSelect(select);
                    select.classList.remove('open');

                    if (select.id === 'teacher' || select.id === 'field-direction') {
                        applyTeacherDirectionFilters();
                    }
                });
            }

            syncClearableSelectState(select);

            // Множественный выбор только для услуг (список не закрываем при выборе)
            if (select.id === 'services') {
                var selectedOptions = new Set();
                select._selectedOptions = selectedOptions;

                function updateSelectedText() {
                    if (selectedOptions.size === 0) {
                        selected.textContent = 'Выберите услугу';
                    } else if (selectedOptions.size === 1) {
                        selected.textContent = Array.from(selectedOptions)[0].textContent;
                    } else {
                        selected.textContent = selectedOptions.size + ' выбрано';
                    }
                }

                select._updateSelectedText = updateSelectedText;

                select.addEventListener('click', function (e) {
                    if (e.target.tagName !== 'LI') {
                        select.classList.toggle('open');
                    }
                });

                optionsList.forEach(function (option) {
                    option.addEventListener('mousedown', function (e) {
                        e.stopPropagation();
                    });
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        if (option.classList.contains('selected')) {
                            option.classList.remove('selected');
                            selectedOptions.delete(option);
                        } else {
                            option.classList.add('selected');
                            selectedOptions.add(option);
                        }

                        updateSelectedText();
                    });
                });

                return;
            }

            // Поиск по клиентам
            if (isClientSelect && searchInput) {
                searchInput.addEventListener('input', function () {
                    var filter = this.value.trim().toLowerCase();
                    optionsList.forEach(function (option) {
                        if (option.id === 'search-option') {
                            return;
                        }
                        var text = option.textContent.trim().toLowerCase();
                        option.style.display = text.indexOf(filter) !== -1 ? '' : 'none';
                    });
                });

                if (searchOption) {
                    // не даём выбрать пункт с поиском и не закрываем селект при клике по нему
                    searchOption.addEventListener('mousedown', function (e) {
                        e.stopPropagation();
                    });
                    searchOption.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
                }
            }

            // Обычный одиночный выбор (селект закрывается после выбора)
            select.addEventListener('click', function (e) {
                // не обрабатываем клики по option, они обрабатываются ниже
                if (e.target.tagName !== 'LI') {
                    select.classList.toggle('open');

                    // при открытии списка клиентов ставим фокус в поле поиска
                    if (isClientSelect && searchInput) {
                        setTimeout(function () {
                            searchInput.focus();
                        }, 0);
                    }
                }
            });

            optionsList.forEach(function (option) {
                // в селекте клиентов пункт с инпутом поиска не должен выбираться
                if (option.id === 'search-option') {
                    return;
                }

                option.addEventListener('click', function (e) {
                    e.stopPropagation();
                    optionsList.forEach(function (opt) { opt.classList.remove('selected'); });
                    option.classList.add('selected');
                    selected.textContent = option.textContent;
                    select.classList.remove('open');

                    syncClearableSelectState(select);

                    if (select.id === 'teacher' || select.id === 'field-direction') {
                        teacherDirectionLastChanged = select.id;
                        applyTeacherDirectionFilters();
                    }
                });
            });
        });

        // При закрытии модалки сбрасываем связанные селекты и фильтры, чтобы при следующем открытии не оставались скрытые элементы
        modalElement.addEventListener('hidden.bs.modal', function () {
            teacherDirectionLastChanged = null;
            resetTeacherDirectionUI();
        });

        // При открытии гарантируем корректную фильтрацию (на случай, если есть предустановленные значения)
        modalElement.addEventListener('shown.bs.modal', function () {
            applyTeacherDirectionFilters();
            applyServicesFilters();
        });
    })();
</script>
{% load custom_filters %}
{% load static %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏ -->
<p id="tariff_units_json" style="display: none;">{{ tariff_units_json }}</p>
<p id="services_json" style="display: none;">{{ services_json }}</p>
<p id="clients_json" style="display: none;">{{ clients_json }}</p>
<p id="client_groups_json" style="display: none;">{{ client_groups_json }}</p>

<div class="modal fade" id="createBookingModal" tabindex="-1" aria-labelledby="createBookingModalLabel"
    aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered" style="max-width:none; width: 63vw;">
        <div class="modal-content">
            <div class="modal-body">
                <form id="bookingForm" action="javascript:void(0);" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <div class="row d-flex align-items-center mb-1">
                            <div class="col-md-12 d-flex justify-content-between align-items-center">
                                <h2 class="mb-0">–ù–æ–≤–∞—è –±—Ä–æ–Ω—å</h2>
                                <button type="button" class="modal-close-icon" data-bs-dismiss="modal"
                                    aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <path d="M6 6L18 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div id="roomNameContainer" class="col-md-6 align-items-center justify-content-start">
                                <span id="scenarioName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è</span> / <span id="roomName">–ù–∞–∑–≤–∞–Ω–∏–µ
                                    –∫–æ–º–Ω–∞—Ç—ã</span>
                            </div>
                        </div>


                        <input type="hidden" id="dateField" name="date">
                        <input type="hidden" id="timeField" name="time">
                        <input type="hidden" id="roomNameField" name="room_name">
                        <input type="hidden" id="maxEndTime" name="maxEndTime">
                        <input type="hidden" id="fullDatetimeField">
                        <input type="hidden" id="roomIdField" name="room_id">
                    </div>

                    <div class="row mb-3">
                        <!--–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ "–ö–ª–∏–µ–Ω—Ç" / "–ö–ª–∏–µ–Ω—Ç / –≥—Ä—É–ø–ø–∞"-->
                        <div class="col-md-6">
                            <label for="client" class="form-label" id="client-label">–ö–ª–∏–µ–Ω—Ç</label>
                            <div class="custom-select" id="client" name="client">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li id="search-option" class="search-option" style="cursor:text;">
                                        <span style="display:flex;align-items:center;gap:6px;">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z"
                                                    stroke="#818EA2" stroke-width="2" stroke-linecap="round"
                                                    stroke-linejoin="round" />
                                                <path d="M21.0002 21L16.7002 16.7" stroke="#818EA2" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                            <input id="client-search-input" type="text" placeholder="–ü–æ–∏—Å–∫"
                                                style="border:none;outline:none;background:transparent;width:120px;"
                                                autocomplete="off" />
                                        </span>
                                    </li>
                                    {% for client in clients %}
                                        <li data-value="{{ client.id }}" data-type="client">{{ client.name }}</li>
                                    {% endfor %}
                                    {% for group in client_groups %}
                                        <li data-value="{{ group.id }}" data-type="group" class="client-group-option" style="display:none;">üé∏ {{ group.name }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π —Ç–æ—á–∫–∏) -->
                        <div class="col-md-6" id="direction-field-container">
                            <label for="field-direction" class="form-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                            <div class="custom-select custom-select--clearable" id="field-direction" name="field-direction" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                                <button type="button" class="custom-select-clear" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä">√ó</button>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    {% for direction in directions %}
                                        <li data-value="{{ direction.id }}">{{ direction.name }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3" id="abonement-row-container">
                        <!--–°—Ç—Ä–æ–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–±–æ–Ω–µ–º–µ–Ω—Ç–µ-->
                        <span id="abonementRow">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M12.586 2.586C12.211 2.2109 11.7024 2.00011 11.172 2H4C3.46957 2 2.96086 2.21071 2.58579 2.58579C2.21071 2.96086 2 3.46957 2 4V11.172C2.00011 11.7024 2.2109 12.211 2.586 12.586L11.29 21.29C11.7445 21.7416 12.3592 21.9951 13 21.9951C13.6408 21.9951 14.2555 21.7416 14.71 21.29L21.29 14.71C21.7416 14.2555 21.9951 13.6408 21.9951 13C21.9951 12.3592 21.7416 11.7445 21.29 11.29L12.586 2.586Z"
                                    stroke="#EB5757" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path
                                    d="M7.5 8C7.77614 8 8 7.77614 8 7.5C8 7.22386 7.77614 7 7.5 7C7.22386 7 7 7.22386 7 7.5C7 7.77614 7.22386 8 7.5 8Z"
                                    fill="#EB5757" stroke="#EB5757" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span>A–±–æ–Ω–µ–º–µ–Ω—Ç:</span>
                            <span>–ù–∞–∑–≤–∞–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞</span>
                            <span>/</span>
                            <span>–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–Ω—è—Ç–∏–π:</span>
                            <span>4</span>
                        </span>
                    </div>

                    <div class="row mb-3">
                        <!--–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–∞—Ç–∞-->
                        <div class="col-md-3">
                            <label for="modal-create-date" class="form-label">–î–∞—Ç–∞</label>
                            <div class="modal-datepicker" id="modal-datepicker">
                                <input type="hidden" id="modal-create-date" name="modal-create-date" />
                                <div class="modal-datepicker__trigger" id="datepicker-trigger">
                                    <span id="datepicker-display">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="3" y="4" width="18" height="18" rx="2" stroke="#818EA2" stroke-width="2"/>
                                        <path d="M16 2V6" stroke="#818EA2" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M8 2V6" stroke="#818EA2" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M3 10H21" stroke="#818EA2" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="modal-datepicker__popup" id="datepicker-popup">
                                    <div class="modal-datepicker__header">
                                        <button type="button" class="modal-datepicker__nav-btn" id="datepicker-prev">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <div class="modal-datepicker__selects">
                                            <select class="modal-datepicker__select" id="datepicker-month"></select>
                                            <select class="modal-datepicker__select" id="datepicker-year"></select>
                                        </div>
                                        <button type="button" class="modal-datepicker__nav-btn" id="datepicker-next">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="modal-datepicker__weekdays">
                                        <div class="modal-datepicker__weekday">–ü–Ω</div>
                                        <div class="modal-datepicker__weekday">–í—Ç</div>
                                        <div class="modal-datepicker__weekday">–°—Ä</div>
                                        <div class="modal-datepicker__weekday">–ß—Ç</div>
                                        <div class="modal-datepicker__weekday">–ü—Ç</div>
                                        <div class="modal-datepicker__weekday">–°–±</div>
                                        <div class="modal-datepicker__weekday">–í—Å</div>
                                    </div>
                                    <div class="modal-datepicker__grid" id="datepicker-grid"></div>
                                    <div class="modal-datepicker__footer">
                                        <button type="button" class="modal-datepicker__today-btn" id="datepicker-today">–°–µ–≥–æ–¥–Ω—è</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞-->
                        <div class="col-md-3">
                            <label for="start-time" class="form-label">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
                            <div class="custom-select custom-select--clearable" id="start-time" name="start-time" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</span>
                                <button type="button" class="custom-select-clear" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä">√ó</button>
                                <!-- –ó–Ω–∞—á–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º —Å–ª–æ—Ç–µ -->
                                <span id="start-time-warning-icon" class="start-time-warning-icon" style="display: none;">
                                    <span class="warning-tooltip">–≠—Ç–æ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã.</span>
                                    ‚ö†
                                </span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li data-value="1">10:00</li>
                                    <li data-value="2">11:00</li>
                                    <li data-value="3">12:00</li>
                                    <li data-value="4">13:00</li>
                                    <li data-value="5">14:00</li>
                                </ul>
                            </div>
                        </div>

                        <!--–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è-->
                        <div class="col-md-3">
                            <label for="end-time" class="form-label">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <div class="custom-select custom-select--clearable" id="end-time" name="end-time" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</span>
                                <button type="button" class="custom-select-clear" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä">√ó</button>
                                <!-- –ó–Ω–∞—á–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
                                <span id="end-time-warning-icon" class="start-time-warning-icon" style="display: none;">
                                    <span class="warning-tooltip">–≠—Ç–æ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã.</span>
                                    ‚ö†
                                </span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li data-value="1">11:00</li>
                                    <li data-value="2">12:00</li>
                                    <li data-value="3">13:00</li>
                                    <li data-value="4">14:00</li>
                                    <li data-value="5">15:00</li>
                                </ul>
                            </div>
                        </div>

                        <!--–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å-->
                        <div class="col-md-3">
                            <label for="duration" class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                            <div class="custom-select custom-select--clearable" id="duration" name="duration" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                                <button type="button" class="custom-select-clear" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä">√ó</button>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li data-value="1">2 —á–∞—Å–∞</li>
                                    <li data-value="2">3 —á–∞—Å–∞</li>
                                    <li data-value="3">4 —á–∞—Å–∞</li>
                                    <li data-value="4">5 —á–∞—Å–æ–≤</li>
                                    <li data-value="5">6 —á–∞—Å–æ–≤</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3" id="teacher-row-container">
                        <!--–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π —Ç–æ—á–∫–∏)-->
                        <div class="col-md-6" id="teacher-field-container">
                            <label for="teacher" class="form-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label>
                            <div class="custom-select custom-select--clearable" id="teacher" name="teacher" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</span>
                                <span id="teacher-warning-icon" class="teacher-warning-icon" style="display: none;">
                                    <span class="warning-tooltip">–≠—Ç–æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∑–∞–Ω—è—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è.</span>
                                    ‚ö†
                                </span>
                                <button type="button" class="custom-select-clear" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä">√ó</button>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    {% for specialist in specialists %}
                                        {% if specialist.active %}
                                            <li data-value="{{ specialist.id }}" data-directions="{% for direction in specialist.directions.all %}{{ direction.id }}{% if not forloop.last %},{% endif %}{% endfor %}">{{ specialist.name }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <!--–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ "–¢–∞—Ä–∏—Ñ" (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π —Ç–æ—á–∫–∏, —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)-->
                        <div class="col-md-6" id="tariff-field-container" style="display: none;">
                            <label for="tariff" class="form-label">–¢–∞—Ä–∏—Ñ</label>
                            <div class="custom-select" id="tariff" name="tariff">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <!-- –ó–∞–≥–ª—É—à–∫–∞: –æ–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ -->
                                </ul>
                            </div>
                        </div>

                        <!--–ó–∞–¥–∞—á–∞ 1: –£—Å–ª—É–≥–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞", —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)-->
                        <div class="col-md-6" id="specialist-service-container" style="display: none;">
                            <label for="specialist-service" class="form-label">–£—Å–ª—É–≥–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</label>
                            <div class="custom-select custom-select--clearable" id="specialist-service" name="specialist-service" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</span>
                                <button type="button" class="custom-select-clear" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä">√ó</button>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    {% for specialist_service in specialist_services %}
                                        <li data-value="{{ specialist_service.id }}" data-cost="{{ specialist_service.cost|default_if_none:'0' }}" data-duration-minutes="{{ specialist_service.duration_minutes|default_if_none:'0' }}" data-name="{{ specialist_service.name }}">
                                            <span class="service-name">{{ specialist_service.name }}</span>
                                            <span class="service-cost">{{ specialist_service.cost|default_if_none:'0' }} BYN</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <!--–ó–∞–¥–∞—á–∞ 2: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –∏–∑ "–£—Å–ª—É–≥–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" –≤ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏"-->
                        <!--–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (—Å–ø—Ä–∞–≤–∞ –æ—Ç –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è/–¢–∞—Ä–∏—Ñ–∞)-->
                        <div class="col-md-6" id="services-container">
                            <label for="services" class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</label>
                            <div class="custom-select" id="services" name="services">
                                <span class="selected">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    {% for service in services %}
                                        {% if service.active %}
                                            <li data-value="{{ service.id }}" data-cost="{{ service.cost|default_if_none:'0' }}" data-scenario-id="{{ service.scenario_id|default_if_none:'' }}" data-room-id="{{ service.room_id|default_if_none:'' }}" data-name="{{ service.name }}">
                                                <span class="service-name">{{ service.name }}</span>
                                                <span class="service-cost">{{ service.cost|default_if_none:'0' }} BYN</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!--–ó–∞–¥–∞—á–∞ 3: –û—Ç–¥–µ–ª—å–Ω—ã–π —Ä—è–¥ –¥–ª—è "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏" –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞" (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)-->
                    <!--–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –∏—Å–ø–æ–ª—å–∑—É–µ–º offset-md-6 –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–≥–æ col-md-6 –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —à–∏—Ä–∏–Ω—ã-->
                    <div class="row mb-3" id="additional-services-row" style="display: none;">
                        <div class="col-md-6 offset-md-6" id="additional-services-col">
                            <!--–°—é–¥–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä services-container –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã-->
                        </div>
                    </div>

                    <!--–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–±—Ä–æ—Å-->
                    <div class="row mb-3">
                        <div class="col-md-12 d-flex align-items-center gap-3 flex-wrap">
                            <div class="selected-services d-flex gap-2 flex-wrap" id="create-selected-services"></div>
                            <a href="#" id="create-reset-services" style="display: none;">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</a>
                        </div>
                    </div>

                    <!--–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π-->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="bookingComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <textarea class="form-control" id="bookingComment" name="bookingComment" rows="3"
                                placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" maxlength="1000"></textarea>
                            <div class="char-counter" id="bookingCommentCounter">0/1000</div>
                        </div>
                    </div>

                    <!--–ß–µ–∫–±–æ–∫—Å –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã)-->
                    <div class="row mb-5" id="trial-lesson-container">
                        <div class="col-md-12 trial-checkbox-row">
                            <input class="form-check-input" type="checkbox" id="trialLessonCheckbox" name="trialLesson">
                            <label class="form-check-label" for="trialLessonCheckbox" id="trialLessonLabel">
                                –ü—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
                            </label>
                        </div>
                    </div>

                    <!--–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å-->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="d-flex align-items-end" style="height: 100%;">
                                <label for="bookingCostValue" class="form-label mb-0">–†–∞—Å—á—ë—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-end justify-content-end" style="height: 100%;">
                                <span id="bookingCostValue">0 BYN</span>
                            </div>
                        </div>
                    </div>

                    <!--–ö–Ω–æ–ø–∫–∏ –î–æ–±–∞–≤–∏—Ç—å –∏ –û—Ç–º–µ–Ω–∞-->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <button type="button" class="button-primary" id="createBookingSubmitBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="button-sec" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>


                </form>
            </div>
            <!-- –ó–Ω–∞—á–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –Ω–∏–∂–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É –º–æ–¥–∞–ª–∫–∏ -->
            <span id="submit-warning-icon" class="submit-warning-icon" style="display: none;">
                <span class="submit-warning-tooltip">
                    <ul id="submit-checklist"></ul>
                </span>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 9V13" stroke="#E53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 17H12.01" stroke="#E53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10.29 3.86L1.82 18C1.64 18.3 1.55 18.64 1.55 19C1.55 19.36 1.64 19.7 1.82 20C2 20.3 2.26 20.56 2.56 20.74C2.86 20.92 3.2 21.01 3.55 21H20.45C20.8 21.01 21.14 20.92 21.44 20.74C21.74 20.56 22 20.3 22.18 20C22.36 19.7 22.45 19.36 22.45 19C22.45 18.64 22.36 18.3 22.18 18L13.71 3.86C13.53 3.56 13.27 3.32 12.97 3.15C12.67 2.98 12.34 2.89 12 2.89C11.66 2.89 11.33 2.98 11.03 3.15C10.73 3.32 10.47 3.56 10.29 3.86Z" stroke="#E53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
        </div>
    </div>
</div>

<script>
    // JS –º–æ–¥–∞–ª–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏

    /**
     * –ê–¥–∞–ø—Ç–∞—Ü–∏—è UI –º–æ–¥–∞–ª–∫–∏ –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.
     * - "–†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞": —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å, 
     *   –≤ —Å–ø–∏—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≥—Ä—É–ø–ø—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞ "–¢–∞—Ä–∏—Ñ"
     * - –î—Ä—É–≥–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥
     */
    function adaptModalForScenario(scenarioName) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        window.currentScenarioName = scenarioName;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—Ü–µ–Ω–∞—Ä–∏—è
        var isRepPoint = (scenarioName === '–†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞');
        var isMusicClass = (scenarioName === '–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å');
        var isMusicSchool = (scenarioName === '–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞');
        // –†–µ–ø—Ç–æ—á–∫–∞ –∏ –ú—É–∑–∫–ª–∞—Å—Å –∏–º–µ—é—Ç –ø–æ—Ö–æ–∂—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–±–µ–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞)
        var isSimplifiedScenario = isRepPoint || isMusicClass;
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ–ª–µ–π
        var directionContainer = document.getElementById('direction-field-container');
        var teacherFieldContainer = document.getElementById('teacher-field-container');
        var tariffFieldContainer = document.getElementById('tariff-field-container');
        var abonementContainer = document.getElementById('abonement-row-container');
        var trialLessonContainer = document.getElementById('trial-lesson-container');
        var clientLabel = document.getElementById('client-label');
        var clientSelect = document.getElementById('client');
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã)
        if (directionContainer) {
            directionContainer.style.display = isSimplifiedScenario ? 'none' : '';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ê–±–æ–Ω–µ–º–µ–Ω—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã)
        if (abonementContainer) {
            abonementContainer.style.display = isSimplifiedScenario ? 'none' : '';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ü—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã)
        if (trialLessonContainer) {
            trialLessonContainer.style.display = isSimplifiedScenario ? 'none' : '';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å vs –¢–∞—Ä–∏—Ñ
        if (teacherFieldContainer) {
            teacherFieldContainer.style.display = isSimplifiedScenario ? 'none' : '';
        }
        if (tariffFieldContainer) {
            tariffFieldContainer.style.display = isSimplifiedScenario ? '' : 'none';
        }
        
        // –ó–∞–¥–∞—á–∞ 1: –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å "–£—Å–ª—É–≥–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π" (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã)
        var specialistServiceContainer = document.getElementById('specialist-service-container');
        if (specialistServiceContainer) {
            specialistServiceContainer.style.display = isMusicSchool ? '' : 'none';
        }
        
        // –ó–∞–¥–∞—á–∞ 3: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏" –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —É–±–∏—Ä–∞–µ–º/–¥–æ–±–∞–≤–ª—è–µ–º col-md-6 —á—Ç–æ–±—ã —à–∏—Ä–∏–Ω–∞ –±—ã–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π
        var servicesContainer = document.getElementById('services-container');
        var additionalServicesRow = document.getElementById('additional-services-row');
        var additionalServicesCol = document.getElementById('additional-services-col');
        var teacherRowContainer = document.getElementById('teacher-row-container');
        
        if (servicesContainer && additionalServicesRow && additionalServicesCol && teacherRowContainer) {
            if (isMusicSchool) {
                // –î–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã: –ø–µ—Ä–µ–º–µ—â–∞–µ–º "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏" –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä—è–¥ –ø–æ–¥ "–£—Å–ª—É–≥–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π"
                additionalServicesRow.style.display = '';
                // –£–±–∏—Ä–∞–µ–º col-md-6 —á—Ç–æ–±—ã –∑–∞–Ω—è—Ç—å –≤—Å—é —à–∏—Ä–∏–Ω—É —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∫–æ—Ç–æ—Ä—ã–π —É–∂–µ col-md-6)
                servicesContainer.classList.remove('col-md-6');
                additionalServicesCol.appendChild(servicesContainer);
            } else {
                // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏" –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Ä—è–¥—É —Å –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º/–¢–∞—Ä–∏—Ñ–æ–º
                additionalServicesRow.style.display = 'none';
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º col-md-6 –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–µ—Ç–∫–∏ –≤ —Ä—è–¥—É
                servicesContainer.classList.add('col-md-6');
                teacherRowContainer.appendChild(servicesContainer);
            }
        }
        
        // –ò–∑–º–µ–Ω–∏—Ç—å –ª–µ–π–±–ª –∫–ª–∏–µ–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –†–µ–ø—Ç–æ—á–∫–∏ - —Å –≥—Ä—É–ø–ø–∞–º–∏)
        if (clientLabel) {
            clientLabel.textContent = isRepPoint ? '–ö–ª–∏–µ–Ω—Ç / –≥—Ä—É–ø–ø–∞' : '–ö–ª–∏–µ–Ω—Ç';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—ã –≤ —Å–ø–∏—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –†–µ–ø—Ç–æ—á–∫–∏)
        if (clientSelect) {
            var groupOptions = clientSelect.querySelectorAll('.client-group-option');
            groupOptions.forEach(function(opt) {
                opt.style.display = isRepPoint ? '' : 'none';
            });
            
            // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
            var selectedSpan = clientSelect.querySelector('.selected');
            if (selectedSpan) {
                selectedSpan.textContent = isRepPoint ? '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –≥—Ä—É–ø–ø—É' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞';
            }
            var selectedLi = clientSelect.querySelector('ul.options li.selected');
            if (selectedLi) {
                selectedLi.classList.remove('selected');
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
        if (typeof window.updateSubmitButtonState === 'function') {
            window.updateSubmitButtonState();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞: –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–Ω–∞—Ç—É –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ —à–∞–ø–∫—É + –±–∞–∑–æ–≤—ã–µ hidden-–ø–æ–ª—è
    function openModal(date, time, roomName, roomId, cell) {
        if (typeof window.resetCreateBookingModalSelects === 'function') {
            window.resetCreateBookingModalSelects();
        }
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
        var commentField = document.getElementById('bookingComment');
        if (commentField) {
            commentField.value = '';
        }
        var commentCounter = document.getElementById('bookingCommentCounter');
        if (commentCounter) {
            commentCounter.textContent = '0/1000';
        }
        
        // –ö–æ–º–Ω–∞—Ç–∞
        var roomNameSpan = document.getElementById('roomName');
        if (roomNameSpan) {
            roomNameSpan.textContent = roomName;
        }

        // –°—Ü–µ–Ω–∞—Ä–∏–π: –±–µ—Ä—ë–º –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ window.currentScenarioFilterId + window.SCENARIOS (–∏–∑ user_index.html)
        var currentScenarioName = '';
        if (window.currentScenarioFilterId && Array.isArray(window.SCENARIOS)) {
            var scenarioId = String(window.currentScenarioFilterId);
            var scenarioObj = window.SCENARIOS.find(function (s) { return String(s.pk) === scenarioId; });
            var scenarioNameSpan = document.getElementById('scenarioName');
            if (scenarioObj && scenarioObj.fields && scenarioObj.fields.name) {
                currentScenarioName = scenarioObj.fields.name;
            }
            if (scenarioNameSpan) {
                scenarioNameSpan.textContent = currentScenarioName || '–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è';
            }
        }

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è UI –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
        adaptModalForScenario(currentScenarioName);

        // –ë–∞–∑–æ–≤—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –±—ç–∫–µ–Ω–¥—É)
        var dateField = document.getElementById('dateField');
        var timeField = document.getElementById('timeField');
        var roomNameField = document.getElementById('roomNameField');
        var roomIdField = document.getElementById('roomIdField');
        var fullDatetimeField = document.getElementById('fullDatetimeField');

        var fullDatetimeStr = (cell && typeof cell.getAttribute === 'function')
            ? (cell.getAttribute('full_datetime') || '')
            : '';

        if (dateField) dateField.value = date;
        if (timeField) timeField.value = time;
        if (roomNameField) roomNameField.value = roomName;
        if (roomIdField) roomIdField.value = roomId;

        if (fullDatetimeField) {
            fullDatetimeField.value = fullDatetimeStr;
        }

        // –í–∏–¥–∏–º—ã–µ –ø–æ–ª—è
        if (fullDatetimeStr) {
            var dtParts = fullDatetimeStr.split(' ');
            if (dtParts.length >= 2) {
                var dateIso = dtParts[0];
                var timeRaw = dtParts[1];
                var timeParts = String(timeRaw).split(':');
                var timeHm = timeParts.length >= 2 ? (timeParts[0] + ':' + timeParts[1]) : String(timeRaw);

                var modalDateInput = document.getElementById('modal-create-date');
                if (modalDateInput) {
                    modalDateInput.value = dateIso;
                }

                // =====================================================
                // –ú–û–î–£–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –í–†–ï–ú–ï–ù–ï–ú –ë–†–û–ù–ò
                // =====================================================
                // 
                // –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–µ–º—è —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å–µ–ª–µ–∫—Ç–∞–º–∏:
                // - –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (start-time)
                // - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (duration) ‚Äî –≤ –ø–µ—Ä–∏–æ–¥–∞—Ö –ø–æ minMinutes –º–∏–Ω—É—Ç
                // - –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (end-time)
                //
                // –õ–û–ì–ò–ö–ê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø:
                // 1. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞:
                //    - –°–ø–∏—Å–æ–∫ –æ–∫–æ–Ω—á–∞–Ω–∏–π —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è "–≤–ø—Ä–∞–≤–æ" –æ—Ç –Ω–∞—á–∞–ª–∞
                //    - –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏–µ ‚Äî –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                //
                // 2. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è:
                //    - –°–ø–∏—Å–æ–∫ –Ω–∞—á–∞–ª–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è "–≤–ª–µ–≤–æ" –æ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏—è
                //    - –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—á–∞–ª–æ ‚Äî –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                //
                // 3. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
                //    - –°–ø–∏—Å–∫–∏ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                //    - –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—á–∞–ª–æ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏–µ
                //    - –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏–µ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞—á–∞–ª–æ
                //
                // 4. –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω—ã
                //    –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞, –∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                // =====================================================

                // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è ---

                // –ü–æ–ª—É—á–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–∏–æ–¥–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è (–≤ –º–∏–Ω—É—Ç–∞—Ö)
                // –î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ TariffUnit.min_reservation_time (TimeField –≤ —Ñ–æ—Ä–º–∞—Ç–µ "HH:MM:SS")
                function getScenarioMinDurationMinutes() {
                    var fallback = 60;
                    if (!window.currentScenarioFilterId) {
                        return fallback;
                    }
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getScenarioMinDurationMinutes !== 'function') {
                        return fallback;
                    }
                    return window.BookingTimeUtils.getScenarioMinDurationMinutes(window.currentScenarioFilterId) || fallback;
                }
                // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
                window.getScenarioMinDurationMinutes = getScenarioMinDurationMinutes;

                // –ü–æ–ª—É—á–∏—Ç—å work_time_start —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏
                function getScenarioWorkTimeStartMinutes() {
                    if (!window.currentScenarioFilterId) {
                        return 0;
                    }
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getScenarioWorkTimeStartMinutes !== 'function') {
                        return 0;
                    }
                    return window.BookingTimeUtils.getScenarioWorkTimeStartMinutes(window.currentScenarioFilterId);
                }

                // –ü–æ–ª—É—á–∏—Ç—å work_time_end —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏
                function getScenarioWorkTimeEndMinutes() {
                    if (!window.currentScenarioFilterId) {
                        return 24 * 60;
                    }
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getScenarioWorkTimeEndMinutes !== 'function') {
                        return 24 * 60;
                    }
                    return window.BookingTimeUtils.getScenarioWorkTimeEndMinutes(window.currentScenarioFilterId);
                }

                // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (—Ç–∞—Ä–∏—Ñ–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã) –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
                function getScenarioTariffUnitCost() {
                    if (!window.currentScenarioFilterId) {
                        return 0;
                    }
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getScenarioTariffUnitCost !== 'function') {
                        return 0;
                    }
                    return window.BookingTimeUtils.getScenarioTariffUnitCost(window.currentScenarioFilterId) || 0;
                }

                // –ü–æ–ª—É—á–∏—Ç—å —Å—É–º–º—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
                function getSelectedServicesCost() {
                    var servicesSelect = document.getElementById('services');
                    if (!servicesSelect || !servicesSelect._selectedOptions || servicesSelect._selectedOptions.size === 0) {
                        return 0;
                    }
                    var totalCost = 0;
                    servicesSelect._selectedOptions.forEach(function (li) {
                        var cost = parseFloat(li.getAttribute('data-cost') || '0');
                        if (Number.isFinite(cost)) totalCost += cost;
                    });
                    return totalCost;
                }

                // –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
                function updateServicesBadges() {
                    var container = document.getElementById('create-selected-services');
                    var servicesSelect = document.getElementById('services');
                    var resetBtn = document.getElementById('create-reset-services');
                    if (!container || !servicesSelect) return;
                    
                    container.innerHTML = '';
                    var selectedLis = servicesSelect._selectedOptions ? Array.from(servicesSelect._selectedOptions) : [];

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë" –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –±–æ–ª—å—à–µ 1 —É—Å–ª—É–≥–∏
                    if (resetBtn) {
                        resetBtn.style.display = selectedLis.length > 1 ? 'inline' : 'none';
                    }

                    selectedLis.forEach(function(li) {
                        var badge = document.createElement('span');
                        badge.className = 'service-badge';
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º data-name –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è —É—Å–ª—É–≥–∏ (–±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏)
                        badge.textContent = li.getAttribute('data-name') || li.textContent.split('\n')[0].trim();

                        // –ö—Ä–µ—Å—Ç–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏
                        var removeBtn = document.createElement('span');
                        removeBtn.className = 'service-badge-remove';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.style.marginLeft = '6px';
                        removeBtn.style.cursor = 'pointer';
                        removeBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            // –£–±–∏—Ä–∞–µ–º —É—Å–ª—É–≥—É –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                            li.classList.remove('selected');
                            servicesSelect._selectedOptions.delete(li);
                            updateServicesBadges();
                            calculateAndUpdateBookingCost();
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ —Å–µ–ª–µ–∫—Ç–µ
                            var selectedSpan = servicesSelect.querySelector('.selected');
                            var count = servicesSelect._selectedOptions.size;
                            if (selectedSpan) {
                                if (count === 0) {
                                    selectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É';
                                } else if (count === 1) {
                                    selectedSpan.textContent = Array.from(servicesSelect._selectedOptions)[0].textContent;
                                } else {
                                    selectedSpan.textContent = count + ' –≤—ã–±—Ä–∞–Ω–æ';
                                }
                            }
                        });
                        badge.appendChild(removeBtn);
                        container.appendChild(badge);
                    });
                }
                // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
                window.updateServicesBadges = updateServicesBadges;

                // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏
                // –°—Ç–æ–∏–º–æ—Å—Ç—å = (–∫–æ–ª-–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤ √ó —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–∏–æ–¥–∞) + —Å—É–º–º–∞ —É—Å–ª—É–≥
                // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥
                function calculateAndUpdateBookingCost() {
                    var costElement = document.getElementById('bookingCostValue');
                    if (!costElement) return;
                    
                    // –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–∏–æ–¥–æ–≤ (0 –µ—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –≤—ã–±—Ä–∞–Ω–æ)
                    var periodsTotalCost = 0;
                    if (currentSelectedPeriods !== null && currentSelectedPeriods !== undefined) {
                        var periodCost = getScenarioTariffUnitCost();
                        periodsTotalCost = currentSelectedPeriods * periodCost;
                    }
                    
                    // –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –≤—Å–µ–≥–¥–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
                    var servicesCost = getSelectedServicesCost();
                    var totalCost = periodsTotalCost + servicesCost;
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å 2 –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –Ω—É–ª–∏
                    var formatted = totalCost.toFixed(2).replace(/\.00$/, '');
                    costElement.textContent = formatted + ' BYN';
                }
                // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
                window.calculateAndUpdateBookingCost = calculateAndUpdateBookingCost;

                // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å datetime —Å—Ç—Ä–æ–∫—É "YYYY-MM-DD HH:MM:SS" –≤ –æ–±—ä–µ–∫—Ç Date
                function parseDatetimeStr(dtStr) {
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.parseDatetimeStr !== 'function') {
                        return null;
                    }
                    return window.BookingTimeUtils.parseDatetimeStr(dtStr);
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –º–∏–Ω—É—Ç –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏ –≤ HH:MM
                function formatTimeHHMM(totalMinutes) {
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.formatTimeHHMM !== 'function') {
                        return '';
                    }
                    return window.BookingTimeUtils.formatTimeHHMM(totalMinutes);
                }

                // –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ HH:MM –≤ –º–∏–Ω—É—Ç—ã –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏
                function parseTimeToMinutes(timeStr) {
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.parseTimeToMinutes !== 'function') {
                        return 0;
                    }
                    return window.BookingTimeUtils.parseTimeToMinutes(timeStr);
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                function formatDurationHuman(totalMinutes) {
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.formatDurationHuman !== 'function') {
                        return '';
                    }
                    return window.BookingTimeUtils.formatDurationHuman(totalMinutes);
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ HH:MM –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                function formatDurationHHMM(totalMinutes) {
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.formatDurationHHMM !== 'function') {
                        return '';
                    }
                    return window.BookingTimeUtils.formatDurationHHMM(totalMinutes);
                }

                // –°–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–ª–æ–≤–∞ "–ø–µ—Ä–∏–æ–¥"
                function formatPeriodsLabel(n) {
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.formatPeriodsLabel !== 'function') {
                        return '';
                    }
                    return window.BookingTimeUtils.formatPeriodsLabel(n);
                }

                // –ö—ç—à –±—Ä–æ–Ω–µ–π –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ –¥–∞—Ç—É (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AJAX, —Å–æ–¥–µ—Ä–∂–∏—Ç –í–°–ï –±—Ä–æ–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é)
                var roomBookingsCache = {
                    roomId: null,
                    date: null,
                    bookings: []
                };
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ –¥–∞—Ç—É —á–µ—Ä–µ–∑ AJAX (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é)
                function loadRoomBookingsForDate(roomId, dateIso, callback) {
                    // –ü—Ä–∏–≤–æ–¥–∏–º roomId –∫ —Å—Ç—Ä–æ–∫–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    var roomIdStr = String(roomId);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
                    if (roomBookingsCache.roomId === roomIdStr && roomBookingsCache.date === dateIso) {
                        if (callback) callback(roomBookingsCache.bookings);
                        return;
                    }

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.loadRoomBookingsForDate !== 'function') {
                        roomBookingsCache.roomId = roomIdStr;
                        roomBookingsCache.date = dateIso;
                        roomBookingsCache.bookings = [];
                        if (callback) callback([]);
                        return;
                    }

                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã (forceReload=true)
                    window.BookingTimeUtils.loadRoomBookingsForDate(roomIdStr, dateIso, null, function (intervals) {
                        roomBookingsCache.roomId = roomIdStr;
                        roomBookingsCache.date = dateIso;
                        roomBookingsCache.bookings = Array.isArray(intervals) ? intervals : [];
                        if (callback) callback(roomBookingsCache.bookings);
                    }, true);
                }
                
                // --- –ö—ç—à –∑–∞–Ω—è—Ç—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –Ω–∞ –¥–∞—Ç—É ---
                // –í–∞–∂–Ω–æ: endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã "busy" –∫–∞–∫ –æ—Ç –±—Ä–æ–Ω–µ–π, —Ç–∞–∫ –∏ –æ—Ç
                // —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ —Ä–∞–±–æ—á–∏—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤).
                var busySpecialistsCache = {
                    date: null,
                    specialists: [] // [{id, name, intervals: [{startMinutes, endMinutes}]}]
                };
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–Ω—è—Ç—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –Ω–∞ –¥–∞—Ç—É —á–µ—Ä–µ–∑ AJAX
                function loadBusySpecialistsForDate(dateIso, callback) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
                    if (busySpecialistsCache.date === dateIso) {
                        if (callback) callback(busySpecialistsCache.specialists);
                        return;
                    }
                    
                    var url = '/booking/busy-specialists-for-date/?date=' + encodeURIComponent(dateIso);
                    
                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.success && Array.isArray(data.busy_specialists)) {
                            busySpecialistsCache.date = dateIso;
                            busySpecialistsCache.specialists = data.busy_specialists;
                            if (callback) callback(data.busy_specialists);
                        } else {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–Ω—è—Ç—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤:', data.error || 'unknown');
                            if (callback) callback([]);
                        }
                    })
                    .catch(function(error) {
                        console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–Ω—è—Ç—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤:', error);
                        if (callback) callback([]);
                    });
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–Ω—è—Ç –ª–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                function isSpecialistBusy(specialistId, startMinutes, endMinutes) {
                    var busySpecs = busySpecialistsCache.specialists || [];
                    for (var i = 0; i < busySpecs.length; i++) {
                        if (busySpecs[i].id === specialistId) {
                            var intervals = busySpecs[i].intervals || [];
                            for (var j = 0; j < intervals.length; j++) {
                                var interval = intervals[j];
                                // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–æ–≥—É—Ç –æ–∑–Ω–∞—á–∞—Ç—å –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–Ω—è—Ç–æ—Å—Ç—å –±—Ä–æ–Ω—å—é,
                                // —Ç–∞–∫ –∏ "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (gaps).
                                // –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ: (start1 < end2) && (end1 > start2)
                                if (startMinutes < interval.endMinutes && endMinutes > interval.startMinutes) {
                                    return true;
                                }
                            }
                            break;
                        }
                    }
                    return false;
                }
                // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
                window.isSpecialistBusy = isSpecialistBusy;
                
                // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                function getAvailableSpecialistIds(startMinutes, endMinutes) {
                    var busySpecs = busySpecialistsCache.specialists || [];
                    var busyIds = [];
                    for (var i = 0; i < busySpecs.length; i++) {
                        if (isSpecialistBusy(busySpecs[i].id, startMinutes, endMinutes)) {
                            busyIds.push(busySpecs[i].id);
                        }
                    }
                    return busyIds;
                }
                
                // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É (–∏–∑ –∫—ç—à–∞)
                function getRoomBookingsForDate(currentRoomId, dateIso) {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑ –∫—ç—à–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ loadRoomBookingsForDate)
                    if (roomBookingsCache.roomId === String(currentRoomId) && roomBookingsCache.date === dateIso) {
                        return roomBookingsCache.bookings;
                    }
                    // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç
                    var bookings = window.bookingsInRange || (typeof bookingsInRange !== 'undefined' ? bookingsInRange : []);
                    if (!Array.isArray(bookings)) return [];

                    if (window.BookingTimeUtils && typeof window.BookingTimeUtils.normalizeRoomBookingsForDate === 'function') {
                        var filtered = bookings.filter(function (booking) {
                            return booking && String(booking.idroom) === String(currentRoomId);
                        });
                        return window.BookingTimeUtils.normalizeRoomBookingsForDate(filtered, dateIso, null);
                    }

                    return [];
                }

                // –í—ã—á–∏—Å–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ –¥–∞—Ç—É
                // –®–∞–≥ = 15 –º–∏–Ω—É—Ç (—à–∞–≥ —Å–µ—Ç–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è), —Å–ª–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å minMinutes –¥–æ –±—Ä–æ–Ω–∏/–∫–æ–Ω—Ü–∞ –¥–Ω—è
                function getAvailableStartTimeSlots(currentRoomId, dateIso) {
                    var workStart = getScenarioWorkTimeStartMinutes();
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getAvailableStartTimeSlots !== 'function') {
                        return [];
                    }

                    return window.BookingTimeUtils.getAvailableStartTimeSlots(roomBookings, workStart, workEnd, minMinutes);
                }

                // –í—ã—á–∏—Å–ª–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
                function getMaxPeriodsForStartTime(startTimeMinutes, currentRoomId, dateIso) {
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getMaxPeriodsForStartTime !== 'function') {
                        return 0;
                    }

                    return window.BookingTimeUtils.getMaxPeriodsForStartTime(startTimeMinutes, roomBookings, workEnd, minMinutes);
                }

                // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥—É–ª—è ---
                // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –≥–ª–∞–≤–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å. –°–ø–∏—Å–∫–∏ –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ –Ω–µ–π.
                var currentRoomId = roomIdField ? roomIdField.value : roomId;
                var minMinutes = getScenarioMinDurationMinutes();
                var clickedSlotMinutes = parseTimeToMinutes(timeHm);
                
                // –¢–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (null = –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è placeholder)
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö IIFE
                var currentStartTimeMinutes = null;
                var currentSelectedPeriods = 1;
                var currentEndTimeMinutes = null;
                
                // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
                function setStartTimeMinutes(val) {
                    currentStartTimeMinutes = val;
                    window.currentStartTimeMinutes = val;
                }
                function setEndTimeMinutes(val) {
                    currentEndTimeMinutes = val;
                    window.currentEndTimeMinutes = val;
                }
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                window.currentStartTimeMinutes = null;
                window.currentEndTimeMinutes = null;

                // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
                var startTimeSelect = document.getElementById('start-time');
                var durationSelect = document.getElementById('duration');
                var endTimeSelect = document.getElementById('end-time');
                var submitBtn = document.getElementById('createBookingSubmitBtn');

                // --- –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ ---

                // –ü–æ–ª—É—á–∏—Ç—å —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞, —Å –∫–æ—Ç–æ—Ä—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–æ >= requiredPeriods –ø–µ—Ä–∏–æ–¥–æ–≤
                function getStartTimeSlotsForPeriods(requiredPeriods) {
                    var workStart = getScenarioWorkTimeStartMinutes();
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getStartTimeSlotsForPeriods !== 'function') {
                        return [];
                    }

                    return window.BookingTimeUtils.getStartTimeSlotsForPeriods(requiredPeriods, roomBookings, workStart, workEnd, minMinutes);
                }

                // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–ª-–≤–∞ –ø–µ—Ä–∏–æ–¥–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω–æ)
                function getAllEndTimesForPeriods(requiredPeriods) {
                    var workStart = getScenarioWorkTimeStartMinutes();
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getAllEndTimesForPeriods !== 'function') {
                        return [];
                    }

                    return window.BookingTimeUtils.getAllEndTimesForPeriods(requiredPeriods, roomBookings, workStart, workEnd, minMinutes);
                }

                // –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º–µ–Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è "–≤–ø—Ä–∞–≤–æ" –æ—Ç –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ (–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—Ç–∞)
                function getEndTimesForStartTime(startTimeMinutes) {
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getEndTimesForStartTime !== 'function') {
                        return [];
                    }

                    return window.BookingTimeUtils.getEndTimesForStartTime(startTimeMinutes, roomBookings, workEnd, minMinutes);
                }

                // –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞ "–≤–ª–µ–≤–æ" –æ—Ç –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—Ç–∞)
                function getStartTimesForEndTime(endTimeMinutes) {
                    var workStart = getScenarioWorkTimeStartMinutes();
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getStartTimesForEndTime !== 'function') {
                        return [];
                    }

                    return window.BookingTimeUtils.getStartTimesForEndTime(endTimeMinutes, roomBookings, workStart, workEnd, minMinutes);
                }

                // --- –í—ã—á–∏—Å–ª–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤ ---
                function getGlobalMaxPeriods() {
                    var workStart = getScenarioWorkTimeStartMinutes();
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getGlobalMaxPeriods !== 'function') {
                        return 0;
                    }

                    return window.BookingTimeUtils.getGlobalMaxPeriods(roomBookings, workStart, workEnd, minMinutes);
                }

                // --- –í—ã—á–∏—Å–ª–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è ---
                function getMaxPeriodsForEndTime(endTimeMinutes) {
                    var workStart = getScenarioWorkTimeStartMinutes();
                    var workEnd = getScenarioWorkTimeEndMinutes();
                    var roomBookings = getRoomBookingsForDate(currentRoomId, dateIso);

                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.getMaxPeriodsForEndTime !== 'function') {
                        return 0;
                    }

                    return window.BookingTimeUtils.getMaxPeriodsForEndTime(endTimeMinutes, roomBookings, workStart, workEnd, minMinutes);
                }

                // --- –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è UI ---

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
                function updateSubmitButtonState() {
                    if (!submitBtn) return;
                    
                    var checklist = [];
                    var hasStartTime = currentStartTimeMinutes !== null;
                    var hasEndTime = currentEndTimeMinutes !== null;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                    var isRepPoint = (window.currentScenarioName === '–†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞');
                    var isMusicClass = (window.currentScenarioName === '–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å');
                    var isSimplifiedScenario = isRepPoint || isMusicClass;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
                    var startTimeWarning = document.getElementById('start-time-warning-icon');
                    var endTimeWarning = document.getElementById('end-time-warning-icon');
                    var teacherWarning = document.getElementById('teacher-warning-icon');
                    var hasStartWarning = startTimeWarning && startTimeWarning.style.display !== 'none';
                    var hasEndWarning = endTimeWarning && endTimeWarning.style.display !== 'none';
                    var hasTeacherWarning = teacherWarning && teacherWarning.style.display !== 'none';

                    var startTimeSelectForWarning = document.getElementById('start-time');
                    if (startTimeSelectForWarning) {
                        startTimeSelectForWarning.classList.toggle('has-warning', !!hasStartWarning);
                    }

                    var endTimeSelectForWarning = document.getElementById('end-time');
                    if (endTimeSelectForWarning) {
                        endTimeSelectForWarning.classList.toggle('has-warning', !!hasEndWarning);
                    }

                    var teacherSelectForWarning = document.getElementById('teacher');
                    if (teacherSelectForWarning) {
                        teacherSelectForWarning.classList.toggle('has-warning', !isSimplifiedScenario && !!hasTeacherWarning);
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∫–ª–∏–µ–Ω—Ç–∞/–≥—Ä—É–ø–ø—É
                    var teacherSelect = document.getElementById('teacher');
                    var directionSelect = document.getElementById('field-direction');
                    var clientSelect = document.getElementById('client');
                    var teacherSelectedLi = teacherSelect ? teacherSelect.querySelector('ul.options li.selected') : null;
                    var directionSelectedLi = directionSelect ? directionSelect.querySelector('ul.options li.selected') : null;
                    var clientSelectedLi = clientSelect ? clientSelect.querySelector('ul.options li.selected:not(#search-option)') : null;
                    var hasTeacher = teacherSelectedLi !== null;
                    var hasDirection = directionSelectedLi !== null;
                    // –î–ª—è "–†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞" –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –≥—Ä—É–ø–ø–∞, –¥–ª—è –¥—Ä—É–≥–∏—Ö - —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç
                    var hasClient = clientSelectedLi !== null && clientSelectedLi.getAttribute('data-value');
                    // –ì—Ä—É–ø–ø–∞ —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º –≤—ã–±–æ—Ä–æ–º
                    var isGroupSelected = clientSelectedLi && clientSelectedLi.getAttribute('data-type') === 'group';
                    var hasClientOrGroup = hasClient || isGroupSelected;
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —á–µ–∫-–ª–∏—Å—Ç
                    if (!hasStartTime) {
                        checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞');
                    } else if (hasStartWarning) {
                        checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞');
                    }
                    
                    if (!hasEndTime) {
                        checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                    } else if (hasEndWarning) {
                        checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                    }

                    if (currentSelectedPeriods === null) {
                        checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å');
                    }
                    
                    // –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–±—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã
                    if (!isSimplifiedScenario) {
                        if (!hasTeacher) {
                            checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è');
                        } else if (hasTeacherWarning) {
                            checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è');
                        }
                        
                        if (!hasDirection) {
                            checklist.push('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
                        }
                    }
                    
                    // –î–ª—è –†–µ–ø—Ç–æ—á–∫–∏ - –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –≥—Ä—É–ø–ø–∞, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç
                    if (!hasClientOrGroup) {
                        checklist.push(isRepPoint ? '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –≥—Ä—É–ø–ø—É' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫-–ª–∏—Å—Ç –≤ —Ç—É–ª—Ç–∏–ø–µ
                    var submitWarning = document.getElementById('submit-warning-icon');
                    var submitChecklist = document.getElementById('submit-checklist');
                    
                    if (checklist.length > 0) {
                        // –ö–Ω–æ–ø–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
                        submitBtn.disabled = true;
                        if (submitWarning) submitWarning.style.display = 'inline-block';
                        if (submitChecklist) {
                            submitChecklist.innerHTML = checklist.map(function(item) {
                                return '<li>' + item + '</li>';
                            }).join('');
                        }
                    } else {
                        // –í—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
                        submitBtn.disabled = false;
                        if (submitWarning) submitWarning.style.display = 'none';
                    }
                }
                // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö IIFE
                window.updateSubmitButtonState = updateSubmitButtonState;

                // –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∫—Ä–µ—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ (–∫–ª–∞—Å—Å has-selection)
                function updateSelectHasSelection(selectEl, hasValue) {
                    if (window.BookingTimeUtils && typeof window.BookingTimeUtils.updateSelectHasSelection === 'function') {
                        window.BookingTimeUtils.updateSelectHasSelection(selectEl, hasValue);
                        return;
                    }
                    if (!selectEl) return;
                    if (hasValue) {
                        selectEl.classList.add('has-selection');
                    } else {
                        selectEl.classList.remove('has-selection');
                    }
                }

                // --- –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤ ---

                // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–µ–ª–µ–∫—Ç "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å" —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–µ—Ä–∏–æ–¥–æ–≤
                // selectedPeriods = null ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä "–≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥"
                function rebuildDurationSelect(selectedPeriods, maxPeriods) {
                    if (!durationSelect) return;
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.rebuildDurationSelect !== 'function') return;

                    window.BookingTimeUtils.rebuildDurationSelect(durationSelect, selectedPeriods, maxPeriods, minMinutes, function (periods) {
                        currentSelectedPeriods = periods;
                        onDurationChanged();
                    });
                }

                // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–µ–ª–µ–∫—Ç "–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞" —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º —Å–ª–æ—Ç–æ–≤
                function rebuildStartTimeSelect(slotsMinutes, selectedMinutes) {
                    if (!startTimeSelect) return;
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.rebuildStartTimeSelect !== 'function') return;

                    window.BookingTimeUtils.rebuildStartTimeSelect(startTimeSelect, slotsMinutes, selectedMinutes, function (liMinutes, liTimeStr) {
                        currentStartTimeMinutes = liMinutes;
                        if (timeField) timeField.value = liTimeStr;

                        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–≤—ã–±—Ä–∞–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ —Å–ø–∏—Å–∫–∞)
                        var startTimeWarning = document.getElementById('start-time-warning-icon');
                        var endTimeWarning = document.getElementById('end-time-warning-icon');
                        if (startTimeWarning) startTimeWarning.style.display = 'none';
                        if (endTimeWarning) endTimeWarning.style.display = 'none';

                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
                        var maxPeriodsForStart = getMaxPeriodsForStartTime(liMinutes, currentRoomId, dateIso);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–∫–æ–Ω—á–∞–Ω–∏–π "–≤–ø—Ä–∞–≤–æ" –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
                        var endTimesForStart = getEndTimesForStartTime(liMinutes);

                        if (currentSelectedPeriods !== null) {
                            // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–∞ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            var newEndTime = liMinutes + (minMinutes * currentSelectedPeriods);
                            if (currentSelectedPeriods <= maxPeriodsForStart && endTimesForStart.indexOf(newEndTime) !== -1) {
                                // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–º–µ—â–∞–µ—Ç—Å—è ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ
                                currentEndTimeMinutes = newEndTime;
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForStart);
                            } else {
                                // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                                currentEndTimeMinutes = null;
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForStart);
                            }
                            // –°–ø–∏—Å–æ–∫ –æ–∫–æ–Ω—á–∞–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            var filteredEndTimes = getAllEndTimesForPeriods(currentSelectedPeriods);
                            rebuildEndTimeSelect(filteredEndTimes, currentEndTimeMinutes);
                        } else if (currentEndTimeMinutes !== null) {
                            // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –Ω–æ –µ—Å—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏–µ ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                            var periodsBetween = Math.round((currentEndTimeMinutes - liMinutes) / minMinutes);
                            if (periodsBetween >= 1 && periodsBetween <= maxPeriodsForStart && endTimesForStart.indexOf(currentEndTimeMinutes) !== -1) {
                                // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∞–ª–∏–¥–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ –Ω–∞—á–∞–ª–∞
                                currentSelectedPeriods = periodsBetween;
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForStart);
                                rebuildEndTimeSelect(endTimesForStart, currentEndTimeMinutes);
                            } else if (maxPeriodsForStart === 1) {
                                // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –≤–∞–ª–∏–¥–Ω–æ, –Ω–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞
                                currentSelectedPeriods = 1;
                                currentEndTimeMinutes = liMinutes + minMinutes;
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForStart);
                                var filteredEndTimes = getAllEndTimesForPeriods(currentSelectedPeriods);
                                rebuildEndTimeSelect(filteredEndTimes, currentEndTimeMinutes);
                            } else {
                                // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –≤–∞–ª–∏–¥–Ω–æ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
                                currentEndTimeMinutes = null;
                                rebuildDurationSelect(null, maxPeriodsForStart);
                                rebuildEndTimeSelect(endTimesForStart, currentEndTimeMinutes);
                            }
                        } else {
                            // –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
                            if (maxPeriodsForStart === 1) {
                                // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞
                                currentSelectedPeriods = 1;
                                currentEndTimeMinutes = liMinutes + minMinutes;
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForStart);
                                var filteredEndTimes = getAllEndTimesForPeriods(currentSelectedPeriods);
                                rebuildEndTimeSelect(filteredEndTimes, currentEndTimeMinutes);
                            } else {
                                rebuildDurationSelect(null, maxPeriodsForStart);
                                rebuildEndTimeSelect(endTimesForStart, currentEndTimeMinutes);
                            }
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –ø–æ –Ω–æ–≤–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
                        window.currentStartTimeMinutes = currentStartTimeMinutes;
                        window.currentEndTimeMinutes = currentEndTimeMinutes;
                        applyTeacherDirectionFilters();
                        updateSubmitButtonState();

                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏
                        if (typeof window.calculateAndUpdateBookingCost === 'function') {
                            window.calculateAndUpdateBookingCost();
                        }
                    });
                }

                // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–µ–ª–µ–∫—Ç "–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è" —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω
                function rebuildEndTimeSelect(endTimesMinutes, selectedMinutes) {
                    if (!endTimeSelect) return;
                    if (!window.BookingTimeUtils || typeof window.BookingTimeUtils.rebuildEndTimeSelect !== 'function') return;

                    window.BookingTimeUtils.rebuildEndTimeSelect(endTimeSelect, endTimesMinutes, selectedMinutes, function (liMinutes, liTimeStr) {
                        currentEndTimeMinutes = liMinutes;

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞—á–∞–ª–∞ "–≤–ª–µ–≤–æ" –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        var startTimesForEnd = getStartTimesForEndTime(liMinutes);
                        var maxPeriodsForEnd = getMaxPeriodsForEndTime(liMinutes);

                        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–≤—ã–±—Ä–∞–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ —Å–ø–∏—Å–∫–∞)
                        var startTimeWarning = document.getElementById('start-time-warning-icon');
                        var endTimeWarning = document.getElementById('end-time-warning-icon');
                        if (startTimeWarning) startTimeWarning.style.display = 'none';
                        if (endTimeWarning) endTimeWarning.style.display = 'none';

                        if (currentSelectedPeriods !== null) {
                            // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–∞ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª–æ –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            var newStartTime = liMinutes - (minMinutes * currentSelectedPeriods);
                            if (startTimesForEnd.indexOf(newStartTime) !== -1) {
                                // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–º–µ—â–∞–µ—Ç—Å—è ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª–æ
                                currentStartTimeMinutes = newStartTime;
                                if (timeField) timeField.value = formatTimeHHMM(currentStartTimeMinutes);
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForEnd);
                            } else {
                                // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                                currentStartTimeMinutes = null;
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForEnd);
                            }
                            // –°–ø–∏—Å–æ–∫ –Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            var filteredStartTimes = getStartTimeSlotsForPeriods(currentSelectedPeriods);
                            rebuildStartTimeSelect(filteredStartTimes, currentStartTimeMinutes);
                        } else if (currentStartTimeMinutes !== null) {
                            // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –Ω–æ –µ—Å—Ç—å –Ω–∞—á–∞–ª–æ ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                            var periodsBetween = Math.round((liMinutes - currentStartTimeMinutes) / minMinutes);
                            if (periodsBetween >= 1 && periodsBetween <= maxPeriodsForEnd && startTimesForEnd.indexOf(currentStartTimeMinutes) !== -1) {
                                // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤–∞–ª–∏–¥–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                                currentSelectedPeriods = periodsBetween;
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForEnd);
                                rebuildStartTimeSelect(startTimesForEnd, currentStartTimeMinutes);
                            } else if (maxPeriodsForEnd === 1) {
                                // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ –≤–∞–ª–∏–¥–Ω–æ, –Ω–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞
                                currentSelectedPeriods = 1;
                                currentStartTimeMinutes = liMinutes - minMinutes;
                                if (timeField) timeField.value = formatTimeHHMM(currentStartTimeMinutes);
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForEnd);
                                var filteredStartTimes = getStartTimeSlotsForPeriods(currentSelectedPeriods);
                                rebuildStartTimeSelect(filteredStartTimes, currentStartTimeMinutes);
                            } else {
                                // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ –≤–∞–ª–∏–¥–Ω–æ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
                                currentStartTimeMinutes = null;
                                rebuildDurationSelect(null, maxPeriodsForEnd);
                                rebuildStartTimeSelect(startTimesForEnd, currentStartTimeMinutes);
                            }
                        } else {
                            // –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
                            if (maxPeriodsForEnd === 1) {
                                // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞
                                currentSelectedPeriods = 1;
                                currentStartTimeMinutes = liMinutes - minMinutes;
                                if (timeField) timeField.value = formatTimeHHMM(currentStartTimeMinutes);
                                rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForEnd);
                                var filteredStartTimes = getStartTimeSlotsForPeriods(currentSelectedPeriods);
                                rebuildStartTimeSelect(filteredStartTimes, currentStartTimeMinutes);
                            } else {
                                rebuildDurationSelect(null, maxPeriodsForEnd);
                                rebuildStartTimeSelect(startTimesForEnd, currentStartTimeMinutes);
                            }
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –ø–æ –Ω–æ–≤–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
                        window.currentStartTimeMinutes = currentStartTimeMinutes;
                        window.currentEndTimeMinutes = currentEndTimeMinutes;
                        applyTeacherDirectionFilters();
                        updateSubmitButtonState();

                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏
                        if (typeof window.calculateAndUpdateBookingCost === 'function') {
                            window.calculateAndUpdateBookingCost();
                        }
                    });
                }

                // --- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º ---
                function syncStartTimeDisplay() {
                    if (!startTimeSelect) return;
                    var startSelectedSpan = startTimeSelect.querySelector('.selected');
                    var startOptionsUl = startTimeSelect.querySelector('ul.options');
                    
                    if (currentStartTimeMinutes === null) {
                        if (startSelectedSpan) {
                            startSelectedSpan.textContent = startTimeSelect.getAttribute('data-placeholder') || '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è';
                        }
                        updateSelectHasSelection(startTimeSelect, false);
                    } else {
                        if (startSelectedSpan) {
                            startSelectedSpan.textContent = formatTimeHHMM(currentStartTimeMinutes);
                        }
                        updateSelectHasSelection(startTimeSelect, true);
                    }
                    
                    if (startOptionsUl) {
                        startOptionsUl.querySelectorAll('li').forEach(function (li) {
                            var mins = parseInt(li.getAttribute('data-minutes'), 10);
                            if (mins === currentStartTimeMinutes) {
                                li.classList.add('selected');
                            } else {
                                li.classList.remove('selected');
                            }
                        });
                    }
                }

                // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤ ---

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–∫–∏ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è
                function onDurationChanged() {
                    var durationMinutes = minMinutes * currentSelectedPeriods;
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–≤—ã–±—Ä–∞–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞)
                    var startTimeWarning = document.getElementById('start-time-warning-icon');
                    var endTimeWarning = document.getElementById('end-time-warning-icon');
                    if (startTimeWarning) startTimeWarning.style.display = 'none';
                    if (endTimeWarning) endTimeWarning.style.display = 'none';
                    
                    // –°–ø–∏—Å–∫–∏ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    var filteredStartSlots = getStartTimeSlotsForPeriods(currentSelectedPeriods);
                    var filteredEndTimes = getAllEndTimesForPeriods(currentSelectedPeriods);
                    
                    if (currentStartTimeMinutes !== null) {
                        // –ï—Å—Ç—å –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ
                        var maxPeriodsForStart = getMaxPeriodsForStartTime(currentStartTimeMinutes, currentRoomId, dateIso);
                        if (currentSelectedPeriods <= maxPeriodsForStart) {
                            currentEndTimeMinutes = currentStartTimeMinutes + durationMinutes;
                        } else {
                            // –ü–µ—Ä–∏–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞—á–∞–ª–∞ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±–∞
                            currentStartTimeMinutes = null;
                            currentEndTimeMinutes = null;
                        }
                        
                        rebuildStartTimeSelect(filteredStartSlots, currentStartTimeMinutes);
                        rebuildEndTimeSelect(filteredEndTimes, currentEndTimeMinutes);
                    } else if (currentEndTimeMinutes !== null) {
                        // –ï—Å—Ç—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª–æ
                        var potentialStart = currentEndTimeMinutes - durationMinutes;
                        
                        if (filteredStartSlots.indexOf(potentialStart) !== -1) {
                            currentStartTimeMinutes = potentialStart;
                            if (timeField) timeField.value = formatTimeHHMM(currentStartTimeMinutes);
                        } else {
                            // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–ª—è —ç—Ç–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                            currentEndTimeMinutes = null;
                        }
                        
                        rebuildStartTimeSelect(filteredStartSlots, currentStartTimeMinutes);
                        rebuildEndTimeSelect(filteredEndTimes, currentEndTimeMinutes);
                    } else {
                        // –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî —Å–ø–∏—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                        rebuildStartTimeSelect(filteredStartSlots, null);
                        rebuildEndTimeSelect(filteredEndTimes, null);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –ø–æ –Ω–æ–≤–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
                    window.currentStartTimeMinutes = currentStartTimeMinutes;
                    window.currentEndTimeMinutes = currentEndTimeMinutes;
                    applyTeacherDirectionFilters();
                    updateSubmitButtonState();
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏
                    calculateAndUpdateBookingCost();
                }

                // --- –§—É–Ω–∫—Ü–∏–∏ —Å–±—Ä–æ—Å–∞ —Å–µ–ª–µ–∫—Ç–æ–≤ (–ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫—Ä–µ—Å—Ç–∏–∫–∞) ---

                // –°–±—Ä–æ—Å —Å–µ–ª–µ–∫—Ç–∞ "–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞": —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
                function resetStartTime() {
                    currentStartTimeMinutes = null;
                    // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º —Å–ª–æ—Ç–µ
                    var startTimeWarning = document.getElementById('start-time-warning-icon');
                    if (startTimeWarning) startTimeWarning.style.display = 'none';
                    
                    if (currentEndTimeMinutes !== null) {
                        // –ï—Å—Ç—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞—á–∞–ª–∞ "–≤–ª–µ–≤–æ", —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                        var startTimesForEnd = getStartTimesForEndTime(currentEndTimeMinutes);
                        var maxPeriodsForEnd = getMaxPeriodsForEndTime(currentEndTimeMinutes);
                        currentSelectedPeriods = null;
                        rebuildDurationSelect(null, maxPeriodsForEnd);
                        rebuildStartTimeSelect(startTimesForEnd, null);
                        rebuildEndTimeSelect(getAllEndTimesForPeriods(1), currentEndTimeMinutes);
                    } else {
                        // –û–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏
                        currentSelectedPeriods = null;
                        rebuildDurationSelect(null, getGlobalMaxPeriods());
                        rebuildStartTimeSelect(getStartTimeSlotsForPeriods(1), null);
                        rebuildEndTimeSelect(getAllEndTimesForPeriods(1), null);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
                    window.currentStartTimeMinutes = currentStartTimeMinutes;
                    window.currentEndTimeMinutes = currentEndTimeMinutes;
                    applyTeacherDirectionFilters();
                    updateSubmitButtonState();
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏
                    if (typeof window.calculateAndUpdateBookingCost === 'function') {
                        window.calculateAndUpdateBookingCost();
                    }
                }

                // –°–±—Ä–æ—Å —Å–µ–ª–µ–∫—Ç–∞ "–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è": —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
                function resetEndTime() {
                    currentEndTimeMinutes = null;
                    // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    var endTimeWarning = document.getElementById('end-time-warning-icon');
                    if (endTimeWarning) endTimeWarning.style.display = 'none';
                    
                    if (currentStartTimeMinutes !== null) {
                        // –ï—Å—Ç—å –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ ‚Äî —Å–ø–∏—Å–æ–∫ –æ–∫–æ–Ω—á–∞–Ω–∏–π "–≤–ø—Ä–∞–≤–æ", —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                        var maxPeriodsForStart = getMaxPeriodsForStartTime(currentStartTimeMinutes, currentRoomId, dateIso);
                        var endTimesForStart = getEndTimesForStartTime(currentStartTimeMinutes);
                        currentSelectedPeriods = null;
                        rebuildDurationSelect(null, maxPeriodsForStart);
                        rebuildStartTimeSelect(getStartTimeSlotsForPeriods(1), currentStartTimeMinutes);
                        rebuildEndTimeSelect(endTimesForStart, null);
                    } else {
                        // –û–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏
                        currentSelectedPeriods = null;
                        rebuildDurationSelect(null, getGlobalMaxPeriods());
                        rebuildStartTimeSelect(getStartTimeSlotsForPeriods(1), null);
                        rebuildEndTimeSelect(getAllEndTimesForPeriods(1), null);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
                    window.currentStartTimeMinutes = currentStartTimeMinutes;
                    window.currentEndTimeMinutes = currentEndTimeMinutes;
                    applyTeacherDirectionFilters();
                    updateSubmitButtonState();
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏
                    if (typeof window.calculateAndUpdateBookingCost === 'function') {
                        window.calculateAndUpdateBookingCost();
                    }
                }

                // –°–±—Ä–æ—Å —Å–µ–ª–µ–∫—Ç–∞ "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å": —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                function resetDuration() {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä "–≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥"
                    currentSelectedPeriods = null;
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–æ–º–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
                    var startTimeWarning = document.getElementById('start-time-warning-icon');
                    var endTimeWarning = document.getElementById('end-time-warning-icon');
                    if (startTimeWarning) startTimeWarning.style.display = 'none';
                    if (endTimeWarning) endTimeWarning.style.display = 'none';
                    
                    if (currentStartTimeMinutes !== null) {
                        // –ï—Å—Ç—å –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ ‚Äî —Å–ø–∏—Å–æ–∫ –æ–∫–æ–Ω—á–∞–Ω–∏–π "–≤–ø—Ä–∞–≤–æ", —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ
                        var maxPeriodsForStart = getMaxPeriodsForStartTime(currentStartTimeMinutes, currentRoomId, dateIso);
                        var endTimesForStart = getEndTimesForStartTime(currentStartTimeMinutes);
                        currentEndTimeMinutes = null;
                        rebuildDurationSelect(null, maxPeriodsForStart);
                        rebuildStartTimeSelect(getStartTimeSlotsForPeriods(1), currentStartTimeMinutes);
                        rebuildEndTimeSelect(endTimesForStart, null);
                    } else if (currentEndTimeMinutes !== null) {
                        // –ï—Å—Ç—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞—á–∞–ª–∞ "–≤–ª–µ–≤–æ", —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ
                        var startTimesForEnd = getStartTimesForEndTime(currentEndTimeMinutes);
                        var maxPeriodsForEnd = getMaxPeriodsForEndTime(currentEndTimeMinutes);
                        currentStartTimeMinutes = null;
                        rebuildDurationSelect(null, maxPeriodsForEnd);
                        rebuildStartTimeSelect(startTimesForEnd, null);
                        rebuildEndTimeSelect(getAllEndTimesForPeriods(1), currentEndTimeMinutes);
                    } else {
                        // –û–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏
                        rebuildDurationSelect(null, getGlobalMaxPeriods());
                        rebuildStartTimeSelect(getStartTimeSlotsForPeriods(1), null);
                        rebuildEndTimeSelect(getAllEndTimesForPeriods(1), null);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
                    window.currentStartTimeMinutes = currentStartTimeMinutes;
                    window.currentEndTimeMinutes = currentEndTimeMinutes;
                    applyTeacherDirectionFilters();
                    updateSubmitButtonState();
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏ (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–±—Ä–æ—à–µ–Ω–∞ ‚Äî —Å—Ç–æ–∏–º–æ—Å—Ç—å 0)
                    calculateAndUpdateBookingCost();
                }

                // --- –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–±—Ä–æ—Å–∞ (–∫—Ä–µ—Å—Ç–∏–∫–æ–≤) ---
                function bindClearButtons() {
                    var startClearBtn = startTimeSelect ? startTimeSelect.querySelector('.custom-select-clear') : null;
                    var endClearBtn = endTimeSelect ? endTimeSelect.querySelector('.custom-select-clear') : null;
                    var durationClearBtn = durationSelect ? durationSelect.querySelector('.custom-select-clear') : null;
                    
                    if (startClearBtn) {
                        startClearBtn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            resetStartTime();
                            startTimeSelect.classList.remove('open');
                        });
                    }
                    
                    if (endClearBtn) {
                        endClearBtn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            resetEndTime();
                            endTimeSelect.classList.remove('open');
                        });
                    }
                    
                    if (durationClearBtn) {
                        durationClearBtn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            resetDuration();
                            durationSelect.classList.remove('open');
                        });
                    }
                }

                // =====================================================
                // –ú–û–î–£–õ–¨ –ö–ê–õ–ï–ù–î–ê–†–Ø (DATEPICKER)
                // =====================================================
                
                var datepickerTrigger = document.getElementById('datepicker-trigger');
                var datepickerPopup = document.getElementById('datepicker-popup');
                var datepickerDisplay = document.getElementById('datepicker-display');
                var datepickerGrid = document.getElementById('datepicker-grid');
                var datepickerMonthSelect = document.getElementById('datepicker-month');
                var datepickerYearSelect = document.getElementById('datepicker-year');
                var datepickerPrevBtn = document.getElementById('datepicker-prev');
                var datepickerNextBtn = document.getElementById('datepicker-next');
                var datepickerTodayBtn = document.getElementById('datepicker-today');
                var datepickerInput = document.getElementById('modal-create-date');
                
                // –¢–µ–∫—É—â–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –º–µ—Å—è—Ü –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
                var datepickerCurrentMonth = new Date(dateIso);
                // –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
                var datepickerSelectedDate = new Date(dateIso);
                
                var monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                                  '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "13 –¥–µ–∫–∞–±—Ä—è 2025")
                function formatDateDisplay(date) {
                    var day = date.getDate();
                    var monthIdx = date.getMonth();
                    var year = date.getFullYear();
                    var monthNamesGenitive = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                                              '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
                    return day + ' ' + monthNamesGenitive[monthIdx] + ' ' + year;
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≤ ISO (YYYY-MM-DD)
                function formatDateIso(date) {
                    var y = date.getFullYear();
                    var m = String(date.getMonth() + 1).padStart(2, '0');
                    var d = String(date.getDate()).padStart(2, '0');
                    return y + '-' + m + '-' + d;
                }
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ select –º–µ—Å—è—Ü–µ–≤
                function populateMonthSelect() {
                    datepickerMonthSelect.innerHTML = '';
                    for (var i = 0; i < 12; i++) {
                        var opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = monthNames[i];
                        if (i === datepickerCurrentMonth.getMonth()) {
                            opt.selected = true;
                        }
                        datepickerMonthSelect.appendChild(opt);
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ select –≥–æ–¥–æ–≤ (—Ç–µ–∫—É—â–∏–π –≥–æ–¥ ¬±5)
                function populateYearSelect() {
                    datepickerYearSelect.innerHTML = '';
                    var currentYear = new Date().getFullYear();
                    for (var y = currentYear - 2; y <= currentYear + 3; y++) {
                        var opt = document.createElement('option');
                        opt.value = y;
                        opt.textContent = y;
                        if (y === datepickerCurrentMonth.getFullYear()) {
                            opt.selected = true;
                        }
                        datepickerYearSelect.appendChild(opt);
                    }
                }
                
                // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ –¥–Ω–µ–π
                function buildDatepickerGrid() {
                    datepickerGrid.innerHTML = '';
                    
                    var year = datepickerCurrentMonth.getFullYear();
                    var month = datepickerCurrentMonth.getMonth();
                    
                    // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
                    var firstDay = new Date(year, month, 1);
                    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ —á–∏—Å–ª–∞ (0=–í—Å, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ü–Ω=0)
                    var startDayOfWeek = (firstDay.getDay() + 6) % 7;
                    
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
                    var lastDay = new Date(year, month + 1, 0);
                    var daysInMonth = lastDay.getDate();
                    
                    // –ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü ‚Äî –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫
                    var prevMonthLastDay = new Date(year, month, 0).getDate();
                    
                    var today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                    for (var i = startDayOfWeek - 1; i >= 0; i--) {
                        var dayNum = prevMonthLastDay - i;
                        var cell = document.createElement('div');
                        cell.className = 'modal-datepicker__day modal-datepicker__day--outside';
                        cell.textContent = dayNum;
                        datepickerGrid.appendChild(cell);
                    }
                    
                    // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                    for (var d = 1; d <= daysInMonth; d++) {
                        var cell = document.createElement('div');
                        cell.className = 'modal-datepicker__day';
                        cell.textContent = d;
                        
                        var cellDate = new Date(year, month, d);
                        cellDate.setHours(0, 0, 0, 0);
                        
                        // –°–µ–≥–æ–¥–Ω—è
                        if (cellDate.getTime() === today.getTime()) {
                            cell.classList.add('modal-datepicker__day--today');
                        }
                        
                        // –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
                        if (datepickerSelectedDate &&
                            cellDate.getFullYear() === datepickerSelectedDate.getFullYear() &&
                            cellDate.getMonth() === datepickerSelectedDate.getMonth() &&
                            cellDate.getDate() === datepickerSelectedDate.getDate()) {
                            cell.classList.add('modal-datepicker__day--selected');
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                        (function(dayDate) {
                            cell.addEventListener('click', function() {
                                onDateSelected(dayDate);
                            });
                        })(cellDate);
                        
                        datepickerGrid.appendChild(cell);
                    }
                    
                    // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ –∫–æ–Ω—Ü–∞ —Å–µ—Ç–∫–∏)
                    var totalCells = datepickerGrid.children.length;
                    var remainingCells = (7 - (totalCells % 7)) % 7;
                    for (var n = 1; n <= remainingCells; n++) {
                        var cell = document.createElement('div');
                        cell.className = 'modal-datepicker__day modal-datepicker__day--outside';
                        cell.textContent = n;
                        datepickerGrid.appendChild(cell);
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                function renderDatepicker() {
                    populateMonthSelect();
                    populateYearSelect();
                    buildDatepickerGrid();
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
                function onDateSelected(newDate) {
                    datepickerSelectedDate = newDate;
                    var newDateIso = formatDateIso(newDate);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã—Ç—ã–π input (–ø–æ–ª—É—á–∞–µ–º –ø–æ ID —Ç.–∫. —ç–ª–µ–º–µ–Ω—Ç –º–æ–≥ –±—ã—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω)
                    var displayEl = document.getElementById('datepicker-display');
                    if (displayEl) displayEl.textContent = formatDateDisplay(newDate);
                    datepickerInput.value = newDateIso;
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
                    datepickerPopup.classList.remove('open');
                    
                    // --- –ü–µ—Ä–µ—Å—á—ë—Ç —Å–ø–∏—Å–∫–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –Ω–æ–≤–æ–π –¥–∞—Ç—ã ---
                    dateIso = newDateIso;
                    if (dateField) dateField.value = dateIso;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –±—Ä–æ–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ –Ω–æ–≤—É—é –¥–∞—Ç—É —á–µ—Ä–µ–∑ AJAX –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
                    loadRoomBookingsForDate(currentRoomId, dateIso, function() {
                        // –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
                        var startTimeWarning = document.getElementById('start-time-warning-icon');
                        var endTimeWarning = document.getElementById('end-time-warning-icon');
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        if (startTimeWarning) startTimeWarning.style.display = 'none';
                        if (endTimeWarning) endTimeWarning.style.display = 'none';
                        
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–Ω—è
                        var newAllSlots = getStartTimeSlotsForPeriods(1);
                        var newGlobalMaxPeriods = getGlobalMaxPeriods();
                        
                        // –§–ª–∞–≥–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
                        var startTimeValid = true;
                        var endTimeValid = true;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
                        if (currentStartTimeMinutes !== null) {
                            var newMaxPeriodsForStart = getMaxPeriodsForStartTime(currentStartTimeMinutes, currentRoomId, dateIso);
                            if (newMaxPeriodsForStart < 1) {
                                // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
                                startTimeValid = false;
                                if (startTimeWarning) startTimeWarning.style.display = 'inline-block';
                            }
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        if (currentEndTimeMinutes !== null && currentStartTimeMinutes !== null) {
                            if (!startTimeValid) {
                                // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ ‚Äî –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–æ–∂–µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ
                                endTimeValid = false;
                                if (endTimeWarning) endTimeWarning.style.display = 'inline-block';
                            } else {
                                var newMaxPeriodsForStart = getMaxPeriodsForStartTime(currentStartTimeMinutes, currentRoomId, dateIso);
                                var maxEndTime = currentStartTimeMinutes + (minMinutes * newMaxPeriodsForStart);
                                if (currentEndTimeMinutes > maxEndTime) {
                                    // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
                                    endTimeValid = false;
                                    if (endTimeWarning) endTimeWarning.style.display = 'inline-block';
                                }
                            }
                        }
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
                        if (currentStartTimeMinutes !== null && startTimeValid) {
                            var newMaxPeriodsForStart = getMaxPeriodsForStartTime(currentStartTimeMinutes, currentRoomId, dateIso);
                            
                            // –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ
                            if (newMaxPeriodsForStart === 1 && currentSelectedPeriods === null && currentEndTimeMinutes === null) {
                                currentSelectedPeriods = 1;
                                currentEndTimeMinutes = currentStartTimeMinutes + minMinutes;
                                endTimeValid = true;
                                if (endTimeWarning) endTimeWarning.style.display = 'none';
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç, –¥–µ–ª–∞–µ–º –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ–π —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
                            if (currentSelectedPeriods !== null && currentSelectedPeriods > newMaxPeriodsForStart) {
                                // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –Ω–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–∏
                                endTimeValid = false;
                                if (endTimeWarning) endTimeWarning.style.display = 'inline-block';
                            }
                            
                            // –°—Ç—Ä–æ–∏–º —Å–ø–∏—Å–∫–∏
                            if (currentSelectedPeriods !== null) {
                                // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–∞ ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å–ø–∏—Å–∫–∏ –ø–æ –Ω–µ–π
                                var filteredStartSlots = getStartTimeSlotsForPeriods(currentSelectedPeriods);
                                var filteredEndTimes = getAllEndTimesForPeriods(currentSelectedPeriods);
                                rebuildStartTimeSelect(filteredStartSlots, currentStartTimeMinutes);
                                rebuildEndTimeSelect(filteredEndTimes, currentEndTimeMinutes);
                            } else {
                                var newEndTimes = getEndTimesForStartTime(currentStartTimeMinutes);
                                rebuildStartTimeSelect(newAllSlots, currentStartTimeMinutes);
                                rebuildEndTimeSelect(newEndTimes, currentEndTimeMinutes);
                            }
                            
                            rebuildDurationSelect(currentSelectedPeriods, newMaxPeriodsForStart);
                        } else {
                            // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                            if (currentSelectedPeriods !== null) {
                                var filteredSlots = getStartTimeSlotsForPeriods(currentSelectedPeriods);
                                var filteredEndTimes = getAllEndTimesForPeriods(currentSelectedPeriods);
                                rebuildStartTimeSelect(filteredSlots, currentStartTimeMinutes);
                                rebuildEndTimeSelect(filteredEndTimes, currentEndTimeMinutes);
                            } else {
                                rebuildStartTimeSelect(newAllSlots, currentStartTimeMinutes);
                                rebuildEndTimeSelect(getAllEndTimesForPeriods(1), currentEndTimeMinutes);
                            }
                            rebuildDurationSelect(currentSelectedPeriods, newGlobalMaxPeriods);
                        }
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω—è—Ç—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
                        window.currentStartTimeMinutes = currentStartTimeMinutes;
                        window.currentEndTimeMinutes = currentEndTimeMinutes;
                        loadBusySpecialistsForDate(dateIso, function() {
                            // applyTeacherDirectionFilters –≤—ã–∑–æ–≤–µ—Ç updateSubmitButtonState –≤–Ω—É—Ç—Ä–∏
                            applyTeacherDirectionFilters();
                        });
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è (—É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª–∏—Å—å)
                function replaceWithClone(el) {
                    if (!el) return null;
                    var clone = el.cloneNode(true);
                    el.parentNode.replaceChild(clone, el);
                    return clone;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                datepickerTrigger = replaceWithClone(datepickerTrigger);
                // –ü–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è trigger –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ display –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ
                datepickerDisplay = document.getElementById('datepicker-display');
                datepickerPrevBtn = replaceWithClone(datepickerPrevBtn);
                datepickerNextBtn = replaceWithClone(datepickerNextBtn);
                datepickerMonthSelect = replaceWithClone(datepickerMonthSelect);
                datepickerYearSelect = replaceWithClone(datepickerYearSelect);
                datepickerTodayBtn = replaceWithClone(datepickerTodayBtn);
                
                if (datepickerTrigger) {
                    datepickerTrigger.addEventListener('click', function(e) {
                        e.stopPropagation();
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–µ–ª–µ–∫—Ç—ã
                        var modal = document.getElementById('createBookingModal');
                        if (modal) {
                            modal.querySelectorAll('.custom-select.open').forEach(function(s) {
                                s.classList.remove('open');
                            });
                        }
                        datepickerPopup.classList.toggle('open');
                        if (datepickerPopup.classList.contains('open')) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—è—Ü –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
                            datepickerCurrentMonth = new Date(datepickerSelectedDate.getFullYear(), datepickerSelectedDate.getMonth(), 1);
                            renderDatepicker();
                        }
                    });
                }
                
                if (datepickerPrevBtn) {
                    datepickerPrevBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        datepickerCurrentMonth.setMonth(datepickerCurrentMonth.getMonth() - 1);
                        renderDatepicker();
                    });
                }
                
                if (datepickerNextBtn) {
                    datepickerNextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        datepickerCurrentMonth.setMonth(datepickerCurrentMonth.getMonth() + 1);
                        renderDatepicker();
                    });
                }
                
                if (datepickerMonthSelect) {
                    datepickerMonthSelect.addEventListener('change', function() {
                        datepickerCurrentMonth.setMonth(parseInt(this.value, 10));
                        renderDatepicker();
                    });
                }
                
                if (datepickerYearSelect) {
                    datepickerYearSelect.addEventListener('change', function() {
                        datepickerCurrentMonth.setFullYear(parseInt(this.value, 10));
                        renderDatepicker();
                    });
                }
                
                if (datepickerTodayBtn) {
                    datepickerTodayBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var today = new Date();
                        onDateSelected(today);
                    });
                }
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ø–∞–ø–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)
                if (!window._datepickerClickHandlerAdded) {
                    window._datepickerClickHandlerAdded = true;
                    document.addEventListener('click', function(e) {
                        var popup = document.getElementById('datepicker-popup');
                        var trigger = document.getElementById('datepicker-trigger');
                        if (popup && popup.classList.contains('open')) {
                            if (!popup.contains(e.target) && trigger && !trigger.contains(e.target)) {
                                popup.classList.remove('open');
                            }
                        }
                    });
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã (–ø–æ–ª—É—á–∞–µ–º –ø–æ ID –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
                var displayElInit = document.getElementById('datepicker-display');
                if (displayElInit) displayElInit.textContent = formatDateDisplay(datepickerSelectedDate);
                datepickerInput.value = dateIso;

                // --- –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
                bindClearButtons();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –±—Ä–æ–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ –¥–∞—Ç—É —á–µ—Ä–µ–∑ AJAX (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é)
                // –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç—ã
                loadRoomBookingsForDate(currentRoomId, dateIso, function() {
                    // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤
                    var allStartSlots = getStartTimeSlotsForPeriods(1);
                    var globalMaxPeriods = getGlobalMaxPeriods();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞–∂–∞—Ç–æ–≥–æ —Å–ª–æ—Ç–∞
                    var clickedSlotMaxPeriods = getMaxPeriodsForStartTime(clickedSlotMinutes, currentRoomId, dateIso);
                    var clickedSlotAvailable = clickedSlotMaxPeriods >= 1;
                    
                    // –≠–ª–µ–º–µ–Ω—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º —Å–ª–æ—Ç–µ
                    var startTimeWarning = document.getElementById('start-time-warning-icon');
                    
                    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ –ø–µ—Ä–∏–æ–¥ –ù–ï –≤—ã–±—Ä–∞–Ω—ã
                    currentSelectedPeriods = null;
                    currentEndTimeMinutes = null;
                    
                    if (clickedSlotAvailable) {
                        // –°–ª–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
                        currentStartTimeMinutes = clickedSlotMinutes;
                        if (startTimeWarning) startTimeWarning.style.display = 'none';
                        
                        // –ï—Å–ª–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞
                        if (clickedSlotMaxPeriods === 1) {
                            currentSelectedPeriods = 1;
                            currentEndTimeMinutes = clickedSlotMinutes + minMinutes;
                        }
                    } else {
                        // –°–ª–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–æ–º–∏–Ω–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ
                        currentStartTimeMinutes = clickedSlotMinutes;
                        if (startTimeWarning) startTimeWarning.style.display = 'inline-block';
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã
                    var maxPeriodsForStart = clickedSlotAvailable ? clickedSlotMaxPeriods : globalMaxPeriods;
                    rebuildDurationSelect(currentSelectedPeriods, maxPeriodsForStart);
                    rebuildStartTimeSelect(allStartSlots, currentStartTimeMinutes);
                    
                    // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: —Å–ø–∏—Å–æ–∫ "–≤–ø—Ä–∞–≤–æ" –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
                    var endTimes;
                    if (currentSelectedPeriods !== null) {
                        // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–∞ ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                        endTimes = getAllEndTimesForPeriods(currentSelectedPeriods);
                    } else if (clickedSlotAvailable) {
                        endTimes = getEndTimesForStartTime(clickedSlotMinutes);
                    } else {
                        endTimes = getAllEndTimesForPeriods(1);
                    }
                    rebuildEndTimeSelect(endTimes, currentEndTimeMinutes);
                    
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω—è—Ç—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
                    window.currentStartTimeMinutes = currentStartTimeMinutes;
                    window.currentEndTimeMinutes = currentEndTimeMinutes;
                    loadBusySpecialistsForDate(dateIso, function() {
                        // applyTeacherDirectionFilters –≤—ã–∑–æ–≤–µ—Ç updateSubmitButtonState –≤–Ω—É—Ç—Ä–∏
                        applyTeacherDirectionFilters();
                    });
                });

                if (dateField) dateField.value = dateIso;
                if (timeField) timeField.value = timeHm;
            }
        }
    }

    // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø–æ–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    document.addEventListener('DOMContentLoaded', function () {
        var textarea = document.getElementById('bookingComment');
        var counter = document.getElementById('bookingCommentCounter');
        var maxLength = 1000;

        if (!textarea || !counter) {
            return;
        }

        function updateCounter() {
            var val = textarea.value || '';

            if (val.length > maxLength) {
                textarea.value = val.slice(0, maxLength);
                val = textarea.value;
            }

            counter.textContent = val.length + '/' + maxLength;

            if (val.length >= maxLength) {
                counter.style.color = '#FF0000'; // –∫—Ä–∞—Å–Ω—ã–π
            } else if (val.length >= 900) {
                counter.style.color = '#FFA500'; // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
            } else {
                counter.style.color = '#818EA2'; // –æ–±—ã—á–Ω—ã–π
            }
        }

        textarea.addEventListener('input', updateCounter);
        updateCounter();
    });

    // –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π –º–æ–¥–∞–ª–∫–∏
    (function () {
        var modalElement = document.getElementById('createBookingModal');
        if (!modalElement) {
            return;
        }

        var teacherDirectionLastChanged = null;

        // --------------------------
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        // --------------------------

        function getSelectedValue(selectEl) {
            var selectedLi = selectEl.querySelector('ul.options li.selected');
            return selectedLi ? (selectedLi.getAttribute('data-value') || '') : '';
        }

        function syncClearableSelectState(selectEl) {
            if (!selectEl || !selectEl.classList.contains('custom-select--clearable')) {
                return;
            }

            var hasValue = Boolean(getSelectedValue(selectEl));
            if (hasValue) {
                selectEl.classList.add('has-selection');
            } else {
                selectEl.classList.remove('has-selection');
            }
        }

        function resetSelect(selectEl) {
            var selectedSpan = selectEl.querySelector('.selected');
            var placeholder = selectEl.getAttribute('data-placeholder') || (selectedSpan ? selectedSpan.textContent : '');
            var options = selectEl.querySelectorAll('ul.options li');

            options.forEach(function (li) {
                li.classList.remove('selected');
            });

            if (selectedSpan) {
                selectedSpan.textContent = placeholder;
            }

            syncClearableSelectState(selectEl);
        }

        function resetTeacherDirectionUI() {
            var teacherSelect = modalElement.querySelector('#teacher');
            var directionSelect = modalElement.querySelector('#field-direction');
            if (!teacherSelect || !directionSelect) {
                return;
            }

            resetSelect(teacherSelect);
            resetSelect(directionSelect);

            teacherSelect.querySelectorAll('ul.options li').forEach(function (li) {
                li.style.display = '';
            });
            directionSelect.querySelectorAll('ul.options li').forEach(function (li) {
                li.style.display = '';
            });
        }

        function applyTeacherDirectionFilters() {
            var teacherSelect = modalElement.querySelector('#teacher');
            var directionSelect = modalElement.querySelector('#field-direction');
            if (!teacherSelect || !directionSelect) {
                return;
            }

            var selectedTeacherId = getSelectedValue(teacherSelect);
            var selectedDirectionId = getSelectedValue(directionSelect);

            var teacherLis = teacherSelect.querySelectorAll('ul.options li');
            var directionLis = directionSelect.querySelectorAll('ul.options li');
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
            var startMinutes = window.currentStartTimeMinutes;
            var endMinutes = window.currentEndTimeMinutes;
            var teacherWarning = document.getElementById('teacher-warning-icon');
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            var checkStartMinutes = startMinutes;
            var checkEndMinutes = endMinutes;
            if (startMinutes !== null && endMinutes === null) {
                checkEndMinutes = startMinutes + 30;
            } else if (startMinutes === null && endMinutes !== null) {
                checkStartMinutes = endMinutes - 30;
            }

            // 1) –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
            var availableTeacherIds = [];
            var availableDirectionIds = new Set();
            
            teacherLis.forEach(function (li) {
                var teacherId = parseInt(li.getAttribute('data-value'), 10);
                var dirsRaw = li.getAttribute('data-directions') || '';
                var dirs = dirsRaw ? dirsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                var timeAvailable = true;
                if (checkStartMinutes !== null && checkEndMinutes !== null) {
                    timeAvailable = !window.isSpecialistBusy(teacherId, checkStartMinutes, checkEndMinutes);
                }
                
                if (timeAvailable && !isNaN(teacherId)) {
                    availableTeacherIds.push(teacherId);
                    // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
                    dirs.forEach(function(dirId) {
                        availableDirectionIds.add(dirId);
                    });
                }
            });

            // 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç: –µ—Å–ª–∏ –æ–±–∞ –≤—ã–±—Ä–∞–Ω—ã, –Ω–æ –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π
            if (selectedTeacherId && selectedDirectionId) {
                var selectedTeacherLi = teacherSelect.querySelector('ul.options li.selected');
                var teacherDirectionsRaw = selectedTeacherLi ? (selectedTeacherLi.getAttribute('data-directions') || '') : '';
                var teacherDirections = teacherDirectionsRaw ? teacherDirectionsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];

                if (teacherDirections.indexOf(String(selectedDirectionId)) === -1) {
                    if (teacherDirectionLastChanged === 'field-direction') {
                        resetSelect(teacherSelect);
                        selectedTeacherId = '';
                    } else {
                        resetSelect(directionSelect);
                        selectedDirectionId = '';
                    }
                }
            }

            // 3) –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
            var visibleDirectionCount = 0;
            var lastVisibleDirectionLi = null;
            
            if (selectedTeacherId) {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                var teacherLi = teacherSelect.querySelector('ul.options li.selected');
                var dirsRaw = teacherLi ? (teacherLi.getAttribute('data-directions') || '') : '';
                var allowedDirs = dirsRaw ? dirsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];

                directionLis.forEach(function (li) {
                    var dirId = li.getAttribute('data-value') || '';
                    var isVisible = allowedDirs.indexOf(String(dirId)) !== -1;
                    li.style.display = isVisible ? '' : 'none';
                    if (isVisible) {
                        visibleDirectionCount++;
                        lastVisibleDirectionLi = li;
                    }
                });
            } else {
                // –ï—Å–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
                directionLis.forEach(function (li) {
                    var dirId = li.getAttribute('data-value') || '';
                    var isVisible = availableDirectionIds.has(dirId);
                    li.style.display = isVisible ? '' : 'none';
                    if (isVisible) {
                        visibleDirectionCount++;
                        lastVisibleDirectionLi = li;
                    }
                });
            }
            
            // 4) –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
            var dirSelectedSpan = directionSelect.querySelector('span.selected');
            if (visibleDirectionCount === 0) {
                // –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
                directionSelect.classList.add('disabled');
                if (dirSelectedSpan) dirSelectedSpan.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π';
            } else {
                directionSelect.classList.remove('disabled');
                if (!selectedDirectionId && dirSelectedSpan) {
                    dirSelectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ';
                }
                
                // –ê–≤—Ç–æ-–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                if (visibleDirectionCount === 1 && !selectedDirectionId && lastVisibleDirectionLi) {
                    lastVisibleDirectionLi.classList.add('selected');
                    if (dirSelectedSpan) {
                        dirSelectedSpan.textContent = lastVisibleDirectionLi.textContent;
                    }
                    selectedDirectionId = lastVisibleDirectionLi.getAttribute('data-value');
                    syncClearableSelectState(directionSelect);
                }
            }

            // 5) –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
            var visibleTeacherCount = 0;
            var lastVisibleTeacherLi = null;
            
            teacherLis.forEach(function (li) {
                var teacherId = parseInt(li.getAttribute('data-value'), 10);
                var dirsRaw = li.getAttribute('data-directions') || '';
                var dirs = dirsRaw ? dirsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
                var directionMatch = !selectedDirectionId || dirs.indexOf(String(selectedDirectionId)) !== -1;
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
                var timeAvailable = availableTeacherIds.indexOf(teacherId) !== -1;
                
                var isVisible = directionMatch && timeAvailable;
                li.style.display = isVisible ? '' : 'none';
                if (isVisible) {
                    visibleTeacherCount++;
                    lastVisibleTeacherLi = li;
                }
            });
            
            // 6) –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
            var teacherSelectedSpan = teacherSelect.querySelector('span.selected');
            if (visibleTeacherCount === 0) {
                // –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
                teacherSelect.classList.add('disabled');
                teacherSelect.classList.remove('open');
                teacherSelect.classList.remove('has-selection');
                teacherLis.forEach(function (li) {
                    li.classList.remove('selected');
                });
                selectedTeacherId = '';
                if (teacherSelectedSpan) teacherSelectedSpan.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π';
                syncClearableSelectState(teacherSelect);
                if (teacherWarning) teacherWarning.style.display = 'none';
            } else {
                teacherSelect.classList.remove('disabled');
                if (!selectedTeacherId && teacherSelectedSpan) {
                    teacherSelectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è';
                }
                
                // –ê–≤—Ç–æ-–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
                if (visibleTeacherCount === 1 && !selectedTeacherId && lastVisibleTeacherLi) {
                    lastVisibleTeacherLi.classList.add('selected');
                    if (teacherSelectedSpan) {
                        teacherSelectedSpan.textContent = lastVisibleTeacherLi.textContent;
                    }
                    selectedTeacherId = lastVisibleTeacherLi.getAttribute('data-value');
                    syncClearableSelectState(teacherSelect);
                    
                    // –ï—Å–ª–∏ —É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ–¥–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ —Ç–æ–∂–µ
                    var singleTeacherDirsRaw = lastVisibleTeacherLi.getAttribute('data-directions') || '';
                    var singleTeacherDirs = singleTeacherDirsRaw ? singleTeacherDirsRaw.split(',').map(function (v) { return v.trim(); }).filter(Boolean) : [];
                    if (singleTeacherDirs.length === 1 && !selectedDirectionId) {
                        var singleDirId = singleTeacherDirs[0];
                        directionLis.forEach(function (li) {
                            if (li.getAttribute('data-value') === singleDirId) {
                                li.classList.add('selected');
                                if (dirSelectedSpan) {
                                    dirSelectedSpan.textContent = li.textContent;
                                }
                                syncClearableSelectState(directionSelect);
                            }
                        });
                    }
                }
            }
            
            // 7) –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
            if (selectedTeacherId && checkStartMinutes !== null && checkEndMinutes !== null) {
                var teacherIdInt = parseInt(selectedTeacherId, 10);
                if (window.isSpecialistBusy(teacherIdInt, checkStartMinutes, checkEndMinutes)) {
                    if (teacherWarning) teacherWarning.style.display = 'inline-block';
                } else {
                    if (teacherWarning) teacherWarning.style.display = 'none';
                }
            } else {
                if (teacherWarning) teacherWarning.style.display = 'none';
            }
            
            // –í—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
            if (typeof window.updateSubmitButtonState === 'function') {
                window.updateSubmitButtonState();
            }
        }
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
        window.applyTeacherDirectionFilters = applyTeacherDirectionFilters;

        function applyServicesFilters() {
            var servicesSelect = modalElement.querySelector('#services');
            if (!servicesSelect) {
                return;
            }

            var roomIdField = modalElement.querySelector('#roomIdField');
            var currentRoomId = roomIdField ? String(roomIdField.value || '') : '';
            var currentScenarioId = (window.currentScenarioFilterId !== undefined && window.currentScenarioFilterId !== null)
                ? String(window.currentScenarioFilterId)
                : '';

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è + –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π:
            // –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É.
            // –ö–ª—é—á: service_id + room_id + scenario_id
            var options = servicesSelect.querySelectorAll('ul.options li');
            var seen = new Map();

            Array.from(options).forEach(function (li) {
                var liRoomId = String(li.getAttribute('data-room-id') || '');
                var liScenarioId = String(li.getAttribute('data-scenario-id') || '');
                var liValue = String(li.getAttribute('data-value') || '');

                var dedupeKey = liValue + '|' + liRoomId + '|' + liScenarioId;
                if (seen.has(dedupeKey)) {
                    var kept = seen.get(dedupeKey);

                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –¥—É–±–ª—å, –∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤—ã–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –Ω–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π.
                    if (li.classList.contains('selected') && kept && !kept.classList.contains('selected')) {
                        kept.classList.add('selected');

                        if (servicesSelect._selectedOptions) {
                            servicesSelect._selectedOptions.add(kept);
                            servicesSelect._selectedOptions.delete(li);
                        }
                    }

                    if (li.parentNode) {
                        li.parentNode.removeChild(li);
                    }
                    return;
                }
                seen.set(dedupeKey, li);

                var roomOk = !liRoomId || !currentRoomId || liRoomId === currentRoomId;
                var scenarioOk = !liScenarioId || !currentScenarioId || liScenarioId === currentScenarioId;

                li.style.display = (roomOk && scenarioOk) ? '' : 'none';
            });

            if (servicesSelect._selectedOptions && servicesSelect._selectedOptions.size) {
                var changed = false;
                Array.from(servicesSelect._selectedOptions).forEach(function (opt) {
                    if (opt.style.display === 'none') {
                        opt.classList.remove('selected');
                        servicesSelect._selectedOptions.delete(opt);
                        changed = true;
                    }
                });

                if (changed && typeof servicesSelect._updateSelectedText === 'function') {
                    servicesSelect._updateSelectedText();
                }
            }
        }

        applyServicesFilters();

        // --------------------------
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ–≤
        // --------------------------
        var customSelects = Array.from(modalElement.querySelectorAll('.custom-select'));

        // –û–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ —Å–µ–ª–µ–∫—Ç–∞ (–±–µ–∑ –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏—è N –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π)
        document.addEventListener('click', function (e) {
            customSelects.forEach(function (select) {
                if (!select.contains(e.target)) {
                    select.classList.remove('open');
                }
            });
        });

        customSelects.forEach(function (select) {
            var selected = select.querySelector('.selected');
            var optionsContainer = select.querySelector('.options');
            if (!selected || !optionsContainer) {
                return;
            }

            var optionsList = optionsContainer.querySelectorAll('li');
            var isClientSelect = select.id === 'client';
            var searchInput = isClientSelect ? select.querySelector('#client-search-input') : null;
            var searchOption = isClientSelect ? select.querySelector('#search-option') : null;

            var clearBtn = select.querySelector('.custom-select-clear');
            if (clearBtn) {
                clearBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    teacherDirectionLastChanged = select.id;
                    resetSelect(select);
                    select.classList.remove('open');

                    if (select.id === 'teacher' || select.id === 'field-direction') {
                        applyTeacherDirectionFilters();
                    }
                });
            }

            syncClearableSelectState(select);

            // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å–ª—É–≥ (—Å–ø–∏—Å–æ–∫ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –≤—ã–±–æ—Ä–µ)
            if (select.id === 'services') {
                var selectedOptions = new Set();
                select._selectedOptions = selectedOptions;

                function updateSelectedText() {
                    if (selectedOptions.size === 0) {
                        selected.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É';
                    } else if (selectedOptions.size === 1) {
                        selected.textContent = Array.from(selectedOptions)[0].textContent;
                    } else {
                        selected.textContent = selectedOptions.size + ' –≤—ã–±—Ä–∞–Ω–æ';
                    }
                }

                select._updateSelectedText = updateSelectedText;

                select.addEventListener('click', function (e) {
                    if (e.target.tagName !== 'LI') {
                        select.classList.toggle('open');
                    }
                });

                optionsList.forEach(function (option) {
                    option.addEventListener('mousedown', function (e) {
                        e.stopPropagation();
                    });
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        if (option.classList.contains('selected')) {
                            option.classList.remove('selected');
                            selectedOptions.delete(option);
                        } else {
                            option.classList.add('selected');
                            selectedOptions.add(option);
                        }

                        updateSelectedText();
                        if (typeof window.updateServicesBadges === 'function') {
                            window.updateServicesBadges();
                        }
                        
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–æ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥
                        if (typeof window.calculateAndUpdateBookingCost === 'function') {
                            window.calculateAndUpdateBookingCost();
                        }
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë"
                var resetServicesBtn = document.getElementById('create-reset-services');
                if (resetServicesBtn) {
                    resetServicesBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        selectedOptions.clear();
                        optionsList.forEach(function(opt) {
                            opt.classList.remove('selected');
                        });
                        updateSelectedText();
                        if (typeof window.updateServicesBadges === 'function') {
                            window.updateServicesBadges();
                        }
                        if (typeof window.calculateAndUpdateBookingCost === 'function') {
                            window.calculateAndUpdateBookingCost();
                        }
                    });
                }

                return;
            }

            // –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
            if (isClientSelect && searchInput) {
                searchInput.addEventListener('input', function () {
                    var filter = this.value.trim().toLowerCase();
                    var currentOptionsList = optionsContainer.querySelectorAll('li');
                    currentOptionsList.forEach(function (option) {
                        if (option.id === 'search-option') {
                            return;
                        }
                        var text = option.textContent.trim().toLowerCase();
                        option.style.display = text.indexOf(filter) !== -1 ? '' : 'none';
                    });
                });

                if (searchOption) {
                    // –Ω–µ –¥–∞—ë–º –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç —Å –ø–æ–∏—Å–∫–æ–º –∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –Ω–µ–º—É
                    searchOption.addEventListener('mousedown', function (e) {
                        e.stopPropagation();
                    });
                    searchOption.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
                }
            }

            // –û–±—ã—á–Ω—ã–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä (—Å–µ–ª–µ–∫—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞)
            select.addEventListener('click', function (e) {
                // –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ option, –æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∏–∂–µ
                if (e.target.tagName !== 'LI') {
                    select.classList.toggle('open');

                    // –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
                    if (isClientSelect && searchInput) {
                        setTimeout(function () {
                            searchInput.focus();
                        }, 0);
                    }
                }
            });

            optionsList.forEach(function (option) {
                // –≤ —Å–µ–ª–µ–∫—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—É–Ω–∫—Ç —Å –∏–Ω–ø—É—Ç–æ–º –ø–æ–∏—Å–∫–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—ã–±–∏—Ä–∞—Ç—å—Å—è
                if (option.id === 'search-option') {
                    return;
                }

                option.addEventListener('click', function (e) {
                    e.stopPropagation();
                    var currentOptionsList = optionsContainer.querySelectorAll('li');
                    currentOptionsList.forEach(function (opt) {
                        if (opt.id !== 'search-option') {
                            opt.classList.remove('selected');
                        }
                    });
                    option.classList.add('selected');
                    selected.textContent = option.textContent;
                    select.classList.remove('open');

                    syncClearableSelectState(select);

                    if (select.id === 'teacher' || select.id === 'field-direction') {
                        teacherDirectionLastChanged = select.id;
                        applyTeacherDirectionFilters();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å" –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ª—é–±–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞
                    if (typeof window.updateSubmitButtonState === 'function') {
                        window.updateSubmitButtonState();
                    }
                });
            });
        });

        if (!window.__createBookingClientAddedListenerAttached) {
            window.__createBookingClientAddedListenerAttached = true;
            document.addEventListener('booking:client-added', function (event) {
                var clientData = event && event.detail ? event.detail : null;
                if (!clientData || !clientData.id || !clientData.name) {
                    return;
                }

                var clientSelect = document.getElementById('client');
                if (!clientSelect) {
                    return;
                }

                var optionsContainer = clientSelect.querySelector('ul.options');
                if (!optionsContainer) {
                    return;
                }

                var clientId = String(clientData.id);
                var existing = optionsContainer.querySelector('li[data-type="client"][data-value="' + clientId + '"]');

                if (!existing) {
                    existing = document.createElement('li');
                    existing.setAttribute('data-value', clientId);
                    existing.setAttribute('data-type', 'client');

                    var searchOption = optionsContainer.querySelector('#search-option');
                    var insertBeforeEl = searchOption ? searchOption.nextElementSibling : optionsContainer.firstElementChild;
                    if (insertBeforeEl) {
                        optionsContainer.insertBefore(existing, insertBeforeEl);
                    } else {
                        optionsContainer.appendChild(existing);
                    }

                    existing.addEventListener('click', function (e) {
                        e.stopPropagation();

                        var selectedSpan = clientSelect.querySelector('span.selected');
                        if (!selectedSpan) {
                            return;
                        }

                        var currentOptionsList = optionsContainer.querySelectorAll('li');
                        currentOptionsList.forEach(function (opt) {
                            if (opt.id !== 'search-option') {
                                opt.classList.remove('selected');
                            }
                        });

                        existing.classList.add('selected');
                        selectedSpan.textContent = existing.textContent;
                        clientSelect.classList.remove('open');

                        if (typeof syncClearableSelectState === 'function') {
                            syncClearableSelectState(clientSelect);
                        }

                        var searchInput = clientSelect.querySelector('#client-search-input');
                        if (searchInput) {
                            searchInput.value = '';
                            var allOptions = optionsContainer.querySelectorAll('li');
                            allOptions.forEach(function (opt) {
                                if (opt.id === 'search-option') return;
                                opt.style.display = '';
                            });
                        }

                        if (typeof window.updateSubmitButtonState === 'function') {
                            window.updateSubmitButtonState();
                        }
                    });
                }

                existing.textContent = clientData.name;

                var bookingModalEl = document.getElementById('createBookingModal');
                if (bookingModalEl && bookingModalEl.classList.contains('show')) {
                    var selectedSpan = clientSelect.querySelector('span.selected');
                    if (selectedSpan) {
                        var currentOptionsList = optionsContainer.querySelectorAll('li');
                        currentOptionsList.forEach(function (opt) {
                            if (opt.id !== 'search-option') {
                                opt.classList.remove('selected');
                            }
                        });
                        existing.classList.add('selected');
                        selectedSpan.textContent = existing.textContent;
                        if (typeof syncClearableSelectState === 'function') {
                            syncClearableSelectState(clientSelect);
                        }
                        if (typeof window.updateSubmitButtonState === 'function') {
                            window.updateSubmitButtonState();
                        }
                    }
                }
            });
        }

        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã –∏ —Ñ–∏–ª—å—Ç—Ä—ã, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–µ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å —Å–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        modalElement.addEventListener('hidden.bs.modal', function () {
            teacherDirectionLastChanged = null;
            resetTeacherDirectionUI();
        });

        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
        modalElement.addEventListener('shown.bs.modal', function () {
            applyTeacherDirectionFilters();
            applyServicesFilters();
        });
        
        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö —Å–µ–ª–µ–∫—Ç–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ
        function resetAllSelects() {
            var selectsToReset = ['client', 'teacher', 'field-direction', 'duration', 'start-time', 'end-time'];
            selectsToReset.forEach(function (selectId) {
                var select = document.getElementById(selectId);
                if (!select) return;
                
                // –°–Ω–∏–º–∞–µ–º selected —Å–æ –≤—Å–µ—Ö –æ–ø—Ü–∏–π
                var options = select.querySelectorAll('ul.options li');
                options.forEach(function (opt) {
                    if (opt.id !== 'search-option') {
                        opt.classList.remove('selected');
                    }
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ placeholder
                var selectedSpan = select.querySelector('span.selected');
                var placeholder = select.getAttribute('data-placeholder');
                if (selectedSpan) {
                    if (selectId === 'client') {
                        selectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞';
                    } else if (selectId === 'teacher') {
                        selectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è';
                    } else if (selectId === 'field-direction') {
                        selectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ';
                    } else if (selectId === 'duration') {
                        selectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å';
                    } else if (selectId === 'start-time') {
                        selectedSpan.textContent = '–ù–∞—á–∞–ª–æ';
                    } else if (selectId === 'end-time') {
                        selectedSpan.textContent = '–ö–æ–Ω–µ—Ü';
                    } else if (placeholder) {
                        selectedSpan.textContent = placeholder;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è clearable —Å–µ–ª–µ–∫—Ç–æ–≤
                if (typeof syncClearableSelectState === 'function') {
                    syncClearableSelectState(select);
                }
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —É—Å–ª—É–≥–∏
            var servicesSelect = document.getElementById('services');
            if (servicesSelect && servicesSelect._selectedOptions) {
                servicesSelect._selectedOptions.clear();
                var servicesOptions = servicesSelect.querySelectorAll('ul.options li');
                servicesOptions.forEach(function (opt) {
                    opt.classList.remove('selected');
                });
                var servicesSelectedSpan = servicesSelect.querySelector('span.selected');
                if (servicesSelectedSpan) {
                    servicesSelectedSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É';
                }
            }
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–µ–π–¥–∂–∏ —É—Å–ª—É–≥
            var servicesBadgesContainer = document.getElementById('create-selected-services');
            if (servicesBadgesContainer) {
                servicesBadgesContainer.innerHTML = '';
            }
            var resetServicesBtn = document.getElementById('create-reset-services');
            if (resetServicesBtn) {
                resetServicesBtn.style.display = 'none';
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            var commentField = document.getElementById('bookingComment');
            if (commentField) {
                commentField.value = '';
            }
            var trialCheckbox = document.getElementById('trialLessonCheckbox');
            if (trialCheckbox) {
                trialCheckbox.checked = false;
            }
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
            var commentCounter = document.getElementById('bookingCommentCounter');
            if (commentCounter) {
                commentCounter.textContent = '0/1000';
            }

            var costElement = document.getElementById('bookingCostValue');
            if (costElement) {
                costElement.textContent = '0 BYN';
            }

            var startTimeWarning = document.getElementById('start-time-warning-icon');
            var endTimeWarning = document.getElementById('end-time-warning-icon');
            var teacherWarning = document.getElementById('teacher-warning-icon');
            var submitWarning = document.getElementById('submit-warning-icon');
            if (startTimeWarning) startTimeWarning.style.display = 'none';
            if (endTimeWarning) endTimeWarning.style.display = 'none';
            if (teacherWarning) teacherWarning.style.display = 'none';
            if (submitWarning) submitWarning.style.display = 'none';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏
            window.currentStartTimeMinutes = null;
            window.currentEndTimeMinutes = null;
            window.currentSelectedPeriods = null;
        }

        window.resetCreateBookingModalSelects = resetAllSelects;

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏ ---
        var submitBtn = document.getElementById('createBookingSubmitBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', function () {
                submitCreateBookingForm();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏
        function submitCreateBookingForm() {
            var form = document.getElementById('bookingForm');
            if (!form) return;

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
            var formData = new FormData();

            // CSRF token
            var csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]');
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken.value);
            }

            // Scenario ID (–∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)
            if (window.currentScenarioFilterId) {
                formData.append('scenario_id', window.currentScenarioFilterId);
            }

            // Room ID
            var roomIdField = document.getElementById('roomIdField');
            if (roomIdField && roomIdField.value) {
                formData.append('room_id', roomIdField.value);
            }

            // Client ID –∏–ª–∏ Client Group ID (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞)
            var clientSelect = document.getElementById('client');
            if (clientSelect) {
                var selectedClient = clientSelect.querySelector('ul.options li.selected:not(#search-option)');
                if (selectedClient && selectedClient.getAttribute('data-value')) {
                    var selectionType = selectedClient.getAttribute('data-type') || 'client';
                    if (selectionType === 'group') {
                        formData.append('client_group_id', selectedClient.getAttribute('data-value'));
                    } else {
                        formData.append('client_id', selectedClient.getAttribute('data-value'));
                    }
                }
            }

            // Specialist ID (–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å)
            var teacherSelect = document.getElementById('teacher');
            if (teacherSelect) {
                var selectedTeacher = teacherSelect.querySelector('ul.options li.selected');
                if (selectedTeacher) {
                    formData.append('specialist_id', selectedTeacher.getAttribute('data-value'));
                }
            }

            // Direction ID (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
            var directionSelect = document.getElementById('field-direction');
            if (directionSelect) {
                var selectedDirection = directionSelect.querySelector('ul.options li.selected');
                if (selectedDirection) {
                    formData.append('direction_id', selectedDirection.getAttribute('data-value'));
                }
            }

            // Full datetime (–¥–∞—Ç–∞ + –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞)
            var modalDateInput = document.getElementById('modal-create-date');
            var startTime = window.currentStartTimeMinutes;
            if (modalDateInput && modalDateInput.value && startTime !== null && startTime !== undefined) {
                var timeHm = null;
                if (window.BookingTimeUtils && typeof window.BookingTimeUtils.formatTimeHHMM === 'function') {
                    timeHm = window.BookingTimeUtils.formatTimeHHMM(startTime);
                } else {
                    var hours = Math.floor(startTime / 60);
                    var mins = startTime % 60;
                    timeHm = String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
                }
                formData.append('full_datetime', modalDateInput.value + ' ' + timeHm + ':00');
            }

            // Duration (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM)
            var durationSelect = document.getElementById('duration');
            var startMinutesForDuration = window.currentStartTimeMinutes;
            var endMinutesForDuration = window.currentEndTimeMinutes;
            if (
                startMinutesForDuration !== null && startMinutesForDuration !== undefined &&
                endMinutesForDuration !== null && endMinutesForDuration !== undefined &&
                endMinutesForDuration > startMinutesForDuration
            ) {
                var durationMinutes = endMinutesForDuration - startMinutesForDuration;
                var durationStr = null;
                if (window.BookingTimeUtils && typeof window.BookingTimeUtils.formatDurationHHMM === 'function') {
                    durationStr = window.BookingTimeUtils.formatDurationHHMM(durationMinutes);
                } else {
                    var durationHours = Math.floor(durationMinutes / 60);
                    var durationMins = durationMinutes % 60;
                    durationStr = String(durationHours).padStart(2, '0') + ':' + String(durationMins).padStart(2, '0');
                }
                formData.append('duration', durationStr);
            } else if (durationSelect) {
                var selectedDuration = durationSelect.querySelector('ul.options li.selected');
                if (selectedDuration) {
                    var durationStr = selectedDuration.getAttribute('data-value');
                    if (!durationStr) {
                        var periods = parseInt(selectedDuration.getAttribute('data-periods'), 10);
                        var minMinutes = window.getScenarioMinDurationMinutes ? window.getScenarioMinDurationMinutes() : 60;
                        var totalMinutes = periods * minMinutes;
                        if (window.BookingTimeUtils && typeof window.BookingTimeUtils.formatDurationHHMM === 'function') {
                            durationStr = window.BookingTimeUtils.formatDurationHHMM(totalMinutes);
                        } else {
                            var durationHours = Math.floor(totalMinutes / 60);
                            var durationMins = totalMinutes % 60;
                            durationStr = String(durationHours).padStart(2, '0') + ':' + String(durationMins).padStart(2, '0');
                        }
                    }
                    formData.append('duration', durationStr);
                }
            }

            // Services (—É—Å–ª—É–≥–∏)
            var servicesSelect = document.getElementById('services');
            if (servicesSelect && servicesSelect._selectedOptions) {
                servicesSelect._selectedOptions.forEach(function (li) {
                    var serviceId = li.getAttribute('data-value');
                    if (serviceId) {
                        formData.append('services', serviceId);
                    }
                });
            }

            // Total cost (—Å—Ç–æ–∏–º–æ—Å—Ç—å)
            var costElement = document.getElementById('bookingCostValue');
            if (costElement) {
                var costText = costElement.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
                if (costText) {
                    formData.append('total_cost', costText);
                }
            }

            // Comment (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
            var commentField = document.getElementById('bookingComment');
            if (commentField && commentField.value) {
                formData.append('comment', commentField.value);
            }

            var trialCheckbox = document.getElementById('trialLessonCheckbox');
            if (trialCheckbox) {
                formData.append('trialLesson', trialCheckbox.checked ? '1' : '0');
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            // –î–ª—è "–†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞" –Ω—É–∂–µ–Ω –ª–∏–±–æ –∫–ª–∏–µ–Ω—Ç, –ª–∏–±–æ –≥—Ä—É–ø–ø–∞
            var isRepPointScenario = window.currentScenarioName === '–†–µ–ø–µ—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞';
            var hasClientOrGroup = formData.get('client_id') || formData.get('client_group_id');
            if (!hasClientOrGroup) {
                alert(isRepPointScenario ? '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –≥—Ä—É–ø–ø—É' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            if (!formData.get('full_datetime')) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞');
                return;
            }
            if (!formData.get('duration')) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
            var submitBtn = document.getElementById('createBookingSubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            }

            fetch('/create_booking/', {
                method: 'POST',
                body: formData
            })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (data.success) {
                    if (typeof window.refreshBookingsGrid === 'function') {
                        try {
                            window.__suppressBookingsRefreshUntil = Date.now() + 6000;
                            window.refreshBookingsGrid({ silent: true });
                        } catch (e) {}
                    }

                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É (–¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ AJAX)
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        var successEl = document.getElementById('bookingAddedSuccessModal');
                        if (!successEl) {
                            return;
                        }
                        var successModal = bootstrap.Modal.getOrCreateInstance(successEl);
                        successModal.show();
                    }, { once: true });

                    var modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                    modal.hide();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(function (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            })
            .finally(function () {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
                }
            });
        }
    })();
</script>
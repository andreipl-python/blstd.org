{% load custom_filters %}
{% load static %}
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/neon-dark-theme.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<div class="modal fade" id="editBookingModal" tabindex="-1" aria-labelledby="editBookingModalLabel"
     aria-hidden="true" data-booking-id="">
    <div class="modal-dialog modal-lg">
        <!-- Блок истории платежей -->
        <div id="paymentsHistoryBlock" class="modal-content" style="position: absolute; left: -320px; top: 0; width: 300px; display: none;">
            <div class="modal-header border-bottom-0 pb-0">
                <div class="d-flex align-items-center">
                    <i class="bi bi-clock-history me-2 neon-icon"></i>
                    <h5 class="modal-title mb-0" id="editBookingModalLabel">
                        История платежей
                    </h5>
                </div>
            </div>
            <div class="modal-body pt-2">
                <div id="paymentsHistoryList">
                    <!-- Здесь будет список платежей -->
                </div>
                <hr class="border-secondary my-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="neon-title">Оплачено:</span>
                    <span id="totalPaymentsAmount" class="neon-price">0 руб.</span>
                </div>
            </div>
        </div>
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <div class="d-flex align-items-center">
                        <h5 class="modal-title me-3 mb-0" id="editBookingModalLabel">
                            Бронь #<span id="modalBookingId"></span> | <span id="modalRoomName"></span>
                        </h5>
                        <span id="modalBookingStatus" class="badge"></span>
                    </div>
                    <span class="badge bg-success fs-6" id="modalTotalCost"></span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Левая колонка -->
                    <div class="col-md-6">
                        <!-- Информация о брони -->
                        <div class="booking-info neon-info-block mb-3">
                            <h6 class="mb-3">
                                <i class="bi bi-calendar-check me-2 neon-icon"></i>
                                <span class="neon-title">Информация о брони</span>
                            </h6>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-calendar-date me-2 neon-contact-icon"></i>
                                <span class="neon-text"><strong>Дата:</strong> <span id="modalDate"></span></span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-clock me-2 neon-contact-icon"></i>
                                <span class="neon-text"><strong>Время:</strong> <span id="modalTime"></span></span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-hourglass-split me-2 neon-contact-icon"></i>
                                <span class="neon-text"><strong>Длительность:</strong> <span id="modalDuration"></span></span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-bookmark me-2 neon-contact-icon"></i>
                                <span class="neon-text"><strong>Тип брони:</strong> <span id="modalBookingType"></span></span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-person me-2 neon-contact-icon"></i>
                                <div class="w-100">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="neon-text">
                                            <strong>Специалист:</strong>
                                            <span id="modalSpecialistInfo" class="neon-text"></span>
                                        </span>
                                        <i class="bi bi-pencil-fill neon-icon edit-specialist-icon" style="cursor: pointer; font-size: 0.9em;" id="editSpecialistBtn"></i>
                                    </div>
                                    <!-- Выпадающий список для выбора специалиста (скрыт по умолчанию) -->
                                    <select class="form-select mt-2" id="specialistSelect" style="display: none;">
                                        <option value="">Без специалиста</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-currency-dollar me-2 neon-contact-icon"></i>
                                <span class="neon-text"><strong>Стоимость аренды:</strong> <span class="neon-price"><span id="modalReservationCost"></span> руб.</span></span>
                            </div>
                        </div>

                        <!-- Информация о клиенте -->
                        <div class="client-info neon-info-block mb-3">
                            <h6 class="mb-2">
                                <i class="bi bi-person-circle me-2 neon-icon"></i>
                                <span class="neon-title">Информация о клиенте</span>
                            </h6>
                            <div class="d-flex align-items-center mb-2">
                                <div class="w-100">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="neon-text">
                                            <strong>Имя:</strong>
                                            <span id="modalClientInfo" class="neon-text"></span>
                                        </span>
                                        <i class="bi bi-pencil-fill neon-icon edit-client-icon ms-2" style="cursor: pointer; font-size: 0.9em;" id="editClientBtn"></i>
                                    </div>
                                    <!-- Выпадающий список для выбора клиента (скрыт по умолчанию) -->
                                    <select id="clientSelect" class="form-select mt-2" style="display: none;">
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-telephone me-2 neon-contact-icon"></i>
                                <span id="modalClientPhone" class="neon-contact"></span>
                            </div>
                            <div class="email-block mb-2" id="emailBlock" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-envelope me-2 neon-contact-icon"></i>
                                    <span id="modalClientEmail" class="neon-contact"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Правая колонка: Услуги -->
                    <div class="col-md-6">
                        <div class="services-info neon-info-block">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <i class="bi bi-bag-check me-2 neon-icon"></i>
                                    <span class="neon-title">Услуги</span>
                                    <i class="bi bi-plus-circle ms-2 cursor-pointer text-success" id="editServicesBtn" style="font-size: 0.9em; cursor: pointer;"></i>
                                </h6>
                            </div>
                            <!-- Выпадающий список для выбора услуг (скрыт по умолчанию) -->
                            <select id="servicesSelect" class="form-select mt-2" style="display: none;">
                                <option value="">Выберите услугу</option>
                            </select>
                            <div id="modalServicesByTypeContainer">
                                <div id="modalServicesByType"></div>
                            </div>
                            <hr class="border-secondary my-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="neon-title">Общая стоимость услуг:</span>
                                <span id="modalTotalServicesPrice" class="neon-price"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-12">
                        <div class="neon-info-block" id="commentBlock" style="display: none;">
                            <h6 class="mb-2">
                                <i class="bi bi-chat-left-text me-2 neon-icon"></i>
                                <span class="neon-title">Комментарий</span>
                            </h6>
                            <p id="modalComment" class="mb-0 neon-text"></p>
                        </div>
                    </div>
                </div>

                <form id="editBookingForm" action="javascript:void(0);" method="POST" style="display: none;">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editStartTime" class="form-label">Время начала</label>
                            <input type="text" class="form-control" id="editStartTime" name="start_time" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="editDuration" class="form-label">Длительность</label>
                            <select id="editDuration" name="duration" class="form-select">
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editClient" class="form-label">Клиент</label>
                            <select id="editClient" name="client" class="form-select">
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editSpecialist" class="form-label">Специалист</label>
                            <select id="editSpecialist" name="specialist" class="form-select">
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editTotalCost" class="form-label">Стоимость</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editTotalCost" name="total_cost" step="0.01" min="0">
                                <span class="input-group-text">руб.</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editComment" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="editComment" name="comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <!-- Левая группа кнопок -->
                    <button type="button" class="btn btn-warning me-2" id="cancelBookingBtn" onclick="openCancelModal()">
                        <i class="bi bi-x-circle"></i> Отменить
                    </button>
                    <button type="button" class="btn btn-success me-2" id="confirmBookingBtn">Подтвердить</button>
                    <button type="button" 
                            class="btn btn-success" 
                            data-bs-toggle="modal" 
                            data-bs-target="#paymentBookingModal"
                            data-booking-id=""
                            data-total-cost=""
                            id="openPaymentModalBtn">
                        Оплатить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'booking/user/modal_payment_booking.html' with payment_types=payment_types %}
{% include 'booking/user/modal_cancel_booking.html' %}

<script>
    // Определяем функцию глобально
    function openCancelModal() {
        const bookingId = document.getElementById('modalBookingId').textContent;
        
        // Загружаем список причин отмены
        fetch('/booking/get-cancellation-reasons/')
            .then(response => response.json())
            .then(data => {
                const cancelReasonSelect = document.getElementById('cancelReason');
                cancelReasonSelect.innerHTML = '<option value="">Выберите причину отмены...</option>';
                
                data.reasons.forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason.id;
                    option.textContent = reason.name;
                    cancelReasonSelect.appendChild(option);
                });
                
                // После загрузки данных переключаем модальные окна
                const editModal = bootstrap.Modal.getInstance(editBookingModal);
                if (editModal) {
                    editModal.hide();
                }

                // Устанавливаем ID брони в модальном окне отмены
                document.getElementById('cancelModalBookingId').textContent = bookingId;

                // Открываем модальное окно отмены через setTimeout
                setTimeout(() => {
                    const cancelModalElement = document.getElementById('cancelBookingModal');
                    if (cancelModalElement) {
                        const cancelModal = new bootstrap.Modal(cancelModalElement);
                        cancelModal.show();
                    }
                }, 150);
            })
            .catch(error => {
                console.error('Error loading cancellation reasons:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const editBookingModal = document.getElementById('editBookingModal');
        const confirmBookingBtn = document.getElementById('confirmBookingBtn');
        const cancelBookingBtn = document.getElementById('cancelBookingBtn');
        const paymentBookingBtn = document.getElementById('openPaymentModalBtn');
        
        // Функция очистки модального окна
        function cleanupModal() {
            // Очищаем все поля, если они существуют
            const fields = [
                'modalBookingId',
                'modalClientInfo',
                'modalSpecialistInfo',
                'modalDateInfo',
                'modalTimeInfo',
                'modalStatusInfo',
                'modalServicesInfo',
                'modalPaymentInfo',
                'modalCommentInfo'
            ];
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    if (fieldId === 'modalServicesInfo') {
                        element.innerHTML = '';
                    } else {
                        element.textContent = '';
                    }
                }
            });
            
            // Сбрасываем select специалиста
            const specialistSelect = document.getElementById('specialistSelect');
            if (specialistSelect) {
                specialistSelect.style.display = 'none';
                specialistSelect.innerHTML = '<option value="">Без специалиста</option>';
            }
            
            // Возвращаем кнопки в исходное состояние
            const editBookingBtn = document.getElementById('editBookingBtn');
            const saveBookingBtn = document.getElementById('saveBookingBtn');
            if (editBookingBtn) editBookingBtn.style.display = 'inline-block';
            if (saveBookingBtn) saveBookingBtn.style.display = 'none';

            // Очищаем backdrop и стили
            setTimeout(() => {
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    backdrop.remove();
                });
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';

                // Удаляем экземпляр модального окна
                const editModal = document.getElementById('editBookingModal');
                if (editModal) {
                    const bsModal = bootstrap.Modal.getInstance(editModal);
                    if (bsModal) {
                        bsModal.dispose();
                    }
                }
            }, 150);
        }
        
        // Обработчик закрытия модального окна редактирования
        editBookingModal.addEventListener('hidden.bs.modal', function (e) {
            cleanupModal();
        });

        // Обработчик открытия модального окна
        editBookingModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            // Проверяем, что это кнопка редактирования брони
            if (!button || !button.hasAttribute('data-booking-id')) return;

            // Убедимся, что нет лишних backdrop
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            const bookingId = button.getAttribute('data-booking-id');
            if (!bookingId) return;

            // Проверяем, не загружены ли уже данные для этой брони
            const currentBookingId = document.getElementById('modalBookingId').textContent;
            if (currentBookingId === bookingId) return;

            // Загружаем данные брони
            fetch(`/booking/get-booking-details/${bookingId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateModalWithBookingData(data.booking);
                    } else {
                        throw new Error(data.error || 'Ошибка при загрузке данных брони');
                    }
                })
                .catch(error => {
                    console.error('Error loading booking details:', error);
                    alert('Ошибка при загрузке данных брони: ' + error.message);
                });
        });

        function updateModalWithBookingData(data) {
            if (!data) return;
            
            // Сохраняем ID брони для использования в других функциях
            window.currentBookingId = data.id;
            
            // Обновляем основную информацию
            document.getElementById('modalBookingId').textContent = data.id;
            document.getElementById('modalDate').textContent = data.date;
            document.getElementById('modalTime').textContent = data.time;
            document.getElementById('modalDuration').textContent = data.duration;
            document.getElementById('modalRoomName').textContent = data.room_name;
            document.getElementById('modalBookingType').textContent = data.reservation_type;
            document.getElementById('modalSpecialistInfo').textContent = data.specialist_name || 'Не назначен';
            document.getElementById('modalClientInfo').textContent = data.client_name || 'Не указан';
            document.getElementById('modalClientPhone').textContent = data.client_phone || '';
            
            // Отображение email только если он есть
            const emailBlock = document.getElementById('emailBlock');
            const emailText = data.client_email || '';
            document.getElementById('modalClientEmail').textContent = emailText;
            emailBlock.style.display = emailText ? 'block' : 'none';

            // Отображение истории платежей
            const paymentsHistoryBlock = document.getElementById('paymentsHistoryBlock');
            const paymentsHistoryList = document.getElementById('paymentsHistoryList');
            
            if (data.payments_history && data.payments_history.length > 0) {
                paymentsHistoryList.innerHTML = data.payments_history.map(payment => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="text-muted small">${payment.date}</div>
                            <div class="neon-text">${payment.type}</div>
                        </div>
                        <span class="neon-price">${payment.amount} руб.</span>
                    </div>
                `).join('');
                
                // Принудительно показываем блок
                paymentsHistoryBlock.style.removeProperty('display');
                paymentsHistoryBlock.style.display = 'block';
                
                // Обновляем общую сумму платежей
                const totalPaymentsAmount = data.payments_history.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
                document.getElementById('totalPaymentsAmount').textContent = `${totalPaymentsAmount.toFixed(2)} руб.`;
            } else {
                paymentsHistoryBlock.style.display = 'none';
            }

            document.getElementById('modalReservationCost').textContent = data.reservation_cost || '0';

            // Отображение комментария только если он есть
            const commentBlock = document.getElementById('commentBlock');
            const commentText = data.comment || '';
            document.getElementById('modalComment').textContent = commentText;
            commentBlock.style.display = commentText ? 'block' : 'none';

            // Отображение услуг по группам
            const servicesContainer = document.getElementById('modalServicesByTypeContainer');
            servicesContainer.innerHTML = '';
            
            for (const [groupName, services] of Object.entries(data.services_by_group)) {
                const typeDiv = document.createElement('div');
                typeDiv.classList.add('mb-3');
                
                const typeHeader = document.createElement('div');
                typeHeader.classList.add('neon-service-type');
                typeHeader.textContent = groupName;
                typeDiv.appendChild(typeHeader);
                
                services.forEach(service => {
                    const serviceDiv = document.createElement('div');
                    serviceDiv.classList.add('d-flex', 'justify-content-between', 'mb-1', 'flex-wrap');
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('neon-service-name');
                    nameSpan.style.wordBreak = 'break-word';
                    nameSpan.style.maxWidth = '70%';
                    nameSpan.textContent = service.name;
                    
                    const rightDiv = document.createElement('div');
                    rightDiv.classList.add('d-flex', 'align-items-center', 'ms-auto');
                    
                    const costSpan = document.createElement('span');
                    costSpan.classList.add('neon-service-cost', 'me-2');
                    costSpan.style.whiteSpace = 'nowrap';
                    costSpan.textContent = `${service.cost} руб.`;
                    
                    const deleteBtn = document.createElement('i');
                    deleteBtn.classList.add('fas', 'fa-times', 'text-danger', 'cursor-pointer');
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.dataset.serviceId = service.id;
                    deleteBtn.addEventListener('click', deleteServiceHandler);
                    
                    rightDiv.appendChild(costSpan);
                    rightDiv.appendChild(deleteBtn);
                    
                    serviceDiv.appendChild(nameSpan);
                    serviceDiv.appendChild(rightDiv);
                    typeDiv.appendChild(serviceDiv);
                });
                
                servicesContainer.appendChild(typeDiv);
            }

            // Обновляем общую стоимость услуг
            document.getElementById('modalTotalServicesPrice').textContent = `${data.total_services_cost} руб.`;

            // Обновляем статус и его цвет
            const statusBadge = document.getElementById('modalBookingStatus');
            if (statusBadge) {
                statusBadge.textContent = data.status_name;
                statusBadge.className = 'badge ' + getStatusColor(data.status);
            }

            // Управляем видимостью кнопок в зависимости от статуса
            if (confirmBookingBtn) {
                confirmBookingBtn.style.display = data.status === 1 ? 'inline-block' : 'none';
            }
            if (paymentBookingBtn) {
                paymentBookingBtn.style.display = data.status === 2 ? 'inline-block' : 'none';
            }
            if (cancelBookingBtn) {
                cancelBookingBtn.setAttribute('data-booking-id', data.id);
            }
            
            // Обновляем данные для кнопки оплаты
            const paymentBtn = document.getElementById('openPaymentModalBtn');
            if (paymentBtn) {
                paymentBtn.setAttribute('data-booking-id', data.id);
                paymentBtn.setAttribute('data-total-cost', data.total_cost);
            }
            
            // Обновляем общую стоимость в заголовке
            document.getElementById('modalTotalCost').textContent = `${data.total_cost} руб.`;
        }

        function getStatusColor(status) {
            const statusColors = {
                1: 'bg-danger',     // Подтверждено
                2: 'bg-warning',    // Оплачено
                3: 'bg-success',    // Завершено
                4: 'bg-danger',     // Отменено
                5: 'bg-secondary'   // Не подтверждено
            };
            return statusColors[status] || 'bg-secondary';
        }
        
        // Загрузка списка специалистов
        async function loadSpecialists() {
            try {
                const bookingId = window.currentBookingId;
                if (!bookingId) return;
                
                const response = await fetch(`/booking/get-available-specialists/${bookingId}/`);
                const data = await response.json();
                
                if (data.success) {
                    const specialistSelect = document.getElementById('specialistSelect');
                    specialistSelect.innerHTML = '<option value="">Без специалиста</option>';
                    
                    data.specialists.forEach(specialist => {
                        const option = document.createElement('option');
                        option.value = specialist.id;
                        option.textContent = specialist.name;
                        if (specialist.current) {
                            option.selected = true;
                        }
                        specialistSelect.appendChild(option);
                    });
                } else {
                    throw new Error(data.error || 'Ошибка загрузки специалистов');
                }
            } catch (error) {
                console.error('Ошибка при загрузке специалистов:', error);
                alert('Не удалось загрузить список специалистов. Пожалуйста, попробуйте позже.');
            }
        }
        
        // Обработчики кнопок действий
        const editSpecialistBtn = document.getElementById('editSpecialistBtn');
        
        // Обработчик кнопки редактирования специалиста
        editSpecialistBtn.addEventListener('click', function() {
            const specialistSelect = document.getElementById('specialistSelect');
            const currentSpecialistName = document.getElementById('modalSpecialistInfo').textContent;
            
            // Если список уже отображается и значение не изменилось, скрываем его
            if (specialistSelect.style.display === 'block') {
                const selectedOption = specialistSelect.options[specialistSelect.selectedIndex];
                const selectedSpecialistName = selectedOption ? selectedOption.text : 'Без специалиста';
                
                if (selectedSpecialistName === currentSpecialistName) {
                    specialistSelect.style.display = 'none';
                    return;
                }
            }
            
            // Показываем select для выбора специалиста и загружаем список специалистов
            specialistSelect.style.display = 'block';
            loadSpecialists();

            // Добавляем обработчик изменения значения
            specialistSelect.onchange = async function() {
                const bookingId = window.currentBookingId;
                const specialistId = this.value;
                const newSpecialistName = specialistId ? this.options[this.selectedIndex].text : 'Без специалиста';

                // Показываем подтверждение с информацией об изменениях
                const result = await Swal.fire({
                    title: 'Подтверждение изменений',
                    html: `
                        <div class="text-start">
                            <p class="mb-2">
                                <strong>Специалист:</strong> 
                                <span class="text-muted">${currentSpecialistName}</span>
                                <i class="bi bi-arrow-right mx-2"></i>
                                <span class="text-success">${newSpecialistName}</span>
                            </p>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Сохранить',
                    cancelButtonText: 'Отмена',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33'
                });

                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/booking/edit/${bookingId}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({
                                specialist_id: specialistId || null
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Обновляем информацию о специалисте
                            document.getElementById('modalSpecialistInfo').textContent = data.specialist_name || 'Не назначен';
                            
                            // Скрываем select
                            specialistSelect.style.display = 'none';
                        } else {
                            throw new Error(data.error || 'Ошибка при сохранении изменений');
                        }
                    } catch (error) {
                        console.error('Ошибка при сохранении изменений:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Ошибка',
                            text: error.message || 'Не удалось сохранить изменения. Пожалуйста, попробуйте позже.'
                        });
                    }
                } else {
                    // Если пользователь отменил, возвращаем предыдущее значение
                    for (let i = 0; i < this.options.length; i++) {
                        if (this.options[i].text === currentSpecialistName) {
                            this.value = this.options[i].value;
                            break;
                        }
                    }
                }
            };
        });
        
        // Обработчик кнопки редактирования клиента
        const editClientBtn = document.getElementById('editClientBtn');
        editClientBtn.addEventListener('click', function() {
            const clientSelect = document.getElementById('clientSelect');
            
            // Если список уже отображается, скрываем его и выходим
            if (clientSelect.style.display === 'block') {
                clientSelect.style.display = 'none';
                return;
            }
            
            // Показываем список клиентов
            fetch('/booking/get-clients/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const clients = data.clients;
                        clientSelect.innerHTML = '';
                        clients.forEach(client => {
                            const option = document.createElement('option');
                            option.value = client.id;
                            option.textContent = client.name;
                            clientSelect.appendChild(option);
                        });
                        clientSelect.style.display = 'block';
                        clientSelect.focus();
                    }
                })
                .catch(error => {
                    console.error('Error loading clients:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: 'Не удалось загрузить список клиентов'
                    });
                });
        });

        // Обработчик изменения клиента
        const clientSelect = document.getElementById('clientSelect');
        clientSelect.addEventListener('change', async function() {
            const bookingId = window.currentBookingId;
            const clientId = this.value;
            const newClientName = this.options[this.selectedIndex].text;
            const currentClientName = document.getElementById('modalClientInfo').textContent;

            // Показываем подтверждение с информацией об изменениях
            const result = await Swal.fire({
                title: 'Подтверждение изменений',
                html: `
                    <div class="text-start">
                        <p class="mb-2">
                            <strong>Клиент:</strong> 
                            <span class="text-muted">${currentClientName}</span>
                            <i class="bi bi-arrow-right mx-2"></i>
                            <span class="text-success">${newClientName}</span>
                        </p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Сохранить',
                cancelButtonText: 'Отмена',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/booking/update-client/${bookingId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            client_id: clientId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Обновляем информацию о клиенте
                        document.getElementById('modalClientInfo').textContent = data.client_name;
                        document.getElementById('modalClientPhone').textContent = data.client_phone || '';
                        const emailBlock = document.getElementById('emailBlock');
                        if (data.client_email) {
                            document.getElementById('modalClientEmail').textContent = data.client_email;
                            emailBlock.style.display = 'block';
                        } else {
                            emailBlock.style.display = 'none';
                        }
                        
                        // Скрываем select
                        this.style.display = 'none';
                    } else {
                        throw new Error(data.error || 'Ошибка при сохранении изменений');
                    }
                } catch (error) {
                    console.error('Ошибка при сохранении изменений:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: error.message || 'Не удалось сохранить изменения. Пожалуйста, попробуйте позже.'
                    });
                }
            } else {
                // Возвращаем предыдущее значение
                this.style.display = 'none';
            }
        });
        
        if (confirmBookingBtn) {
            confirmBookingBtn.addEventListener('click', function() {
                const bookingId = document.getElementById('modalBookingId').textContent;
                if (!bookingId) return;

                fetch(`/booking/confirm/${bookingId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(editBookingModal);
                        if (modal) modal.hide();
                        location.reload();
                    } else {
                        alert('Ошибка при подтверждении брони: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Ошибка при выполнении запроса: ' + error);
                });
            });
        }

        if (cancelBookingBtn) {
            cancelBookingBtn.addEventListener('click', openCancelModal);
        }

        // Функция загрузки списка услуг
        async function loadServices() {
            try {
                const bookingId = window.currentBookingId;
                const response = await fetch(`/booking/get-services/?booking_id=${bookingId}`);
                const data = await response.json();
                
                if (data.success) {
                    const servicesSelect = document.getElementById('servicesSelect');
                    servicesSelect.innerHTML = '';
                    
                    data.services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = `${service.name} (${service.cost} руб.)`;
                        option.dataset.cost = service.cost;
                        servicesSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading services:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Не удалось загрузить список услуг'
                });
            }
        }
        
        // Обработчик кнопки редактирования услуг
        const editServicesBtn = document.getElementById('editServicesBtn');
        const servicesSelect = document.getElementById('servicesSelect');
        
        editServicesBtn.addEventListener('click', function() {
            const servicesSelect = document.getElementById('servicesSelect');
            servicesSelect.style.display = servicesSelect.style.display === 'none' ? 'block' : 'none';

            // Если список открывается, загружаем доступные услуги
            if (servicesSelect.style.display === 'block') {
                // Получаем ID брони из data-атрибута
                const bookingId = document.getElementById('editBookingModal').dataset.bookingId;
                
                // Очищаем список
                servicesSelect.innerHTML = '<option value="">Выберите услугу</option>';
                
                // Получаем текущие услуги брони
                const currentServices = Array.from(document.querySelectorAll('.neon-service-name')).map(el => el.textContent);
                
                // Загружаем список услуг
                fetch(`/booking/get-services/?booking_id=${bookingId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Группируем услуги по типам
                            const servicesByGroup = {};
                            data.services.forEach(service => {
                                if (!currentServices.includes(service.name)) { // Пропускаем уже добавленные услуги
                                    if (!servicesByGroup[service.group]) {
                                        servicesByGroup[service.group] = [];
                                    }
                                    servicesByGroup[service.group].push(service);
                                }
                            });
                            
                            // Создаем optgroup для каждой группы
                            for (const [groupName, services] of Object.entries(servicesByGroup)) {
                                if (services.length > 0) { // Добавляем группу только если в ней есть услуги
                                    const group = document.createElement('optgroup');
                                    group.label = groupName;
                                    
                                    services.forEach(service => {
                                        const option = document.createElement('option');
                                        option.value = service.id;
                                        option.textContent = `${service.name} (${service.cost} руб.)`;
                                        group.appendChild(option);
                                    });
                                    
                                    servicesSelect.appendChild(group);
                                }
                            }
                        }
                    });
            }
        });
        
        // Обработчик изменения выбранных услуг
        servicesSelect.addEventListener('change', async function() {
            const bookingId = window.currentBookingId;
            const selectedService = {
                id: this.value,
                name: this.options[this.selectedIndex].text,
                cost: this.options[this.selectedIndex].dataset.cost
            };
            
            if (!selectedService.id) {
                this.style.display = 'none';
                return;
            }
            
            // Формируем HTML для отображения изменений
            const changesHtml = `
                <div class="text-start">
                    <p class="mb-2"><strong>Добавить услугу:</strong></p>
                    <div class="mb-1">
                        <span class="text-success">• ${selectedService.name}</span>
                    </div>
                </div>
            `;
            
            // Показываем подтверждение
            const result = await Swal.fire({
                title: 'Добавление услуги',
                html: changesHtml,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Добавить',
                cancelButtonText: 'Отмена',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/booking/update-services/${bookingId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            service_ids: [selectedService.id]
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // После успешного добавления услуги обновляем данные через get-booking-details
                        fetch(`/booking/get-booking-details/${bookingId}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Обновляем список услуг
                                    const servicesContainer = document.getElementById('modalServicesByTypeContainer');
                                    servicesContainer.innerHTML = '';
                                    
                                    // Получаем услуги из ответа
                                    const servicesByGroup = data.booking.services_by_group;
                                    
                                    // Создаем элементы для каждой группы услуг
                                    for (const [groupName, services] of Object.entries(servicesByGroup)) {
                                        const typeDiv = document.createElement('div');
                                        typeDiv.classList.add('mb-2');
                                        
                                        const typeHeader = document.createElement('div');
                                        typeHeader.classList.add('fw-bold', 'mb-1');
                                        typeHeader.textContent = groupName;
                                        typeDiv.appendChild(typeHeader);
                                        
                                        services.forEach(service => {
                                            const serviceDiv = document.createElement('div');
                                            serviceDiv.classList.add('d-flex', 'justify-content-between', 'mb-1', 'flex-wrap');
                                            
                                            const nameSpan = document.createElement('span');
                                            nameSpan.classList.add('neon-service-name');
                                            nameSpan.style.wordBreak = 'break-word';
                                            nameSpan.style.maxWidth = '70%';
                                            nameSpan.textContent = service.name;
                                            
                                            const rightDiv = document.createElement('div');
                                            rightDiv.classList.add('d-flex', 'align-items-center', 'ms-auto');
                                            
                                            const costSpan = document.createElement('span');
                                            costSpan.classList.add('neon-service-cost', 'me-2');
                                            costSpan.style.whiteSpace = 'nowrap';
                                            costSpan.textContent = `${service.cost} руб.`;
                                            
                                            const deleteBtn = document.createElement('i');
                                            deleteBtn.classList.add('fas', 'fa-times', 'text-danger', 'cursor-pointer');
                                            deleteBtn.style.cursor = 'pointer';
                                            deleteBtn.dataset.serviceId = service.id;
                                            deleteBtn.addEventListener('click', deleteServiceHandler);
                                            
                                            rightDiv.appendChild(costSpan);
                                            rightDiv.appendChild(deleteBtn);
                                            
                                            serviceDiv.appendChild(nameSpan);
                                            serviceDiv.appendChild(rightDiv);
                                            typeDiv.appendChild(serviceDiv);
                                        });
                                        
                                        servicesContainer.appendChild(typeDiv);
                                    }
                                    
                                    // Обновляем стоимости
                                    document.getElementById('modalTotalServicesPrice').textContent = `${data.booking.total_services_cost} руб.`;
                                    document.getElementById('modalReservationCost').textContent = data.booking.reservation_cost;
                                    document.getElementById('modalTotalCost').textContent = `${data.booking.total_cost} руб.`;
                                }
                            })
                            .catch(error => console.error('Error:', error));
                        
                        // Скрываем выпадающий список
                        this.style.display = 'none';
                        
                        // Показываем уведомление об успехе
                        Swal.fire({
                            title: 'Успешно',
                            text: 'Услуга успешно добавлена',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        throw new Error(data.error || 'Ошибка при обновлении услуг');
                    }
                } catch (error) {
                    console.error('Ошибка:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: error.message || 'Произошла ошибка при обновлении услуг'
                    });
                }
            } else {
                // Если пользователь отменил, возвращаем предыдущее значение
                this.style.display = 'none';
            }
        });        
    });
    
    // Функция для удаления услуги
    function deleteServiceHandler() {
        const modal = document.getElementById('editBookingModal');
        const bookingId = window.currentBookingId;
        const serviceId = this.dataset.serviceId;
        const serviceName = this.parentElement.parentElement.querySelector('.neon-service-name').textContent;
        
        if (!bookingId) {
            console.error('ID брони не найден');
            return;
        }
        
        // Показываем диалог подтверждения
        Swal.fire({
            title: 'Подтверждение удаления',
            text: `Вы действительно хотите удалить услугу "${serviceName}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Удалить',
            cancelButtonText: 'Отмена'
        }).then((result) => {
            if (result.isConfirmed) {
                // Отправляем запрос на удаление услуги
                fetch(`/booking/delete-service/${bookingId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_id: serviceId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Показываем уведомление об успехе
                        Swal.fire({
                            title: 'Успешно',
                            text: 'Услуга успешно удалена',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Обновляем данные брони
                        fetch(`/booking/get-booking-details/${bookingId}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Обновляем список услуг
                                    const servicesContainer = document.getElementById('modalServicesByTypeContainer');
                                    servicesContainer.innerHTML = '';
                                    
                                    // Получаем услуги из ответа
                                    const servicesByGroup = data.booking.services_by_group;
                                    
                                    // Создаем элементы для каждой группы услуг
                                    for (const [groupName, services] of Object.entries(servicesByGroup)) {
                                        const typeDiv = document.createElement('div');
                                        typeDiv.classList.add('mb-2');
                                        
                                        const typeHeader = document.createElement('div');
                                        typeHeader.classList.add('fw-bold', 'mb-1');
                                        typeHeader.textContent = groupName;
                                        typeDiv.appendChild(typeHeader);
                                        
                                        services.forEach(service => {
                                            const serviceDiv = document.createElement('div');
                                            serviceDiv.classList.add('d-flex', 'justify-content-between', 'mb-1', 'flex-wrap');
                                            
                                            const nameSpan = document.createElement('span');
                                            nameSpan.classList.add('neon-service-name');
                                            nameSpan.style.wordBreak = 'break-word';
                                            nameSpan.style.maxWidth = '70%';
                                            nameSpan.textContent = service.name;
                                            
                                            const rightDiv = document.createElement('div');
                                            rightDiv.classList.add('d-flex', 'align-items-center', 'ms-auto');
                                            
                                            const costSpan = document.createElement('span');
                                            costSpan.classList.add('neon-service-cost', 'me-2');
                                            costSpan.style.whiteSpace = 'nowrap';
                                            costSpan.textContent = `${service.cost} руб.`;
                                            
                                            const deleteBtn = document.createElement('i');
                                            deleteBtn.classList.add('fas', 'fa-times', 'text-danger', 'cursor-pointer');
                                            deleteBtn.style.cursor = 'pointer';
                                            deleteBtn.dataset.serviceId = service.id;
                                            deleteBtn.addEventListener('click', deleteServiceHandler);
                                            
                                            rightDiv.appendChild(costSpan);
                                            rightDiv.appendChild(deleteBtn);
                                            
                                            serviceDiv.appendChild(nameSpan);
                                            serviceDiv.appendChild(rightDiv);
                                            typeDiv.appendChild(serviceDiv);
                                        });
                                        
                                        servicesContainer.appendChild(typeDiv);
                                    }
                                    
                                    // Обновляем стоимости
                                    document.getElementById('modalTotalServicesPrice').textContent = `${data.booking.total_services_cost} руб.`;
                                    document.getElementById('modalReservationCost').textContent = data.booking.reservation_cost;
                                    document.getElementById('modalTotalCost').textContent = `${data.booking.total_cost} руб.`;
                                }
                            });
                    } else {
                        // Показываем уведомление об ошибке
                        Swal.fire({
                            title: 'Ошибка',
                            text: data.error || 'Произошла ошибка при удалении услуги',
                            icon: 'error'
                        });
                    }
                });
            }
        });
    }
</script>

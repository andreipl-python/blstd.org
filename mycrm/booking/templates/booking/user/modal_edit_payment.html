{% load static %}

<head>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel"
    aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered" style="max-width:none; width: 31vw;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="mb-3">
                    <div class="row d-flex align-items-center mb-4">
                        <div class="col-md-12 d-flex justify-content-between align-items-center">
                            <div class="d-flex justify-content-start align-items-center gap-3">
                                <button type="button" class="button-third" onclick="switchToHistoryFromEditPayment()">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 19L5 12L12 5" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <path d="M19 12H5" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </button>
                                <h2 class="mb-0">Редактирование платежа</h2>
                            </div>
                            <button type="button" class="modal-close-icon" data-bs-dismiss="modal" aria-label="Закрыть">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 6L6 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M6 6L18 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12" id="editPaymentInfoContainer">
                            <span id="editPaymentDateTime">03.12.2025, 14:30</span>
                            <span>/</span>
                            <span id="editPaymentMethod">Наличные</span>
                            <span>/</span>
                            <span id="editPaymentAmountDisplay">35 BYN</span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPaymentAmountInput" class="form-label">Сумма, BYN</label>
                            <input type="text" id="editPaymentAmountInput" class="form-control" placeholder="35.00"
                                autocomplete="off">
                        </div>
                        <div class="col-md-6">
                            <label for="editPaymentType" class="form-label">Способ оплаты</label>
                            <div class="custom-select" id="editPaymentType" name="editPaymentType">
                                <span class="selected">Наличные</span>
                                <span class="chevron">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                    </svg>
                                </span>
                                <ul class="options">
                                    <li data-value="1">Наличные</li>
                                    <li data-value="2">Банковская карта</li>
                                    <li data-value="3">Перевод</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label for="editPaymentComment" class="form-label">Комментарий (необязательно)</label>
                            <textarea class="form-control" id="editPaymentComment" rows="3"
                                placeholder="Комментарий к платежу"></textarea>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-3">
                            <button type="button" class="button-primary w-100" id="editPaymentSaveButton" disabled>Сохранить</button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="button-sec w-100" data-bs-dismiss="modal">Отмена</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function sanitizePaymentValue(value, options = {}) {
        const { preserveSeparator = false, maxValue = null } = options;
        if (!value) return '';

        let sanitized = value.replace(/[^0-9.,]/g, '');
        if (!sanitized) return '';

        const separatorMatch = sanitized.match(/[.,]/);
        const numericMax = typeof maxValue === 'number' ? maxValue : parseFloat(maxValue);
        const hasMax = Number.isFinite(numericMax);
        const effectiveMax = hasMax ? Math.max(0, numericMax) : null;

        if (!separatorMatch) {
            const numericValue = parseFloat(sanitized);
            if (!isNaN(numericValue) && effectiveMax !== null && numericValue > effectiveMax) {
                return effectiveMax.toFixed(2);
            }
            return sanitized;
        }

        const separatorIndex = separatorMatch.index;
        const separator = separatorMatch[0];

        const integerPartRaw = sanitized.slice(0, separatorIndex).replace(/[.,]/g, '');
        const integerPart = integerPartRaw || '0';
        const decimalsRaw = sanitized.slice(separatorIndex + 1).replace(/[.,]/g, '');
        const decimalPart = decimalsRaw.slice(0, 2);

        const visibleSeparator = preserveSeparator ? separator : '.';

        const normalizedValue = decimalPart ? `${integerPart}.${decimalPart}` : integerPart;
        const numericValue = parseFloat(normalizedValue);
        if (!isNaN(numericValue) && effectiveMax !== null && numericValue > effectiveMax) {
            const maxString = effectiveMax.toFixed(2);
            return preserveSeparator && separator === ',' ? maxString.replace('.', ',') : maxString;
        }

        if (!decimalPart && sanitized.endsWith(separator)) {
            return `${integerPart}${visibleSeparator}`;
        }

        return decimalPart ? `${integerPart}${visibleSeparator}${decimalPart}` : integerPart;
    }

    function parsePaymentNumericValue(value) {
        if (!value && value !== 0) return NaN;
        const normalized = String(value).replace(',', '.');
        const numeric = parseFloat(normalized);
        return Number.isFinite(numeric) ? numeric : NaN;
    }

    let editPaymentMaxValue = null;

    function setEditPaymentLimits(remainingAmount = null, otherPaymentsTotal = 0) {
        const remaining = parsePaymentNumericValue(remainingAmount);
        const others = parsePaymentNumericValue(otherPaymentsTotal);
        if (Number.isFinite(remaining)) {
            const rest = remaining - (Number.isFinite(others) ? others : 0);
            editPaymentMaxValue = Math.max(0, rest);
        } else {
            editPaymentMaxValue = null;
        }
    }

    function getMaxAllowedValueForEdit() {
        return Number.isFinite(editPaymentMaxValue) ? editPaymentMaxValue : null;
    }

    function switchToHistoryFromEditPayment() {
        const editModalElement = document.getElementById('editPaymentModal');
        if (!editModalElement || typeof bootstrap === 'undefined') {
            return;
        }
        const editModal = bootstrap.Modal.getInstance(editModalElement);
        if (editModal) {
            editModal.hide();
        }
    }

    function selectPaymentTypeByName(paymentTypeSelect, name) {
        if (!paymentTypeSelect) return;
        const selected = paymentTypeSelect.querySelector('.selected');
        const optionsContainer = paymentTypeSelect.querySelector('.options');
        const optionsList = optionsContainer ? optionsContainer.querySelectorAll('li') : [];
        let matched = null;

        optionsList.forEach(opt => opt.classList.remove('selected'));
        if (name) {
            matched = Array.from(optionsList).find(opt => (opt.textContent || '').trim() === name.trim());
        }
        if (matched) {
            matched.classList.add('selected');
            paymentTypeSelect.dataset.value = matched.dataset.value || '';
            if (selected) {
                selected.textContent = matched.textContent;
            }
        } else {
            if (optionsList[0]) {
                optionsList[0].classList.add('selected');
                paymentTypeSelect.dataset.value = optionsList[0].dataset.value || '';
                if (selected) {
                    selected.textContent = optionsList[0].textContent || 'Выберите способ';
                }
            }
        }
    }

    window.prefillEditPaymentModal = function (paymentData, bookingData, otherPaymentsTotal = 0) {
        const amountInput = document.getElementById('editPaymentAmountInput');
        const commentInput = document.getElementById('editPaymentComment');
        const paymentTypeSelect = document.getElementById('editPaymentType');
        const dateTimeEl = document.getElementById('editPaymentDateTime');
        const methodEl = document.getElementById('editPaymentMethod');
        const amountDisplayEl = document.getElementById('editPaymentAmountDisplay');

        const amount = paymentData && paymentData.amount ? paymentData.amount : '';
        const paymentType = paymentData && paymentData.payment_type ? paymentData.payment_type : '';
        const datetime = paymentData && paymentData.datetime ? paymentData.datetime : '';

        const numericOriginal = parsePaymentNumericValue(amount);
        window.editPaymentOriginalAmount = Number.isFinite(numericOriginal) ? numericOriginal : null;

        if (amountInput) {
            amountInput.value = amount ? sanitizePaymentValue(String(amount), { preserveSeparator: true }) : '';
        }

        if (commentInput) {
            commentInput.value = paymentData && paymentData.comment ? paymentData.comment : '';
        }

        if (paymentTypeSelect) {
            selectPaymentTypeByName(paymentTypeSelect, paymentType);
        }

        if (dateTimeEl) {
            dateTimeEl.textContent = datetime || '';
        }
        if (methodEl) {
            methodEl.textContent = paymentType || '';
        }
        if (amountDisplayEl) {
            const numeric = parsePaymentNumericValue(amount);
            const formatted = Number.isFinite(numeric) ? `${numeric.toFixed(Number.isInteger(numeric) ? 0 : 2)} BYN` : '';
            amountDisplayEl.textContent = formatted || '';
        }

        const remaining = bookingData ? bookingData.remaining_amount : null;
        setEditPaymentLimits(remaining, otherPaymentsTotal || 0);
        if (typeof window.updateEditPaymentSaveButton === 'function') {
            window.updateEditPaymentSaveButton();
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        const editModalElement = document.getElementById('editPaymentModal');
        if (!editModalElement || typeof bootstrap === 'undefined') {
            return;
        }

        const amountInput = document.getElementById('editPaymentAmountInput');
        const commentInput = document.getElementById('editPaymentComment');
        const initialAmountValue = amountInput ? amountInput.value : '';
        const initialCommentValue = commentInput ? commentInput.value : '';
        let saveButton = document.getElementById('editPaymentSaveButton');

        function isEqualWithinEpsilon(a, b, epsilon = 1e-6) {
            if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
            return Math.abs(a - b) < epsilon;
        }

        const isAmountValid = () => {
            if (!amountInput) return false;
            const numericValue = parsePaymentNumericValue(amountInput.value);
            if (!Number.isFinite(numericValue) || numericValue <= 0) return false;
            const original = typeof window !== 'undefined' ? window.editPaymentOriginalAmount : null;
            if (Number.isFinite(original) && isEqualWithinEpsilon(numericValue, original)) {
                return false;
            }
            return true;
        };

        const updateSaveButtonState = () => {
            if (!saveButton) {
                saveButton = document.getElementById('editPaymentSaveButton');
            }
            if (!saveButton) return;
            saveButton.disabled = !isAmountValid();
            saveButton.classList.toggle('disabled', saveButton.disabled);
            saveButton.setAttribute('aria-disabled', saveButton.disabled ? 'true' : 'false');
        };
        window.updateEditPaymentSaveButton = updateSaveButtonState;

        // Открытие/закрытие кастомного селекта "Способ оплаты" и выбор опции
        const paymentTypeSelect = document.getElementById('editPaymentType');
        let resetPaymentTypeSelect = null;
        if (paymentTypeSelect && !paymentTypeSelect.dataset.init) {
            const selected = paymentTypeSelect.querySelector('.selected');
            const optionsContainer = paymentTypeSelect.querySelector('.options');
            const optionsList = optionsContainer ? optionsContainer.querySelectorAll('li') : [];
            const chevron = paymentTypeSelect.querySelector('.chevron');

            const initialSelectedText = selected ? selected.textContent : '';
            const initialSelectedValue = paymentTypeSelect.dataset.value || (optionsList[0]?.dataset.value || '');

            const toggleOpen = (event) => {
                if (event) event.stopPropagation();
                paymentTypeSelect.classList.toggle('open');
            };

            if (selected) {
                selected.addEventListener('click', toggleOpen);
            }
            if (chevron) {
                chevron.addEventListener('click', toggleOpen);
            }
            paymentTypeSelect.addEventListener('click', (event) => {
                if (event.target.tagName !== 'LI') {
                    toggleOpen(event);
                }
            });

            optionsList.forEach(option => {
                option.addEventListener('click', (event) => {
                    event.stopPropagation();
                    optionsList.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    if (selected) {
                        selected.textContent = option.textContent;
                    }
                    paymentTypeSelect.dataset.value = option.dataset.value || '';
                    paymentTypeSelect.classList.remove('open');
                });
            });

            document.addEventListener('click', (event) => {
                if (!paymentTypeSelect.contains(event.target)) {
                    paymentTypeSelect.classList.remove('open');
                }
            });

            resetPaymentTypeSelect = () => {
                optionsList.forEach(opt => opt.classList.remove('selected'));
                if (optionsList[0]) {
                    optionsList[0].classList.add('selected');
                }
                if (selected) {
                    selected.textContent = initialSelectedText || (optionsList[0]?.textContent || 'Выберите способ');
                }
                paymentTypeSelect.dataset.value = initialSelectedValue || '';
                paymentTypeSelect.classList.remove('open');
            };

            paymentTypeSelect.dataset.init = 'true';
        }

        if (amountInput) {
            amountInput.addEventListener('input', function () {
                const maxForInput = getMaxAllowedValueForEdit();
                const formatted = sanitizePaymentValue(amountInput.value, { preserveSeparator: true, maxValue: maxForInput });
                amountInput.value = formatted;
                updateSaveButtonState();
            });

            amountInput.addEventListener('blur', function () {
                if (!amountInput.value) {
                    updateSaveButtonState();
                    return;
                }

                const maxForInput = getMaxAllowedValueForEdit();
                let formatted = sanitizePaymentValue(amountInput.value, { maxValue: maxForInput });
                if (formatted.startsWith('.')) {
                    formatted = `0${formatted}`;
                }
                if (formatted.endsWith('.')) {
                    formatted = formatted.slice(0, -1);
                }
                const numericValue = parsePaymentNumericValue(formatted);
                if (!numericValue || numericValue <= 0) {
                    amountInput.value = '';
                    updateSaveButtonState();
                    return;
                }

                amountInput.value = formatted;
                updateSaveButtonState();
            });

            amountInput.addEventListener('keydown', function (event) {
                if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                    event.preventDefault();
                }
            });
        }

        updateSaveButtonState();

        editModalElement.addEventListener('hidden.bs.modal', function () {
            if (typeof resetPaymentTypeSelect === 'function') {
                resetPaymentTypeSelect();
            }
            if (amountInput) {
                amountInput.value = initialAmountValue || '';
            }
            if (commentInput) {
                commentInput.value = initialCommentValue || '';
            }
            if (saveButton) {
                saveButton.disabled = true;
            }
            editPaymentMaxValue = null;
            if (typeof window !== 'undefined') {
                window.editPaymentOriginalAmount = null;
            }

            if (typeof window !== 'undefined' && !window.isSwitchingFromHistoryToEditPayment) {
                return;
            }

            const historyElement = document.getElementById('paymentHistoryModal');
            if (!historyElement || typeof bootstrap === 'undefined') {
                return;
            }

            const historyModal = new bootstrap.Modal(historyElement);
            historyModal.show();

            if (typeof window !== 'undefined') {
                window.isSwitchingFromHistoryToEditPayment = false;
            }
        });
    });
</script>

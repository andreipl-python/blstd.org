{% load custom_filters %}
{% load static %}

<style>
    /* Скрываем стрелки для Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Скрываем стрелки для Firefox */
    input[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }
</style>

<div class="modal fade" id="paymentBookingModal" tabindex="-1" aria-labelledby="paymentBookingModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex flex-column w-100">
                    <div class="d-flex align-items-center mb-2">
                        <h5 class="modal-title me-3 mb-0" id="paymentBookingModalLabel">Оплата брони #<span id="paymentBookingId"></span></h5>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            <span class="badge bg-secondary position-relative" title="Стоимость аренды">
                                <i class="fas fa-home me-1"></i>
                                <span id="reservationCost"></span>
                                <div class="dot-container-payment" title="">
                                    <div id="balanceDot" class="balance-dot"></div>
                                </div>
                            </span>
                            <span class="badge bg-primary" title="Стоимость услуг">
                                <i class="fas fa-concierge-bell me-1"></i>
                                <span id="serviceCost"></span>
                            </span>
                            <span class="badge bg-success" title="Общая стоимость">
                                <i class="fas fa-equals me-1"></i>
                                <span id="bookingTotalCost"></span>
                            </span>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted">Оплачено:</span>
                            <span class="badge bg-primary fs-6" id="paidAmount"></span>
                        </div>
                        <div>
                            <span class="text-muted">Осталось оплатить:</span>
                            <span class="badge bg-warning text-dark fs-6" id="remainingAmount"></span>
                        </div>
                    </div>
                </div>
                <form id="paymentBookingForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="paymentType" class="form-label">Тип оплаты</label>
                        <select class="form-select" id="paymentType" name="payment_type" required>
                            {% for payment_type in payment_types %}
                                <option value="{{ payment_type.id }}">{{ payment_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Сумма</label>
                        <input type="number" class="form-control" id="paymentAmount" name="amount" required 
                               min="0" step="0.01" oninput="validatePaymentAmount(this)">
                        <div class="invalid-feedback" id="paymentAmountError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentComment" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="paymentComment" name="comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="submitPayment()">Оплатить</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const paymentBookingModal = document.getElementById('paymentBookingModal');
        if (!paymentBookingModal) return;

        function updateBalanceIndicator(balance, requiredUnits) {
            const dot = document.getElementById('balanceDot');
            const container = dot.parentElement;
            
            if (balance === null || balance === undefined) {
                dot.className = 'balance-dot grey';
                container.title = 'Нет данных о балансе';
                return;
            }

            if (balance === 0) {
                dot.className = 'balance-dot red-dot';
                container.title = 'Баланс: 0 единиц';
            } else if (balance < requiredUnits) {
                dot.className = 'balance-dot yellow-dot';
                container.title = `Баланс: ${balance} единиц (требуется ${requiredUnits})`;
            } else {
                dot.className = 'balance-dot green-dot blink';
                container.title = `Баланс: ${balance} единиц`;
            }
        }

        // При открытии модального окна оплаты
        paymentBookingModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const bookingId = button.getAttribute('data-booking-id');
            
            document.getElementById('paymentBookingId').textContent = bookingId;

            // Получаем данные о брони для заполнения типов платежей
            fetch(`/booking/get-booking-details/${bookingId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.booking) {
                        const paymentTypeSelect = document.getElementById('paymentType');
                        paymentTypeSelect.innerHTML = ''; 
                        
                        if (data.booking.payment_types) {
                            data.booking.payment_types.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type.id;
                                option.textContent = type.name;
                                paymentTypeSelect.appendChild(option);
                            });
                        }

                        // Обновляем информацию о платежах
                        const paidAmount = document.getElementById('paidAmount');
                        const remainingAmount = document.getElementById('remainingAmount');
                        const reservationCost = document.getElementById('reservationCost');
                        const serviceCost = document.getElementById('serviceCost');
                        const bookingTotalCost = document.getElementById('bookingTotalCost');
                        
                        // Обновляем суммы
                        paidAmount.textContent = data.booking.paid_amount + ' BYN';
                        remainingAmount.textContent = data.booking.remaining_amount + ' BYN';
                        reservationCost.textContent = data.booking.reservation_cost + ' BYN';
                        serviceCost.textContent = data.booking.service_costs + ' BYN';
                        bookingTotalCost.textContent = data.booking.total_cost + ' BYN';

                        // Обновляем индикатор баланса
                        updateBalanceIndicator(
                            data.booking.client_balance,
                            data.booking.required_units
                        );
                        
                        // Устанавливаем оставшуюся сумму в поле ввода
                        const paymentAmount = document.getElementById('paymentAmount');
                        paymentAmount.value = data.booking.remaining_amount;
                        paymentAmount.setAttribute('max', data.booking.remaining_amount);
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // При закрытии модального окна оплаты
        paymentBookingModal.addEventListener('hidden.bs.modal', function(event) {
            const modalBackdrops = document.getElementsByClassName('modal-backdrop');
            while (modalBackdrops.length > 0) {
                modalBackdrops[0].parentNode.removeChild(modalBackdrops[0]);
            }
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Показываем модальное окно редактирования брони
            const editBookingModal = document.getElementById('editBookingModal');
            if (editBookingModal) {
                editBookingModal.classList.add('show');
                editBookingModal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        });
    });

    function validatePaymentAmount(input) {
        const max = parseFloat(input.getAttribute('max'));
        const value = parseFloat(input.value);
        const errorDiv = document.getElementById('paymentAmountError');
        const submitButton = document.querySelector('button[onclick="submitPayment()"]');
        
        // Проверяем количество знаков после запятой
        const decimalPlaces = (input.value.split('.')[1] || '').length;
        if (decimalPlaces > 2) {
            input.classList.add('is-invalid');
            errorDiv.textContent = 'Допускается не более 2 знаков после запятой';
            submitButton.disabled = true;
            return;
        }
        
        if (value > max) {
            input.classList.add('is-invalid');
            errorDiv.textContent = `Максимальная сумма к оплате: ${max} BYN`;
            submitButton.disabled = true;
        } else if (value <= 0 || input.value.trim() === '') {
            input.classList.add('is-invalid');
            errorDiv.textContent = 'Сумма должна быть больше 0';
            submitButton.disabled = true;
        } else {
            input.classList.remove('is-invalid');
            errorDiv.textContent = '';
            submitButton.disabled = false;
        }
    }

    // Функция отправки формы оплаты
    function submitPayment() {
        const bookingId = document.getElementById('paymentBookingId').textContent;
        const paymentType = document.getElementById('paymentType').value;
        const amount = document.getElementById('paymentAmount').value;
        const comment = document.getElementById('paymentComment').value;

        if (!bookingId || !paymentType || !amount) {
            Swal.fire({
                icon: 'error',
                title: 'Ошибка',
                text: 'Пожалуйста, заполните все обязательные поля'
            });
            return;
        }

        fetch(`/booking/process-payment/${bookingId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                payment_type: paymentType,
                amount: amount,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('paymentBookingModal'));
                modal.hide();

                Swal.fire({
                    icon: 'success',
                    title: 'Успешно',
                    text: 'Оплата успешно добавлена'
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error(data.error || 'Произошла ошибка при сохранении оплаты');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Ошибка',
                text: error.message || 'Произошла ошибка при сохранении оплаты'
            });
        });
    }
</script>

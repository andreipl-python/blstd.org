{% load static %}

<head>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<div class="modal fade" id="paymentBookingModal" tabindex="-1" aria-labelledby="paymentBookingModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:none; width: 31vw;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="mb-3">
                    <!--Кнопка возврата, заголовок и крестик-->
                    <div class="row d-flex align-items-center mb-5">
                        <div class="col-md-12 d-flex justify-content-between align-items-center">
                            <div class="d-flex justify-content-start align-items-center gap-3">
                                <button type="button" class="button-third" onclick="switchToInfoFromPaymentModal()">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 19L5 12L12 5" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <path d="M19 12H5" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </button>
                                <h2 class="mb-0">Внесение оплаты</h2>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <div id="publicIdContainer" class="d-flex align-items-end">
                                    <span>ID:</span>
                                    <span id="publicID" class="ms-2">123456</span>
                                </div>
                                <button type="button" class="modal-close-icon" onclick="showConfirmCancelModal()"
                                    aria-label="Закрыть">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <path d="M6 6L18 18" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!--Стоимость / Внесено / Остаток-->
                    <div class="col-md-12 payment-summary mb-5" id="paymentTextContainer">
                        <div class="payment-summary-item">
                            <h4 class="mb-0">70 BYN</h4>
                            <span class="payment-summary-label">Стоимость</span>
                        </div>
                        <div class="payment-summary-item payment-summary-divider">
                            <h4 class="mb-0">/</h4>
                            <span class="payment-summary-label"></span>
                        </div>
                        <div class="payment-summary-item">
                            <h4 class="mb-0">0 BYN</h4>
                            <span class="payment-summary-label">Внесено</span>
                        </div>
                        <div class="payment-summary-item payment-summary-divider">
                            <h4 class="mb-0">/</h4>
                            <span class="payment-summary-label"></span>
                        </div>
                        <div class="payment-summary-item">
                            <h4 class="mb-0">70 BYN</h4>
                            <span class="payment-summary-label">Остаток</span>
                        </div>
                    </div>
                    <!--Блок внесения оплаты-->
                    <div class="row mb-3">
                        <div class="col-12" id="paymentMethodsContainer"></div>
                        <div class="col-12 mb-4">
                            <button type="button"
                                class="button-third add-payment-method-trigger d-inline-flex align-items-center gap-2"
                                id="addPaymentMethodButton">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 12H19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M12 5V19" stroke="#7A52FF" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                                <span class="add-payment-method-text">Добавить способ оплаты</span>
                            </button>
                        </div>

                        <template id="paymentMethodBlockTemplate">
                            <div class="payment-method-card mb-4" data-payment-method-block>
                                <div class="row g-4 align-items-end payment-method-row">
                                    <div class="col-lg-9 col-md-8">
                                        <label class="form-label">Способ оплаты</label>
                                        <div class="custom-select payment-method-select" data-payment-select>
                                            <span class="selected">Выберите способ</span>
                                            <span class="chevron">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M6 9L12 15L18 9" stroke="#818EA2" stroke-width="2" />
                                                </svg>
                                            </span>
                                            <ul class="options"></ul>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-4">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <label class="form-label mb-0">Сумма, BYN</label>
                                            <button type="button" class="payment-method-remove button-third" data-remove-block
                                                aria-label="Удалить способ оплаты">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M18 6L6 18" stroke="#7A52FF" stroke-width="2"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M6 6L18 18" stroke="#7A52FF" stroke-width="2"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                            </button>
                                        </div>
                                        <input type="text" class="payment-value-input" data-payment-value
                                            placeholder="99" inputmode="decimal" autocomplete="off" />
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!--Блок Итого-->
                        <div class="col-12 mb-4">
                            <div class="payment-total-wrapper">
                                <div class="payment-total-text">Итого</div>
                                <div class="payment-total-amount">120 BYN</div>
                            </div>
                        </div>

                        <!--Кнопка оплатить-->
                        <div class="col-md-12 d-flex align-items-center justify-content-center">
                            <button type="button" class="button-primary d-none" id="paymentSubmitButton">Оплатить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === DOM-узлы и состояние модалки оплаты ===
    const paymentModalElement = document.getElementById('paymentBookingModal');
    const paymentMethodsContainer = document.getElementById('paymentMethodsContainer');
    const addPaymentMethodButton = document.getElementById('addPaymentMethodButton');
    const paymentSubmitButton = document.getElementById('paymentSubmitButton');
    const paymentMethodTemplate = document.getElementById('paymentMethodBlockTemplate');
    const MAX_PAYMENT_AMOUNT = 99999.99;
    let paymentModalForceClose = false;
    let paymentMethodBlocks = [];
    let paymentMethodBlockIdCounter = 0;
    let paymentSelectCloseListenerAttached = false;

    // === Хелперы работы с суммой оплаты ===
    // Очищает ввод до корректного десятичного формата с двумя знаками после разделителя
    function sanitizePaymentValue(value, options = {}) {
        const { preserveSeparator = false } = options;
        if (!value) return '';

        let sanitized = value.replace(/[^0-9.,]/g, '');
        if (!sanitized) return '';

        const separatorMatch = sanitized.match(/[.,]/);
        if (!separatorMatch) {
            const numericValue = parseFloat(sanitized);
            if (!isNaN(numericValue) && numericValue > MAX_PAYMENT_AMOUNT) {
                return MAX_PAYMENT_AMOUNT.toFixed(2);
            }
            return sanitized;
        }

        const separatorIndex = separatorMatch.index;
        const separator = separatorMatch[0];

        const integerPartRaw = sanitized.slice(0, separatorIndex).replace(/[.,]/g, '');
        const integerPart = integerPartRaw || '0';
        const decimalsRaw = sanitized.slice(separatorIndex + 1).replace(/[.,]/g, '');
        const decimalPart = decimalsRaw.slice(0, 2);

        const visibleSeparator = preserveSeparator ? separator : '.';

        const normalizedValue = decimalPart ? `${integerPart}.${decimalPart}` : integerPart;
        const numericValue = parseFloat(normalizedValue);
        if (!isNaN(numericValue) && numericValue > MAX_PAYMENT_AMOUNT) {
            const maxString = MAX_PAYMENT_AMOUNT.toFixed(2);
            return preserveSeparator && separator === ',' ? maxString.replace('.', ',') : maxString;
        }

        if (!decimalPart && sanitized.endsWith(separator)) {
            return `${integerPart}${visibleSeparator}`;
        }

        return decimalPart ? `${integerPart}${visibleSeparator}${decimalPart}` : integerPart;
    }

    function parsePaymentNumericValue(value) {
        if (!value && value !== 0) return NaN;
        const normalized = String(value).replace(',', '.');
        const numeric = parseFloat(normalized);
        return Number.isFinite(numeric) ? numeric : NaN;
    }

    // Подписывает поле ввода на очистку, доводку формата и блокировку стрелок
    function initPaymentValueValidation(input) {
        if (!input || input.dataset.validationAttached === 'true') return;

        input.addEventListener('input', function () {
            const formatted = sanitizePaymentValue(input.value, { preserveSeparator: true });
            input.value = formatted;
            updateSubmitButtonState();
        });

        input.addEventListener('blur', function () {
            if (!input.value) return;

            let formatted = sanitizePaymentValue(input.value);
            if (formatted.startsWith('.')) {
                formatted = `0${formatted}`;
            }
            if (formatted.endsWith('.')) {
                formatted = formatted.slice(0, -1);
            }
            const numericValue = parsePaymentNumericValue(formatted);
            if (!numericValue || numericValue <= 0) {
                input.value = '';
                updateSubmitButtonState();
                return;
            }

            input.value = formatted;
            updateSubmitButtonState();
        });

        input.addEventListener('keydown', function (event) {
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
            }
        });

        input.dataset.validationAttached = 'true';
    }

    function isPaymentBlockValueValid(block) {
        if (!block || !block.paymentInput) return false;
        const numericValue = parsePaymentNumericValue(block.paymentInput.value);
        return Number.isFinite(numericValue) && numericValue > 0;
    }

    function allPaymentBlocksValid() {
        if (!paymentMethodBlocks.length) return false;
        return paymentMethodBlocks.every(block => isPaymentBlockValueValid(block));
    }

    function updateSubmitButtonState() {
        if (!paymentSubmitButton) return;
        const shouldShow = allPaymentBlocksValid();
        paymentSubmitButton.classList.toggle('d-none', !shouldShow);
        paymentSubmitButton.disabled = !shouldShow;
    }

    // === Работа со списком типов оплаты ===
    function getPaymentTypes() {
        return Array.isArray(window.PAYMENT_TYPES) ? window.PAYMENT_TYPES : [];
    }

    // Следим за кликом вне кастомных селектов, чтобы закрывать их
    function ensurePaymentSelectCloseListener() {
        if (paymentSelectCloseListenerAttached) return;
        document.addEventListener('click', function (event) {
            document.querySelectorAll('#paymentBookingModal .custom-select.open').forEach(select => {
                if (!select.contains(event.target)) {
                    select.classList.remove('open');
                }
            });
        });
        paymentSelectCloseListenerAttached = true;
    }

    // Текущие выбранные типы (нужно для исключения дубликатов)
    function getSelectedPaymentTypeIds(excludeBlockId = null) {
        return paymentMethodBlocks
            .filter(block => block.id !== excludeBlockId && block.selectedPaymentTypeId)
            .map(block => block.selectedPaymentTypeId);
    }

    function setBlockSelectedPaymentType(block, type) {
        if (!block || !type) return;
        block.selectedPaymentTypeId = String(type.id);
        if (block.selectedDisplay) {
            block.selectedDisplay.textContent = type.name;
        }
        if (block.selectElement) {
            block.selectElement.classList.remove('open');
        }
        refreshAllSelectOptions(block.id);
        updateAddButtonState();
        updateSubmitButtonState();
    }

    // Перестраивает список опций конкретного блока с учётом занятых типов
    function renderPaymentSelectOptions(block) {
        if (!block || !block.optionsContainer || !block.selectedDisplay) return;

        const paymentTypes = getPaymentTypes();
        const selectedIds = getSelectedPaymentTypeIds(block.id);
        const currentSelectedId = block.selectedPaymentTypeId;

        block.optionsContainer.innerHTML = '';

        if (!paymentTypes.length) {
            block.selectedDisplay.textContent = 'Нет доступных способов';
            block.selectElement?.classList.add('disabled');
            return;
        }

        const availableTypes = paymentTypes.filter(type => {
            const typeId = String(type.id);
            return typeId === currentSelectedId || !selectedIds.includes(typeId);
        });

        if (!availableTypes.length && !currentSelectedId) {
            block.selectedDisplay.textContent = 'Нет доступных способов';
            block.selectElement?.classList.add('disabled');
            return;
        }

        block.selectElement?.classList.remove('disabled');

        availableTypes.forEach(type => {
            const option = document.createElement('li');
            option.dataset.value = String(type.id);
            option.textContent = type.name;
            if (String(type.id) === currentSelectedId) {
                option.classList.add('selected');
            }
            option.addEventListener('click', (event) => {
                event.stopPropagation();
                setBlockSelectedPaymentType(block, type);
            });
            block.optionsContainer.appendChild(option);
        });

        if (currentSelectedId) {
            const currentType = paymentTypes.find(type => String(type.id) === currentSelectedId);
            block.selectedDisplay.textContent = currentType ? currentType.name : 'Выберите способ';
        } else {
            block.selectedDisplay.textContent = 'Выберите способ';
        }
    }

    // Синхронизирует все выпадающие списки при выборе/удалении типов
    function refreshAllSelectOptions(skipBlockId = null) {
        paymentMethodBlocks.forEach(block => {
            if (skipBlockId && block.id === skipBlockId) return;
            renderPaymentSelectOptions(block);
        });
    }

    // Актуализирует показ крестиков удаления: скрыт только на первом блоке
    function updateRemoveButtonsState() {
        paymentMethodBlocks.forEach((block, index) => {
            if (!block.removeButton) return;
            if (index === 0) {
                block.removeButton.classList.add('d-none');
            } else {
                block.removeButton.classList.remove('d-none');
            }
        });
    }

    // Можно ли добавить ещё блоков (ограничение = количество PaymentType)
    function canAddMorePaymentBlocks() {
        const paymentTypes = getPaymentTypes();
        return paymentTypes.length > 0 && paymentMethodBlocks.length < paymentTypes.length;
    }

    // Прячет/показывает кнопку "Добавить способ" в зависимости от лимита
    function updateAddButtonState() {
        if (!addPaymentMethodButton) return;
        const canAdd = canAddMorePaymentBlocks();
        const allBlocksHaveSelection = paymentMethodBlocks.length > 0 && paymentMethodBlocks.every(block => !!block.selectedPaymentTypeId);
        const shouldShowButton = canAdd && allBlocksHaveSelection;

        addPaymentMethodButton.classList.toggle('d-none', !shouldShowButton);
        addPaymentMethodButton.setAttribute('aria-disabled', shouldShowButton ? 'false' : 'true');
        if (!shouldShowButton) {
            addPaymentMethodButton.blur();
        }
    }

    // Удаление блока + перерасчёт доступных опций
    function removePaymentMethodBlock(blockId) {
        const blockIndex = paymentMethodBlocks.findIndex(block => block.id === blockId);
        if (blockIndex === -1) return;
        const [block] = paymentMethodBlocks.splice(blockIndex, 1);
        if (block?.element && block.element.parentNode) {
            block.element.parentNode.removeChild(block.element);
        }

        if (!paymentMethodBlocks.length) {
            addPaymentMethodBlock();
        } else {
            updateRemoveButtonsState();
            refreshAllSelectOptions();
        }

        updateAddButtonState();
        updateSubmitButtonState();
    }

    // Создание нового блока "способ + сумма" из template
    function createPaymentMethodBlock() {
        if (!paymentMethodsContainer || !paymentMethodTemplate) return null;
        const fragment = paymentMethodTemplate.content.cloneNode(true);
        const blockElement = fragment.querySelector('[data-payment-method-block]');
        if (!blockElement) return null;

        const selectElement = blockElement.querySelector('[data-payment-select]');
        const selectedDisplay = selectElement ? selectElement.querySelector('.selected') : null;
        const optionsContainer = selectElement ? selectElement.querySelector('.options') : null;
        const removeButton = blockElement.querySelector('[data-remove-block]');
        const paymentInput = blockElement.querySelector('[data-payment-value]');

        const blockId = `payment-method-${++paymentMethodBlockIdCounter}`;
        blockElement.dataset.paymentMethodBlockId = blockId;

        const blockData = {
            id: blockId,
            element: blockElement,
            selectElement,
            selectedDisplay,
            optionsContainer,
            removeButton,
            paymentInput,
            selectedPaymentTypeId: null,
        };

        if (removeButton) {
            removeButton.addEventListener('click', () => removePaymentMethodBlock(blockId));
        }

        if (selectElement) {
            selectElement.addEventListener('click', (event) => {
                event.stopPropagation();
                if (!selectElement.classList.contains('disabled')) {
                    selectElement.classList.toggle('open');
                }
            });
        }

        if (paymentInput) {
            initPaymentValueValidation(paymentInput);
        }

        paymentMethodsContainer.appendChild(blockElement);
        paymentMethodBlocks.push(blockData);
        renderPaymentSelectOptions(blockData);
        updateRemoveButtonsState();
        updateAddButtonState();
        updateSubmitButtonState();

        return blockData;
    }

    // Обработчик кнопки "Добавить способ"
    function addPaymentMethodBlock() {
        if (!canAddMorePaymentBlocks()) return;
        createPaymentMethodBlock();
    }

    function handleAddPaymentMethod(event) {
        if (event) {
            event.preventDefault();
        }
        addPaymentMethodBlock();
    }

    // Первичная инициализация блоков при открытии модалки
    function initializePaymentMethodsUI() {
        if (!paymentMethodsContainer) return;

        paymentMethodsContainer.innerHTML = '';
        paymentMethodBlocks = [];
        paymentMethodBlockIdCounter = 0;

        const paymentTypes = getPaymentTypes();

        if (!paymentTypes.length) {
            paymentMethodsContainer.innerHTML = '<div class="payment-methods-empty">Нет доступных способов оплаты</div>';
            if (addPaymentMethodButton) {
                addPaymentMethodButton.classList.add('d-none');
            }
            return;
        }

        const block = createPaymentMethodBlock();
        if (block) {
            block.element.classList.add('mb-4');
        }
        updateAddButtonState();
        updateSubmitButtonState();
    }

    function getConfirmCancelModalElement() {
        return document.getElementById('confirmCancelActionModal');
    }

    function setPaymentModalConfirmOverlay(active) {
        if (!paymentModalElement) return;
        paymentModalElement.classList.toggle('confirm-cancel-active', active);
    }

    function showConfirmCancelModal() {
        const confirmCancelModalElement = getConfirmCancelModalElement();
        if (!confirmCancelModalElement) return;
        attachConfirmModalListeners();
        setPaymentModalConfirmOverlay(true);
        const confirmModal = bootstrap.Modal.getOrCreateInstance(confirmCancelModalElement);
        confirmModal.show();
    }

    function hidePaymentModal() {
        if (!paymentModalElement) return;
        setPaymentModalConfirmOverlay(false);
        const paymentInstance = bootstrap.Modal.getInstance(paymentModalElement);
        if (paymentInstance) paymentInstance.hide();
    }

    function attachConfirmModalListeners() {
        const confirmCancelModalElement = getConfirmCancelModalElement();
        if (!confirmCancelModalElement || confirmCancelModalElement.dataset.confirmListenerAttached === 'true') return;

        confirmCancelModalElement.addEventListener('hidden.bs.modal', function () {
            if (!paymentModalForceClose) {
                setPaymentModalConfirmOverlay(false);
            }
        });

        confirmCancelModalElement.dataset.confirmListenerAttached = 'true';
    }

    // Закрытие модального окна оплаты и открытие модального окна информации по кнопке "назад"
    function switchToInfoFromPaymentModal() {
        showConfirmCancelModal();
    }

    // Позволяет сторонним сценариям (например, после успешной оплаты) закрыть модалку без подтверждения
    window.paymentModalAllowClose = function () {
        paymentModalForceClose = true;
    };

    document.addEventListener('booking:confirm-cancel-action', function () {
        paymentModalForceClose = true;
        const confirmCancelModalElement = getConfirmCancelModalElement();
        if (confirmCancelModalElement) {
            const confirmInstance = bootstrap.Modal.getInstance(confirmCancelModalElement);
            if (confirmInstance) confirmInstance.hide();
        }
        hidePaymentModal();
    });

    // Инициализация логики модалки оплаты
    function initPaymentModalScripts() {
        attachConfirmModalListeners();
        ensurePaymentSelectCloseListener();

        if (addPaymentMethodButton && addPaymentMethodButton.dataset.listenerAttached !== 'true') {
            addPaymentMethodButton.addEventListener('click', handleAddPaymentMethod);
            addPaymentMethodButton.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    handleAddPaymentMethod();
                }
            });
            addPaymentMethodButton.dataset.listenerAttached = 'true';
        }

        updateSubmitButtonState();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPaymentModalScripts);
    } else {
        initPaymentModalScripts();
    }

    if (paymentModalElement) {
        paymentModalElement.addEventListener('hide.bs.modal', function (event) {
            if (!paymentModalForceClose) {
                event.preventDefault();
                showConfirmCancelModal();
                return;
            }
            paymentModalForceClose = false;
        });

        paymentModalElement.addEventListener('hidden.bs.modal', function () {
            const infoModal = new bootstrap.Modal(document.getElementById('infoBookingModal'));
            infoModal.show();
        });

        paymentModalElement.addEventListener('shown.bs.modal', function () {
            initializePaymentMethodsUI();
        });
    }
</script>
{% load static %}
{% if user.is_authenticated %}
<div style="width: 100%; position: fixed; top: 0; z-index: 1000; background-color: #FFFFFF;">
    <div class="row mt-4">
        <div class="col-md-5" id="main-menu">
            <a href="/user">
                <svg width="156" height="32" viewBox="0 0 156 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M78.8769 8.96786V8.9642H90.1313V12.2465H82.4039V14.5673H89.3582V17.8496H82.4039V20.2721H90.2421V23.5544H78.9876V23.5419H78.391V8.96786H78.8769ZM149.939 18.0245V23.5544H145.974V18.0245L140.421 8.9642H144.927L147.957 14.307L150.986 8.9642H155.492L149.939 18.0245ZM121.218 19.5886H125.184V23.5544H121.218V19.5886ZM115.711 23.5544H119.941L113.749 8.9642H109.856L103.664 23.5544H107.894L108.975 20.7707H114.63L115.711 23.5544ZM110.042 18.0245L111.802 13.4946L113.563 18.0245H110.042ZM76.3971 14.0818C76.3747 16.3403 75.319 17.9881 73.6142 18.849L76.812 23.5544H72.2831L69.5474 19.5289H67.4629V23.5544H64.0466V23.5419H63.45V8.96786H63.9358V8.9642H70.5034C73.7204 8.9642 76.4309 10.6558 76.3971 14.0818ZM70.2374 16.2593C71.6789 16.2659 72.3616 15.1793 72.3506 14.0818C72.3395 12.9843 71.5529 12.2465 70.2228 12.2465H67.4629L67.4629 16.2466L70.2374 16.2593ZM104.677 14.0818C104.643 17.5078 102.231 19.5289 98.7829 19.5289H96.3698V23.5544H92.9535V23.5419H92.3569V8.96786H92.8428V8.9642H98.7829C102 8.9642 104.71 10.6558 104.677 14.0818ZM98.5169 16.2593C99.9584 16.2678 100.641 15.1793 100.63 14.0818C100.619 12.9843 99.8325 12.2465 98.5023 12.2465H96.3698L96.3698 16.2466L98.5169 16.2593ZM139.785 12.6441C139.805 14.5972 138.505 15.5964 137.468 15.9417C138.402 16.2137 140.432 16.9869 140.412 19.5306C140.392 22.0743 138.374 23.5544 134.963 23.5544H127.916V23.5419H127.319V8.96786H127.805V8.9642H134.963C138.355 8.9642 139.764 10.6909 139.785 12.6441ZM134.609 17.5816H131.332L131.332 20.2721H134.609C135.724 20.2721 136.381 19.6683 136.381 18.9269C136.381 18.1854 135.792 17.5816 134.609 17.5816ZM134.135 14.8354C135.236 14.8354 135.796 14.2429 135.796 13.541C135.796 12.8391 135.345 12.2465 134.135 12.2465H131.332L131.332 14.8354H134.135Z" fill="#363636"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.10718 1.10727V30.8927H50.7098L42.9525 23.1356L50.2224 15.8657L35.464 1.10727H1.10718Z" fill="#B69BC5"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0 0H21.1497L37.0154 15.8657L29.7456 23.1356L38.6101 32H0V0ZM1.10727 1.10727V30.8927H35.9369L28.1796 23.1356L35.4495 15.8657L20.6911 1.10727H1.10727Z" fill="#CCFF00"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.10718 1.10727V30.8927H35.9368L28.1795 23.1356L35.4494 15.8657L20.691 1.10727H1.10718Z" fill="#CCFF00"/>
                    </svg>
            </a>
            <span>Клиенты</span>
            <span>Сотрудники</span>
            <span style="display: flex; justify-content: center; align-items: center; gap: 8px;">
                <span>Заявки</span>
                <span id="alert-count">{{ pending_requests_count|default:"0" }}</span>
            </span>
            <span>Статистика</span>
            <span>Настройки</span>
        </div>

        <div class="col-md-5"></div>
        <div class="col-md-2" style="display: flex; align-items: right; justify-content: center;">
            <!-- Колокольчик с точкой -->
            <div class="notification-icon" style="position: relative; display: inline-block; margin-right: 40px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 8C6 6.4087 6.63214 4.88258 7.75736 3.75736C8.88258 2.63214 10.4087 2 12 2C13.5913 2 15.1174 2.63214 16.2426 3.75736C17.3679 4.88258 18 6.4087 18 8C18 15 21 17 21 17H3C3 17 6 15 6 8Z" stroke="#4F4F57" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10.3 21C10.4674 21.3044 10.7135 21.5583 11.0125 21.7352C11.3116 21.912 11.6526 22.0053 12 22.0053C12.3475 22.0053 12.6885 21.912 12.9876 21.7352C13.2866 21.5583 13.5327 21.3044 13.7 21" stroke="#4F4F57" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span id="ring-dot"></span>
            </div>
            {% if app_version %}
            <span class="app-version-label">v{{ app_version }}</span>
            {% endif %}

            <div class="user-menu-container">
                <button type="button" id="main-menu-name" class="user-menu-trigger" aria-haspopup="dialog" aria-controls="userProfilePopup" aria-expanded="false">
                    <img class="user-menu-trigger__avatar" src="{% static 'image/image.png' %}" alt="Профиль" width="32" height="32">
                    <span class="user-menu-trigger__name">{{ user.get_full_name|default:user.username }}</span>
                </button>

                <div class="user-profile-popup" id="userProfilePopup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="userProfilePopupName">
                    <div class="user-profile-popup__dialog" data-user-profile-popup-dialog>
                        <img class="user-profile-popup__avatar" src="{% static 'image/image.png' %}" alt="Профиль" width="160" height="160">
                        <div class="user-profile-popup__name" id="userProfilePopupName">{{ user.get_full_name|default:user.username }}</div>
                        <div class="user-profile-popup__role">
                            {% with user.groups.all|first as grp %}
                            {% if grp %}
                            {{ grp.name }}
                            {% elif user.is_superuser %}
                            Администратор
                            {% elif user.is_staff %}
                            Сотрудник
                            {% else %}
                            Пользователь
                            {% endif %}
                            {% endwith %}
                        </div>
                        <a class="user-profile-popup__logout" href="{% url 'logout' %}">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H9" stroke="#7A52FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M16 17L21 12L16 7" stroke="#7A52FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M21 12H9" stroke="#7A52FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span>Выйти</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3" style="border-bottom: 1px solid #EBEBEC;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var trigger = document.getElementById('main-menu-name');
            var popup = document.getElementById('userProfilePopup');
            if (!trigger || !popup) {
                return;
            }

            var dialog = popup.querySelector('[data-user-profile-popup-dialog]');
            var isOpen = false;

            function onDocumentClick(e) {
                if (trigger.contains(e.target)) {
                    return;
                }
                if (popup.contains(e.target)) {
                    return;
                }
                closePopup();
            }

            function openPopup() {
                popup.classList.add('is-open');
                popup.setAttribute('aria-hidden', 'false');
                trigger.setAttribute('aria-expanded', 'true');
                if (!isOpen) {
                    document.addEventListener('click', onDocumentClick);
                    isOpen = true;
                }
            }

            function closePopup() {
                popup.classList.remove('is-open');
                popup.setAttribute('aria-hidden', 'true');
                trigger.setAttribute('aria-expanded', 'false');
                if (isOpen) {
                    document.removeEventListener('click', onDocumentClick);
                    isOpen = false;
                }
            }

            trigger.addEventListener('click', function (e) {
                if (e && e.stopPropagation) {
                    e.stopPropagation();
                }
                if (popup.classList.contains('is-open')) {
                    closePopup();
                } else {
                    openPopup();
                }
            });

            document.addEventListener('keydown', function (e) {
                if (!popup.classList.contains('is-open')) {
                    return;
                }
                if (e.key === 'Escape') {
                    closePopup();
                }
            });
        });
    </script>
</div>
{% endif %}
